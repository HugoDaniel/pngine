---
.title = "JavaScript API",
.description = "Browser runtime API reference",
.author = "PNGine Team",
.date = @date("2024-12-30"),
.layout = "docs.shtml",
---

PNGine uses a functional API for browser runtime. All functions are tree-shakeable ESM exports.

## Installation

```bash
npm install pngine
```

```javascript
import { pngine, play, pause, stop, draw, seek, destroy } from 'pngine';
```

## Initialization

### pngine(source, options)

Initialize PNGine from various sources. Returns a Promise that resolves to a Pngine instance.

```javascript
const p = await pngine(source, options);
```

**Parameters:**

| Parameter | Type | Description |
|-----------|------|-------------|
| `source` | string \| HTMLImageElement \| ArrayBuffer \| Uint8Array \| Blob | Source of bytecode |
| `options` | object | Configuration options |

**Source types:**

```javascript
// URL to PNG file (requires canvas option)
await pngine('shader.png', { canvas });

// CSS selector for image element
await pngine('#shader-img');

// Direct element reference
await pngine(document.getElementById('shader-img'));

// Raw bytecode (requires canvas option)
await pngine(uint8Array, { canvas });

// Blob (requires canvas option)
await pngine(blob, { canvas });
```

**Options:**

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `canvas` | HTMLCanvasElement | - | Target canvas (required for URL/data sources) |
| `debug` | boolean | `false` | Enable debug logging |
| `wasmUrl` | string | auto | Custom WASM runtime URL |
| `onError` | function | - | Error callback |

**Example:**

```javascript
const p = await pngine('shader.png', {
  canvas: document.getElementById('canvas'),
  debug: true,
  onError: (err) => console.error('PNGine error:', err)
});
```

### Image Element Initialization

When passing an image element or selector, PNGine automatically:
1. Creates a canvas sized to the image
2. Positions it over the image
3. Extracts bytecode from the image's PNG

```javascript
// CSS selector
const p = await pngine('#shader');

// Direct element
const img = document.querySelector('img.pngine');
const p = await pngine(img);
```

## Playback Control

### play(p)

Start the animation loop. Calls `requestAnimationFrame` internally.

```javascript
play(p);
```

Returns the Pngine instance for chaining.

### pause(p)

Pause animation. Preserves current time position.

```javascript
pause(p);
```

### stop(p)

Stop animation and reset time to 0.

```javascript
stop(p);
```

### seek(p, time)

Jump to specific time position.

```javascript
seek(p, 2.5);  // Jump to 2.5 seconds
```

### draw(p, options)

Render a single frame manually.

```javascript
draw(p);                        // Render at current time
draw(p, { time: 1.5 });         // Render at specific time
draw(p, { frame: 'intro' });    // Render specific frame
draw(p, { uniforms: { brightness: 0.8 } });  // With uniform overrides
```

**Options:**

| Option | Type | Description |
|--------|------|-------------|
| `time` | number | Time in seconds |
| `frame` | string | Specific frame name (bypasses animation timeline) |
| `uniforms` | object | Uniform values to override |

### destroy(p)

Cleanup resources and terminate the WebWorker.

```javascript
destroy(p);
```

Always call this when removing a PNGine instance to prevent memory leaks.

## Properties

The Pngine instance exposes read-only properties:

```javascript
p.width        // Canvas width in pixels
p.height       // Canvas height in pixels
p.time         // Current time in seconds
p.isPlaying    // true if animation is running
p.duration     // Total animation duration (seconds), or 0
p.frameCount   // Number of #frame definitions
p.animation    // Animation metadata (if defined)
p.currentScene // Current scene object (if using animation)
p.currentFrame // Current frame name
```

## Uniform Control

### setUniform(p, name, value, redraw)

Set a single uniform value.

```javascript
setUniform(p, 'brightness', 0.5);
setUniform(p, 'color', [1.0, 0.5, 0.0]);

// Without immediate redraw
setUniform(p, 'brightness', 0.5, false);
```

**Parameters:**

| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `p` | Pngine | - | Pngine instance |
| `name` | string | - | Uniform field name (as in WGSL struct) |
| `value` | number \| number[] | - | Value to set |
| `redraw` | boolean | `true` | Trigger immediate redraw |

### setUniforms(p, uniforms, redraw)

Set multiple uniforms at once.

```javascript
setUniforms(p, {
  brightness: 0.8,
  contrast: 1.2,
  color: [1.0, 0.5, 0.0]
});
```

### getUniforms(p)

Get available uniform metadata. Returns a Promise.

```javascript
const uniforms = await getUniforms(p);
console.log(uniforms);
// {
//   time: { type: 'f32', size: 4, bufferId: 0, offset: 0 },
//   brightness: { type: 'f32', size: 4, bufferId: 0, offset: 4 },
//   ...
// }
```

## Animation Timeline

If your shader defines `#animation`, playback automatically follows the timeline:

```
#animation demo {
  duration=30.0
  scenes=[
    { id="intro" frame=introFrame start=0.0 end=10.0 }
    { id="main" frame=mainFrame start=10.0 end=25.0 }
    { id="outro" frame=outroFrame start=25.0 end=30.0 }
  ]
  endBehavior=loop
}
```

**End behaviors:**
- `loop` / `restart` - Loop from beginning
- `stop` - Stop at last frame
- `hold` - Hold last frame (default)

Access animation info:

```javascript
p.animation.duration    // Total duration in ms
p.animation.scenes      // Array of scene objects
p.animation.endBehavior // End behavior string

p.currentScene          // Current scene object
p.currentScene.id       // Scene ID
p.currentScene.frame    // Frame name
```

## Frame Selection

### setFrame(p, frame)

Manually set which frame to render, bypassing animation timeline.

```javascript
setFrame(p, 'introFrame');   // Render specific frame
setFrame(p, null);           // Return to timeline control
```

## Complete Example

```javascript
import {
  pngine,
  play,
  pause,
  stop,
  seek,
  draw,
  destroy,
  setUniform,
  getUniforms
} from 'pngine';

async function main() {
  // Initialize
  const p = await pngine('demo.png', {
    canvas: document.getElementById('canvas'),
    debug: true
  });

  // Start animation
  play(p);

  // UI controls
  document.getElementById('play').onclick = () => play(p);
  document.getElementById('pause').onclick = () => pause(p);
  document.getElementById('stop').onclick = () => stop(p);

  // Seek slider
  document.getElementById('seek').oninput = (e) => {
    seek(p, parseFloat(e.target.value));
  };

  // Uniform control
  document.getElementById('brightness').oninput = (e) => {
    setUniform(p, 'brightness', parseFloat(e.target.value));
  };

  // Log available uniforms
  const uniforms = await getUniforms(p);
  console.log('Available uniforms:', Object.keys(uniforms));

  // Cleanup on page unload
  window.addEventListener('beforeunload', () => destroy(p));
}

main();
```

## Resize Handling

PNGine automatically uses the canvas dimensions. To handle resize:

```javascript
function handleResize() {
  const dpr = window.devicePixelRatio || 1;
  canvas.width = canvas.clientWidth * dpr;
  canvas.height = canvas.clientHeight * dpr;

  // Redraw at new size
  draw(p);
}

window.addEventListener('resize', handleResize);
```

## Error Handling

```javascript
try {
  const p = await pngine('shader.png', { canvas });
} catch (error) {
  if (error.message.includes('WebGPU')) {
    console.error('WebGPU not supported in this browser');
  } else if (error.message.includes('bytecode')) {
    console.error('PNG does not contain PNGine bytecode');
  } else {
    console.error('Failed to initialize:', error);
  }
}

// Runtime errors via callback
const p = await pngine('shader.png', {
  canvas,
  onError: (err) => {
    console.error('Runtime error:', err);
  }
});
```

## Advanced: Embedded Executor

For PNGs with embedded executor (self-contained), additional exports are available:

```javascript
import {
  parsePayload,
  createExecutor,
  getExecutorImports,
  getExecutorVariantName
} from 'pngine';

// Parse payload to extract executor and bytecode
const { executor, bytecode, plugins } = parsePayload(pngbBytes);

// Get executor variant name
const variant = getExecutorVariantName(plugins);
console.log('Executor variant:', variant);  // e.g., "render_compute"

// Create executor instance
const wasmInstance = await createExecutor(executor, imports);
```

## Module Exports

```javascript
// Core functions
export { pngine, destroy } from "./init.js";

// Playback control
export {
  draw,
  play,
  pause,
  stop,
  seek,
  setFrame,
  setUniform,
  setUniforms,
  getUniforms
} from "./anim.js";

// Utilities
export {
  extractBytecode,
  detectFormat,
  isPng,
  isZip,
  isPngb
} from "./extract.js";

// Advanced (embedded executor)
export {
  parsePayload,
  createExecutor,
  getExecutorImports,
  getExecutorVariantName
} from "./loader.js";
```

## Related

- [Getting Started](/docs/getting-started/) - Quick start guide
- [`#frame`](/docs/dsl/frame/) - Frame definitions
- [`#animation`](/docs/dsl/animation/) - Animation timeline
- [CLI Reference](/docs/cli/) - Compile and embed bytecode
