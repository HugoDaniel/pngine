---
.title = "PBSF Syntax",
.description = "PNGine Bytecode Source Format reference",
.author = "PNGine Team",
.date = @date("2024-12-15"),
.layout = "page.shtml",
---

PBSF (PNGine Bytecode Source Format) is a Lisp-like S-expression language for defining WebGPU programs.

## Basic Structure

Every PBSF file starts with a module declaration:

```lisp
(module "name"
  ; declarations and instructions
)
```

## Comments

Single-line comments start with `;`:

```lisp
; This is a comment
(nop) ; inline comment
```

## Register References

Registers are referenced with a type prefix and index:

| Prefix | Type | Example |
|--------|------|---------|
| `$d:` | Data | `$d:0` |
| `$shd:` | Shader | `$shd:0` |
| `$pipe:` | Pipeline | `$pipe:0` |
| `$frm:` | Frame | `$frm:0` |

## Instructions

### No Operation

```lisp
(nop)
```

### Data Declaration

Embed string or binary data:

```lisp
(data $d:0 "shader source code here")
```

### Shader Declaration

Create a shader from data:

```lisp
(shader $shd:0 (code $d:0))
```

### Render Pipeline

Create a render pipeline with a shader:

```lisp
(render-pipeline $pipe:0 (shader $shd:0))
```

### Frame Definition

Define a render frame with a sequence of commands:

```lisp
(frame $frm:0 "frame-name"
  (set-pipeline $pipe:0)
  (draw 3 1)
  (submit))
```

### Frame Commands

| Command | Parameters | Description |
|---------|------------|-------------|
| `set-pipeline` | pipeline-ref | Bind a render pipeline |
| `draw` | vertex-count, instance-count | Draw vertices |
| `submit` | (none) | Submit the command buffer |

## Complete Example

```lisp
(module "spinning-cube"
  ; Vertex shader
  (data $d:0 "
    @vertex fn vs(@builtin(vertex_index) i: u32) -> @builtin(position) vec4f {
      var pos = array<vec2f, 3>(
        vec2f( 0.0,  0.5),
        vec2f(-0.5, -0.5),
        vec2f( 0.5, -0.5)
      );
      return vec4f(pos[i], 0.0, 1.0);
    }
  ")

  ; Fragment shader
  (data $d:1 "
    @fragment fn fs() -> @location(0) vec4f {
      return vec4f(1.0, 0.5, 0.0, 1.0);
    }
  ")

  ; Create shader modules
  (shader $shd:0 (code $d:0))
  (shader $shd:1 (code $d:1))

  ; Create pipeline
  (render-pipeline $pipe:0 (shader $shd:0))

  ; Main render frame
  (frame $frm:0 "main"
    (set-pipeline $pipe:0)
    (draw 3 1)
    (submit)))
```
