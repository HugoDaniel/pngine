---
.title = "Bytecode Format",
.description = "PNGB binary specification",
.author = "PNGine Team",
.date = @date("2024-12-15"),
.layout = "page.shtml",
---

PNGB (PNGine Binary) is the compiled bytecode format that PNGine executes.

## File Structure

```
+----------------+
| Header (12B)   |
+----------------+
| Instructions   |
+----------------+
| Data Section   |
+----------------+
```

## Header

| Offset | Size | Field | Description |
|--------|------|-------|-------------|
| 0 | 4 | Magic | `PNGB` (0x50 0x4E 0x47 0x42) |
| 4 | 2 | Version | Format version (currently 1) |
| 6 | 2 | Flags | Reserved |
| 8 | 4 | Code Size | Size of instruction section |

## Instructions

Instructions use a fixed-width encoding for fast decoding:

| Bits | Field |
|------|-------|
| 0-7 | Opcode |
| 8-15 | Flags |
| 16-31 | Operand |

### Opcodes

| Code | Name | Description |
|------|------|-------------|
| 0x00 | NOP | No operation |
| 0x01 | DATA | Define data block |
| 0x02 | SHADER | Create shader module |
| 0x03 | PIPELINE | Create render pipeline |
| 0x10 | FRAME | Begin frame definition |
| 0x11 | FRAME_END | End frame definition |
| 0x20 | SET_PIPELINE | Bind pipeline |
| 0x21 | DRAW | Draw primitives |
| 0x22 | SUBMIT | Submit commands |

## Data Section

Variable-length data (shader source, names) stored at the end of the file. Instructions reference data by offset from the start of the data section.

## Example Binary

For this PBSF source:

```lisp
(module "test"
  (nop))
```

The compiled PNGB:

```
50 4E 47 42  ; Magic: "PNGB"
01 00        ; Version: 1
00 00        ; Flags: 0
04 00 00 00  ; Code size: 4 bytes
00 00 00 00  ; NOP instruction
```

## Compression

PNGB typically achieves 2-3x compression compared to PBSF source:

| Source | Compiled | Ratio |
|--------|----------|-------|
| 100B | 40B | 2.5x |
| 1KB | 400B | 2.5x |
| 10KB | 3.5KB | 2.8x |

The compression comes from:
- Binary opcodes vs text keywords
- Compact integer encoding
- Removed whitespace and comments
