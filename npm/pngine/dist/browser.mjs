var B='function Q(u,g){let o=null,y=0,l=0,U=0,x=null,P=null,O=!1,h=[],b=[],L=[],W=[],B=[],I=[],H=[],$=[],tt=[],j=[],Z=[],et=[],_=[],rt=[],nt=[];function M(r,e){return new TextDecoder().decode(new Uint8Array(o.buffer,r,e))}function ft(r){let e=0;return r&1&&(e|=GPUBufferUsage.MAP_READ),r&2&&(e|=GPUBufferUsage.MAP_WRITE),r&4&&(e|=GPUBufferUsage.COPY_SRC),r&8&&(e|=GPUBufferUsage.COPY_DST),r&16&&(e|=GPUBufferUsage.INDEX),r&32&&(e|=GPUBufferUsage.VERTEX),r&64&&(e|=GPUBufferUsage.UNIFORM),r&128&&(e|=GPUBufferUsage.STORAGE),e||GPUBufferUsage.COPY_DST}function gt(r){return{0:"rgba8unorm",1:"rgba8snorm",4:"bgra8unorm",5:"rgba16float",6:"rgba32float",16:"depth24plus",17:"depth24plus-stencil8",18:"depth32float"}[r]||navigator.gpu.getPreferredCanvasFormat()}function lt(r){let e=0;return r&1&&(e|=GPUTextureUsage.COPY_SRC),r&2&&(e|=GPUTextureUsage.COPY_DST),r&4&&(e|=GPUTextureUsage.TEXTURE_BINDING),r&8&&(e|=GPUTextureUsage.STORAGE_BINDING),r&16&&(e|=GPUTextureUsage.RENDER_ATTACHMENT),e||GPUTextureUsage.RENDER_ATTACHMENT}function Ut(r,e,t){h[r]||(O&&console.log(`[GPU] createBuffer(${r}, ${e}, 0x${t.toString(16)})`),h[r]=u.createBuffer({size:e,usage:ft(t)}))}function dt(r,e,t){if(B[r])return;let n=M(e,t);O&&console.log(`[GPU] createShader(${r}, ${t}b)`),B[r]=u.createShaderModule({code:n})}function xt(r,e,t){if(I[r])return;let n=JSON.parse(M(e,t)),a=navigator.gpu.getPreferredCanvasFormat();O&&console.log(`[GPU] createRenderPipeline(${r})`);let c=u.createRenderPipeline({layout:"auto",vertex:{module:B[n.vertex?.shader??0],entryPoint:n.vertex?.entryPoint??"vs_main",buffers:n.vertex?.buffers??[]},fragment:{module:B[n.fragment?.shader??n.vertex?.shader??0],entryPoint:n.fragment?.entryPoint??"fs_main",targets:[{format:a}]},primitive:n.primitive??{topology:"triangle-list"},depthStencil:n.depthStencil});I[r]=c,$[r]=c.getBindGroupLayout(0)}function mt(r,e,t){if(I[r])return;let n=JSON.parse(M(e,t)),a=u.createComputePipeline({layout:"auto",compute:{module:B[n.compute?.shader??0],entryPoint:n.compute?.entryPoint??"main"}});I[r]=a,$[r]=a.getBindGroupLayout(0)}function yt(r,e,t){if(b[r])return;let n=new Uint8Array(o.buffer,e,t),a=new DataView(n.buffer,n.byteOffset,n.byteLength),c=2,i={size:[l||512,U||512],format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:1},f=n[1];for(let s=0;s<f;s++){let E=n[c++],m=n[c++];if(m===0){let T=a.getUint32(c,!0);c+=4,E===1?i.size[0]=T:E===2?i.size[1]=T:E===5&&(i.sampleCount=T)}else if(m===7){let T=n[c++];E===7?i.format=gt(T):E===8&&(i.usage=lt(T))}}nt[r]={format:i.format,usage:i.usage},b[r]=u.createTexture(i)}function ht(r,e,t){if(W[r])return;let n=new Uint8Array(o.buffer,e,t),a=2,c={magFilter:"linear",minFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},i=n[1];for(let f=0;f<i;f++){let s=n[a++];if(n[a++]===7){let m=n[a++];s===4?c.magFilter=m===0?"nearest":"linear":s===5?c.minFilter=m===0?"nearest":"linear":s===1?c.addressModeU=["clamp-to-edge","repeat","mirror-repeat"][m]:s===2&&(c.addressModeV=["clamp-to-edge","repeat","mirror-repeat"][m])}}W[r]=u.createSampler(c)}function bt(r,e,t,n){if(H[r])return;let a=new Uint8Array(o.buffer,t,n),c=new DataView(a.buffer,a.byteOffset,a.byteLength),i=2,f=0,s=[],E=a[1];for(let d=0;d<E;d++){let D=a[i++],X=a[i++];if(D===1&&X===7)f=a[i++];else if(D===2&&X===3){let V=a[i++];for(let Y=0;Y<V;Y++){let Gt=a[i++],at=a[i++],Ct=c.getUint16(i,!0);i+=2;let K={binding:Gt,rt:at,rid:Ct};at===0&&(K.offset=c.getUint32(i,!0),i+=4,K.size=c.getUint32(i,!0),i+=4),s.push(K)}}}rt[r]={layoutId:e,gi:f,entries:s};let m=I[e];if(!m)return;let T=s.map(d=>{let D={binding:d.binding};return d.rt===0?(D.resource={buffer:h[d.rid]},d.offset&&(D.resource.offset=d.offset),d.size&&(D.resource.size=d.size)):d.rt===1?D.resource=b[d.rid]?.createView():d.rt===2&&(D.resource=W[d.rid]),D});H[r]=u.createBindGroup({layout:m.getBindGroupLayout(f),entries:T})}function Et(r,e,t,n){x||(x=u.createCommandEncoder());let i={colorAttachments:[{view:r===65534?g.getCurrentTexture().createView():b[r]?.createView(),loadOp:e===1?"clear":"load",storeOp:t===0?"store":"discard",clearValue:{r:0,g:0,b:0,a:1}}]};n!==65535&&b[n]&&(i.depthStencilAttachment={view:b[n].createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}),P=x.beginRenderPass(i)}function Pt(){x||(x=u.createCommandEncoder()),P=x.beginComputePass()}function At(r,e,t){switch(r){case 1:return Ut(e.getUint16(t,!0),e.getUint32(t+2,!0),e.getUint8(t+6)),t+7;case 2:return yt(e.getUint16(t,!0),e.getUint32(t+2,!0),e.getUint32(t+6,!0)),t+10;case 3:return ht(e.getUint16(t,!0),e.getUint32(t+2,!0),e.getUint32(t+6,!0)),t+10;case 4:return dt(e.getUint16(t,!0),e.getUint32(t+2,!0),e.getUint32(t+6,!0)),t+10;case 5:return xt(e.getUint16(t,!0),e.getUint32(t+2,!0),e.getUint32(t+6,!0)),t+10;case 6:return mt(e.getUint16(t,!0),e.getUint32(t+2,!0),e.getUint32(t+6,!0)),t+10;case 7:return bt(e.getUint16(t,!0),e.getUint16(t+2,!0),e.getUint32(t+4,!0),e.getUint32(t+8,!0)),t+12;case 16:return Et(e.getUint16(t,!0),e.getUint8(t+2),e.getUint8(t+3),e.getUint16(t+4,!0)),t+6;case 17:return Pt(),t;case 18:return P?.setPipeline(I[e.getUint16(t,!0)]),t+2;case 19:return P?.setBindGroup(e.getUint8(t),H[e.getUint16(t+1,!0)]),t+3;case 20:return P?.setVertexBuffer(e.getUint8(t),h[e.getUint16(t+1,!0)]),t+3;case 21:return P?.draw(e.getUint32(t,!0),e.getUint32(t+4,!0),e.getUint32(t+8,!0),e.getUint32(t+12,!0)),t+16;case 22:return P?.drawIndexed(e.getUint32(t,!0),e.getUint32(t+4,!0),e.getUint32(t+8,!0),e.getInt32(t+12,!0),e.getUint32(t+16,!0)),t+20;case 23:return P?.end(),P=null,t;case 24:return P?.dispatchWorkgroups(e.getUint32(t,!0),e.getUint32(t+4,!0),e.getUint32(t+8,!0)),t+12;case 25:return P?.setIndexBuffer(h[e.getUint16(t,!0)],e.getUint8(t+2)===1?"uint32":"uint16"),t+3;case 32:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint32(t+6,!0),i=e.getUint32(t+10,!0);return h[n]&&u.queue.writeBuffer(h[n],a,new Uint8Array(o.buffer,c,i)),t+14}case 33:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint16(t+6,!0);if(h[n]){let i=new Float32Array([y,l,U,l/(U||1)]);u.queue.writeBuffer(h[n],a,new Uint8Array(i.buffer,0,Math.min(c,16)))}return t+8}case 8:{let n=e.getUint16(t,!0),a=e.getUint16(t+2,!0);return!L[n]&&b[a]&&(L[n]=b[a].createView()),t+12}case 9:return t+10;case 10:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint32(t+6,!0);return $[n]||($[n]=u.createBindGroupLayout(JSON.parse(M(a,c)))),t+10}case 11:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint32(t+6,!0),i=new Blob([new Uint8Array(o.buffer,a,c)]);return createImageBitmap(i).then(f=>(j[n]=f,t+10))}case 12:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint32(t+6,!0),i=JSON.parse(M(a,c));return tt[n]=u.createPipelineLayout({bindGroupLayouts:i.bindGroupLayouts.map(f=>$[f])}),t+10}case 13:return t+10;case 26:{let n=e.getUint8(t);return t+1+n*2}case 34:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint16(t+6,!0),i=e.getUint32(t+8,!0),f=e.getUint32(t+12,!0);return x||(x=u.createCommandEncoder()),x.copyBufferToBuffer(h[n],a,h[c],i,f),t+16}case 35:{let n=e.getUint16(t,!0),a=e.getUint16(t+2,!0),c=e.getUint16(t+4,!0),i=e.getUint16(t+6,!0);return x||(x=u.createCommandEncoder()),x.copyTextureToTexture({texture:b[n]},{texture:b[a]},[c,i]),t+8}case 36:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint32(t+6,!0),i=e.getUint32(t+10,!0);return h[n]&&u.queue.writeBuffer(h[n],a,new Uint8Array(o.buffer,c,i)),t+14}case 37:{let n=e.getUint16(t,!0),a=e.getUint16(t+2,!0),c=e.getUint8(t+4),i=e.getUint16(t+5,!0),f=e.getUint16(t+7,!0),s=j[n];return s&&b[a]&&u.queue.copyExternalImageToTexture({source:s},{texture:b[a],mipLevel:c,origin:[i,f]},[s.width,s.height]),t+9}case 48:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint32(t+6,!0),i=new Uint8Array(o.buffer,a,c).slice();return WebAssembly.compile(i).then(f=>WebAssembly.instantiate(f,{}).then(s=>(Z[n]=s,t+10)))}case 49:{let n=e.getUint16(t,!0),a=e.getUint16(t+2,!0),c=e.getUint32(t+4,!0),i=e.getUint32(t+8,!0),f=e.getUint8(t+12),s=new Uint8Array(o.buffer,t+13,f).slice(),E=M(c,i),T=Z[a]?.exports[E],d=[],D=new DataView(s.buffer,s.byteOffset,s.byteLength);for(let X=0,V=0;X<f/5|0;X++){let Y=s[V++];Y===0?d.push(D.getFloat32(V,!0)):Y===1?d.push(D.getInt32(V,!0)):Y===2&&d.push(D.getUint32(V,!0)),V+=4}return T&&(et[n]=T(...d)),t+13+f}case 64:{let n=e.getUint16(t,!0),a=e.getUint8(t+2),c=e.getUint32(t+3,!0),i=[Float32Array,Int32Array,Uint32Array,Uint8Array][a]||Float32Array;return _[n]=new i(c),t+7}case 65:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint32(t+6,!0),i=e.getUint8(t+10),f=e.getUint32(t+11,!0),s=_[n],E=new Float32Array(o.buffer,f,c);if(s)for(let m=0;m<c;m++)s[a+m*i]=E[m];return t+15}case 66:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint32(t+6,!0),i=e.getUint8(t+10),f=e.getUint32(t+11,!0),s=e.getUint16(t+15,!0),E=M(f,s),m=_[n];if(m){let T=new DataView(new Uint8Array(o.buffer,f,s).slice().buffer);for(let d=0;d<c;d++)m[a+d*i]=R(T,0,d,y,l,U)}return t+17}case 67:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint32(t+6,!0),i=e.getUint8(t+10),f=e.getUint32(t+11,!0),s=new DataView(o.buffer).getFloat32(f,!0),E=_[n];if(E)for(let m=0;m<c;m++)E[a+m*i]=s;return t+15}case 68:{let n=e.getUint16(t,!0),a=e.getUint32(t+2,!0),c=e.getUint16(t+6,!0);return h[n]&&_[c]&&u.queue.writeBuffer(h[n],a,_[c]),t+8}case 240:return x&&(u.queue.submit([x.finish()]),x=null),t;case 255:return t;default:return console.warn(`Unknown cmd: 0x${r.toString(16)}`),t}}function R(r,e,t,n,a,c){switch(r.getUint8(e)){case 0:return r.getFloat32(e+1,!0);case 1:return a;case 2:return c;case 3:return n;case 4:return r.getInt32(e+1,!0);case 5:return r.getUint32(e+1,!0);case 16:return R(r,e+1,t,n,a,c)+R(r,e+1+N(r,e+1),t,n,a,c);case 17:return R(r,e+1,t,n,a,c)-R(r,e+1+N(r,e+1),t,n,a,c);case 18:return R(r,e+1,t,n,a,c)*R(r,e+1+N(r,e+1),t,n,a,c);case 19:{let f=R(r,e+1+N(r,e+1),t,n,a,c);return f?R(r,e+1,t,n,a,c)/f:0}case 32:return Math.sin(R(r,e+1,t,n,a,c));case 33:return Math.cos(R(r,e+1,t,n,a,c));case 48:return t;default:return 0}}function N(r,e){let t=r.getUint8(e);return t<=5?5:t>=16&&t<=19?1+N(r,e+1)+N(r,e+1+N(r,e+1)):t>=32&&t<=33?1+N(r,e+1):1}async function Tt(r){let e=new DataView(o.buffer),t=e.getUint32(r,!0),n=e.getUint16(r+4,!0);O&&console.log(`[GPU] Execute: ${n} cmds, ${t}b`);let a=r+8,c=r+t;for(let i=0;i<n&&a<c;i++){let f=e.getUint8(a++),s=At(f,e,a);s instanceof Promise?(a=await s,e=new DataView(o.buffer)):a=s}}function Dt(){h.forEach(r=>r?.destroy?.()),b.forEach(r=>r?.destroy?.()),h.length=b.length=L.length=W.length=B.length=I.length=0,H.length=$.length=tt.length=j.length=Z.length=0,et.length=_.length=rt.length=nt.length=0}return{setDebug(r){O=r},setMemory(r){o=r},setTime(r){y=r},setCanvasSize(r,e){l=r,U=e},execute:Tt,destroy:Dt}}var Bt=[80,78,71,66],ut=0,ct=40,Rt=1,It=2,Ot=1,Lt=2,Nt=4,St=8,_t=16,Mt=32;function it(u){if(u.length<ct)throw new Error("Invalid PNGB: too short");if(!Bt.every((y,l)=>u[l]===y))throw new Error("Invalid PNGB: bad magic");let g=new DataView(u.buffer,u.byteOffset,u.byteLength),o=g.getUint16(4,!0);if(o!==ut)throw new Error(`Unsupported PNGB version: ${o}`);return Vt(u,g)}function Vt(u,g){let o=g.getUint16(6,!0),y=u[8],l=g.getUint32(12,!0),U=g.getUint32(16,!0),x=g.getUint32(20,!0),P=g.getUint32(24,!0),O=g.getUint32(28,!0),h=g.getUint32(32,!0),b=g.getUint32(36,!0),L=(o&Rt)!==0,W=(o&It)!==0,B=L?l+U:ct,I=x-B;return{version:ut,hasEmbeddedExecutor:L,hasAnimationTable:W,plugins:Ft(y),executor:L?u.subarray(l,l+U):null,bytecode:u.subarray(B,B+I),payload:u,offsets:{executor:L?l:0,executorLength:U,bytecode:B,bytecodeLength:I,stringTable:x,data:P,wgsl:O,uniform:h,animation:b}}}function Ft(u){return{core:(u&Ot)!==0,render:(u&Lt)!==0,compute:(u&Nt)!==0,wasm:(u&St)!==0,animation:(u&_t)!==0,texture:(u&Mt)!==0}}function ot(u={}){return{env:{log:u.log||((g,o)=>{}),wasmInstantiate:u.wasmInstantiate||((g,o,y)=>{}),wasmCall:u.wasmCall||((g,o,y,l,U,x)=>{}),wasmGetResult:u.wasmGetResult||((g,o,y)=>0)}}}var G,z,J,A,C,S,q=!1,k=!1,v=0,w=!1,F={INIT:"init",DRAW:"draw",LOAD:"load",DESTROY:"destroy",READY:"ready",ERROR:"error"};onmessage=async u=>{let{type:g,...o}=u.data;try{switch(g){case F.INIT:await zt(o);break;case F.DRAW:$t(o);break;case F.LOAD:await Wt(o);break;case F.DESTROY:Yt();break;default:throw new Error(`Unknown message: ${g}`)}}catch(y){postMessage({type:F.ERROR,message:y.message})}};async function zt(u){if(q)throw new Error("Already initialized");G=u.canvas,w=u.debug;let g=await navigator.gpu?.requestAdapter();if(!g)throw new Error("WebGPU not supported");z=await g.requestDevice(),J=G.getContext("webgpu");let o=navigator.gpu.getPreferredCanvasFormat();J.configure({device:z,format:o,alphaMode:"premultiplied"}),A=Q(z,J),A.setDebug(w),A.setCanvasSize(G.width,G.height);let y=!1,l=null;if(u.bytecode)try{let U=new Uint8Array(u.bytecode);l=it(U),y=l.hasEmbeddedExecutor}catch(U){u.debug&&console.log("[Worker] Bytecode parse failed, using shared executor:",U.message)}if(y&&l.executor){u.debug&&console.log("[Worker] Using embedded executor from payload");let U=ot({log:(P,O)=>{if(u.debug){let h=new TextDecoder().decode(new Uint8Array(S.buffer,P,O));console.log("[Executor]",h)}}}),{instance:x}=await WebAssembly.instantiate(l.executor,U);C=x.exports,S=C.memory,A.setMemory(S),q=!0,await p(l.payload)}else{if(!u.wasmUrl)throw new Error("wasmUrl required (no embedded executor)");let U=await fetch(u.wasmUrl);if(!U.ok)throw new Error(`Failed to fetch WASM: ${U.status}`);let{instance:x}=await WebAssembly.instantiateStreaming(U,qt());C=x.exports,S=C.memory,A.setMemory(S),q=!0,u.bytecode&&await p(u.bytecode)}postMessage({type:F.READY,width:G.width,height:G.height,frameCount:v})}async function Wt(u){if(!q)throw new Error("Not initialized");await p(u.bytecode),postMessage({type:F.READY,frameCount:v})}async function p(u){k&&(A.destroy(),A=Q(z,J),A.setDebug(w),A.setMemory(S),A.setCanvasSize(G.width,G.height),k=!1);let g=C.getBytecodePtr(),o=u instanceof Uint8Array?u:new Uint8Array(u);new Uint8Array(S.buffer,g,o.length).set(o),C.setBytecodeLen(o.length);let y=C.init();if(y!==0)throw new Error(`Init failed: ${y}`);let l=C.getCommandPtr(),U=C.getCommandLen();l&&U>0&&await A.execute(l),k=!0,v=1,st(0,G.width,G.height)}function st(u,g,o){A.setTime(u);let y=C.frame(u,g,o);if(y!==0){console.warn("[Worker] frame() returned non-zero:",y);return}let l=C.getCommandPtr(),U=C.getCommandLen();!l||U===0||A.execute(l)}function $t(u){!q||!k||st(u.time??0,G.width,G.height)}function Yt(){k=!1,A?.destroy(),z&&(z.destroy(),z=null),q=!1}function qt(){return{env:{log:(u,g)=>{let o=new TextDecoder().decode(new Uint8Array(S.buffer,u,g));console.log("[Executor]",o)}}}}\n';function O(){let e=new Blob([B],{type:"application/javascript"});return URL.createObjectURL(e)}var D=[137,80,78,71,13,10,26,10],x=[112,78,71,98],T=e=>e.length>=8&&D.every((t,n)=>e[n]===t),R=e=>e.length>=4&&e[0]===80&&e[1]===75&&(e[2]===3||e[2]===5),S=e=>e.length>=4&&e[0]===80&&e[1]===78&&e[2]===71&&e[3]===66;function v(e){return R(e)?"zip":T(e)?"png":S(e)?"pngb":null}async function b(e){let t=e instanceof Uint8Array?e:new Uint8Array(e),n=v(t);if(n==="pngb")return t;if(n==="png")return N(t);if(n==="zip")return F(t);throw new Error("Unknown format")}async function N(e){if(!T(e))throw new Error("Invalid PNG");let t=8;for(;t+12<=e.length;){let n=M(e,t),r=e.subarray(t+4,t+8);if(r[0]===x[0]&&r[1]===x[1]&&r[2]===x[2]&&r[3]===x[3]){let a=e.subarray(t+8,t+8+n);return _(a)}t+=12+n}throw new Error("No pNGb chunk found")}async function _(e){if(e.length<2)throw new Error("Invalid pNGb chunk");let t=e[0],n=e[1],r=e.subarray(2);if(t!==1)throw new Error(`Unsupported pNGb version: ${t}`);return n&1?I(r):new Uint8Array(r)}async function F(e){let t=-1;for(let o=22;o<=Math.min(e.length,65557);o++){let s=e.length-o;if(g(e,s)===101010256){t=s;break}}if(t===-1)throw new Error("Invalid ZIP");let n=f(e,t+10),r=g(e,t+16),a=null,i=null;for(let o=0;o<n&&g(e,r)===33639248;o++){let s=f(e,r+10),u=g(e,r+20),l=g(e,r+24),m=f(e,r+28),c=f(e,r+30),h=f(e,r+32),d=g(e,r+42),U=new TextDecoder().decode(e.subarray(r+46,r+46+m)),y=f(e,d+28),E=d+30+m+y,p={name:U,compression:s,compSize:u,uncompSize:l,dataOff:E};U==="manifest.json"?a=p:U.endsWith(".pngb")&&!i&&(i=p),r+=46+m+c+h}if(a){let o=JSON.parse(new TextDecoder().decode(await P(e,a)));if(o.entry){r=g(e,t+16);for(let s=0;s<n&&g(e,r)===33639248;s++){let u=f(e,r+28);if(new TextDecoder().decode(e.subarray(r+46,r+46+u))===o.entry){let m=f(e,r+10),c=g(e,r+20),h=g(e,r+24),d=f(e,r+30),U=f(e,r+32),y=g(e,r+42),E=f(e,y+28),p=y+30+u+E;return P(e,{compression:m,compSize:c,uncompSize:h,dataOff:p})}r+=46+u+f(e,r+30)+f(e,r+32)}}}if(i)return P(e,i);throw new Error("No bytecode found in ZIP")}async function P(e,t){let n=e.subarray(t.dataOff,t.dataOff+t.compSize);if(t.compression===0)return new Uint8Array(n);if(t.compression===8)return I(n);throw new Error(`Unsupported compression: ${t.compression}`)}async function I(e){let t=new DecompressionStream("deflate-raw"),n=t.writable.getWriter(),r=t.readable.getReader();n.write(e),n.close();let a=[],i=0;for(;;){let{done:u,value:l}=await r.read();if(u)break;a.push(l),i+=l.length}let o=new Uint8Array(i),s=0;for(let u of a)o.set(u,s),s+=u.length;return o}var f=(e,t)=>e[t]|e[t+1]<<8,g=(e,t)=>(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0,M=(e,t)=>(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0,k=[80,78,71,66],C=0,G=40,W=1,V=2,z=1,$=2,q=4,Y=8,H=16,X=32;function Q(e){if(e.length<G)throw new Error("Invalid PNGB: too short");if(!k.every((r,a)=>e[a]===r))throw new Error("Invalid PNGB: bad magic");let t=new DataView(e.buffer,e.byteOffset,e.byteLength),n=t.getUint16(4,!0);if(n!==C)throw new Error(`Unsupported PNGB version: ${n}`);return J(e,t)}function J(e,t){let n=t.getUint16(6,!0),r=e[8],a=t.getUint32(12,!0),i=t.getUint32(16,!0),o=t.getUint32(20,!0),s=t.getUint32(24,!0),u=t.getUint32(28,!0),l=t.getUint32(32,!0),m=t.getUint32(36,!0),c=(n&W)!==0,h=(n&V)!==0,d=c?a+i:G,U=o-d;return{version:C,hasEmbeddedExecutor:c,hasAnimationTable:h,plugins:Z(r),executor:c?e.subarray(a,a+i):null,bytecode:e.subarray(d,d+U),payload:e,offsets:{executor:c?a:0,executorLength:i,bytecode:d,bytecodeLength:U,stringTable:o,data:s,wgsl:u,uniform:l,animation:m}}}function Z(e){return{core:(e&z)!==0,render:(e&$)!==0,compute:(e&q)!==0,wasm:(e&Y)!==0,animation:(e&H)!==0,texture:(e&X)!==0}}function ee(e={}){return{env:{log:e.log||((t,n)=>{}),wasmInstantiate:e.wasmInstantiate||((t,n,r)=>{}),wasmCall:e.wasmCall||((t,n,r,a,i,o)=>{}),wasmGetResult:e.wasmGetResult||((t,n,r)=>0)}}}async function te(e,t={}){let{instance:n}=await WebAssembly.instantiate(e,t),r=n.exports,a=r.memory;return{instance:n,memory:a,exports:r,getBytecodePtr(){return r.getBytecodePtr?.()||0},setBytecodeLen(i){r.setBytecodeLen?.(i)},getDataPtr(){return r.getDataPtr?.()||0},setDataLen(i){r.setDataLen?.(i)},init(){r.init?.()},frame(i,o,s){r.frame?.(i,o,s)},getCommandPtr(){return r.getCommandPtr?.()||0},getCommandLen(){return r.getCommandLen?.()||0}}}function ne(e){let t=["core"];return e.render&&t.push("render"),e.compute&&t.push("compute"),e.wasm&&t.push("wasm"),e.animation&&t.push("anim"),e.texture&&t.push("texture"),t.join("-")}function L(e,t){if(!e||e.length===0)return null;for(let n of e)if(t>=n.startMs&&t<n.endMs)return n;return e[e.length-1]}function w(e,t={}){let n=e._;if(!n)throw new Error("Pngine destroyed");if(!n.ready)throw new Error("Not initialized");let r=t.time??n.time,a=t.frame??null;if(a===null&&n.animation&&n.animation.scenes.length>0){let i=L(n.animation.scenes,r*1e3);i&&(a=i.frame,i!==n.currentScene&&(n.currentScene=i,n.currentFrame=i.frame))}n.worker.postMessage({type:"draw",time:r,frame:a,uniforms:t.uniforms??null}),t.time!==void 0&&(n.time=t.time)}function re(e){let t=e._;if(!t||t.playing)return e;t.playing=!0,t.startTime=performance.now()-t.time*1e3;let n=()=>{if(!t.playing)return;let r=performance.now(),a=(r-t.startTime)/1e3;if(t.animation){let i=t.animation.duration/1e3;if(a>=i)switch(t.animation.endBehavior){case"loop":case"restart":t.startTime=r,a=0;break;case"stop":t.playing=!1,t.time=i,w(e,{time:i});return;case"hold":default:a=i;break}let o=L(t.animation.scenes,a*1e3);o&&o!==t.currentScene&&(t.currentScene=o,t.currentFrame=o.frame)}t.time=a,w(e,{time:t.time,frame:t.currentFrame}),t.animationId=requestAnimationFrame(n)};return t.animationId=requestAnimationFrame(n),e}function j(e){let t=e._;return!t||!t.playing||(t.playing=!1,t.time=(performance.now()-t.startTime)/1e3,t.animationId&&(cancelAnimationFrame(t.animationId),t.animationId=null)),e}function ae(e){j(e);let t=e._;return t&&(t.time=0,t.startTime=performance.now(),w(e,{time:0})),e}function ie(e,t){let n=e._;return n&&(n.time=t,n.playing&&(n.startTime=performance.now()-t*1e3),w(e,{time:t})),e}function oe(e,t){let n=e._;return n&&(n.currentFrame=t,w(e,{time:n.time,frame:t})),e}function se(e,t,n,r=!0){let a=e._;return a&&(a.uniforms||(a.uniforms={}),a.uniforms[t]=n,r&&w(e,{time:a.time,uniforms:{[t]:n}})),e}function ue(e,t,n=!0){let r=e._;return r&&(r.uniforms||(r.uniforms={}),Object.assign(r.uniforms,t),n&&w(e,{time:r.time,uniforms:t})),e}async function ce(e,t={}){let n,r;if(typeof e=="string")if(e.startsWith("#")||e.startsWith(".")&&!e.startsWith("./")&&!e.startsWith("..")){let u=document.querySelector(e);if(!u)throw new Error(`Element not found: ${e}`);if(u instanceof HTMLImageElement)({canvas:n,bytecode:r}=await A(u,t));else throw u instanceof HTMLCanvasElement?(n=u,new Error("Canvas source requires URL or data")):new Error("Invalid element type")}else{if(n=t.canvas,!n)throw new Error("Canvas required for URL source");let u=await fetch(e);if(!u.ok)throw new Error(`Fetch failed: ${u.status}`);r=await b(await u.arrayBuffer())}else if(e instanceof HTMLImageElement)({canvas:n,bytecode:r}=await A(e,t));else if(e instanceof ArrayBuffer||e instanceof Uint8Array||e instanceof Blob){if(n=t.canvas,!n)throw new Error("Canvas required for data source");let s=e instanceof Blob?await e.arrayBuffer():e;r=await b(s)}else throw new Error("Invalid source type");let a=n.transferControlToOffscreen(),i=new Worker(O()),o=await new Promise((s,u)=>{let l=setTimeout(()=>u(new Error("Worker init timeout")),15e3);i.onmessage=c=>{c.data.type==="ready"?(clearTimeout(l),s(c.data)):c.data.type==="error"&&(clearTimeout(l),u(new Error(c.data.message)))},i.onerror=c=>{clearTimeout(l),u(new Error(c.message||"Worker error"))};let m=t.wasmUrl?new URL(t.wasmUrl,window.location.href).href:new URL("pngine.wasm",import.meta.url).href;i.postMessage({type:"init",canvas:a,bytecode:r,wasmUrl:m,debug:t.debug||!1},[a,r.buffer])});return i.onmessage=s=>{s.data.type==="error"&&t.onError&&t.onError(new Error(s.data.message))},K({canvas:n,worker:i,width:o.width,height:o.height,frameCount:o.frameCount,animation:o.animation||null,currentScene:null,currentFrame:null,ready:!0,playing:!1,time:0,startTime:0,animationId:null})}async function A(e,t){e.complete||await new Promise((s,u)=>{e.onload=s,e.onerror=u});let{naturalWidth:n,naturalHeight:r}=e;if(n===0||r===0)throw new Error("Image has no dimensions");let a=t.canvas||document.createElement("canvas");if(a.width=n,a.height=r,!t.canvas){let s=e.parentElement;s&&getComputedStyle(s).position==="static"&&(s.style.position="relative"),Object.assign(a.style,{position:"absolute",top:e.offsetTop+"px",left:e.offsetLeft+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px",pointerEvents:"none"}),s&&s.appendChild(a)}let i=await fetch(e.src);if(!i.ok)throw new Error(`Failed to fetch image: ${i.status}`);let o=await b(await i.arrayBuffer());return{canvas:a,bytecode:o}}function K(e){return{get width(){return e.width},get height(){return e.height},get isPlaying(){return e.playing},get time(){return e.time},get frameCount(){return e.frameCount},get animation(){return e.animation},get currentScene(){return e.currentScene},get currentFrame(){return e.currentFrame},get duration(){return e.animation?e.animation.duration/1e3:0},_:e}}function fe(e){let t=e._;return t&&(t.animationId&&cancelAnimationFrame(t.animationId),t.worker.postMessage({type:"destroy"}),t.worker.terminate(),e._=null),e}export{te as createExecutor,fe as destroy,v as detectFormat,w as draw,b as extractBytecode,ee as getExecutorImports,ne as getExecutorVariantName,T as isPng,S as isPngb,R as isZip,Q as parsePayload,j as pause,re as play,ce as pngine,ie as seek,oe as setFrame,se as setUniform,ue as setUniforms,ae as stop};
