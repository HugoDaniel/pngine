var F='var f={CREATE_BUFFER:1,CREATE_TEXTURE:2,CREATE_SAMPLER:3,CREATE_SHADER:4,CREATE_RENDER_PIPELINE:5,CREATE_COMPUTE_PIPELINE:6,CREATE_BIND_GROUP:7,CREATE_TEXTURE_VIEW:8,CREATE_QUERY_SET:9,CREATE_BIND_GROUP_LAYOUT:10,CREATE_IMAGE_BITMAP:11,CREATE_PIPELINE_LAYOUT:12,CREATE_RENDER_BUNDLE:13,BEGIN_RENDER_PASS:16,BEGIN_COMPUTE_PASS:17,SET_PIPELINE:18,SET_BIND_GROUP:19,SET_VERTEX_BUFFER:20,DRAW:21,DRAW_INDEXED:22,END_PASS:23,DISPATCH:24,SET_INDEX_BUFFER:25,EXECUTE_BUNDLES:26,WRITE_BUFFER:32,WRITE_TIME_UNIFORM:33,COPY_BUFFER_TO_BUFFER:34,COPY_TEXTURE_TO_TEXTURE:35,WRITE_BUFFER_FROM_WASM:36,COPY_EXTERNAL_IMAGE_TO_TEXTURE:37,INIT_WASM_MODULE:48,CALL_WASM_FUNC:49,CREATE_TYPED_ARRAY:64,FILL_RANDOM:65,FILL_EXPRESSION:66,FILL_CONSTANT:67,WRITE_BUFFER_FROM_ARRAY:68,SUBMIT:240,END:255},p={MAP_READ:1,MAP_WRITE:2,COPY_SRC:4,COPY_DST:8,INDEX:16,VERTEX:32,UNIFORM:64,STORAGE:128},F=class{constructor(r,t){this.device=r,this.context=t,this.memory=null,this.debug=!1,this.buffers=new Map,this.textures=new Map,this.textureViews=new Map,this.samplers=new Map,this.shaders=new Map,this.pipelines=new Map,this.bindGroups=new Map,this.bindGroupLayouts=new Map,this.pipelineLayouts=new Map,this.querySets=new Map,this.renderBundles=new Map,this.imageBitmaps=new Map,this.wasmModules=new Map,this.typedArrays=new Map,this.bindGroupDescriptors=new Map,this.textureDescriptors=new Map,this.encoder=null,this.pass=null,this.time=0,this.canvasWidth=0,this.canvasHeight=0}setDebug(r){this.debug=r}setMemory(r){this.memory=r}setTime(r){this.time=r}setCanvasSize(r,t){this.canvasWidth=r,this.canvasHeight=t}async execute(r){let t=new DataView(this.memory.buffer),e=t.getUint32(r,!0),s=t.getUint16(r+4,!0);this.debug&&console.log(`[GPU] Execute: ${s} commands, ${e} bytes`);let n=r+8,i=r+e;for(let a=0;a<s&&n<i;a++){let u=t.getUint8(n++);this.debug&&console.log(`[GPU] Cmd ${a}: 0x${u.toString(16)}`);let c=this._dispatch(u,t,n);c instanceof Promise?(n=await c,t=new DataView(this.memory.buffer)):n=c}}_dispatch(r,t,e){switch(r){case f.CREATE_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint8(e+6);return this._createBuffer(s,n,i),e+7}case f.CREATE_SHADER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createShader(s,n,i),e+10}case f.CREATE_RENDER_PIPELINE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createRenderPipeline(s,n,i),e+10}case f.CREATE_COMPUTE_PIPELINE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createComputePipeline(s,n,i),e+10}case f.CREATE_BIND_GROUP:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0);return this._createBindGroup(s,n,i,a),e+12}case f.CREATE_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createTexture(s,n,i),e+10}case f.CREATE_SAMPLER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createSampler(s,n,i),e+10}case f.CREATE_TEXTURE_VIEW:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0);return this._createTextureView(s,n,i,a),e+12}case f.CREATE_QUERY_SET:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createQuerySet(s,n,i),e+10}case f.CREATE_BIND_GROUP_LAYOUT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createBindGroupLayout(s,n,i),e+10}case f.CREATE_PIPELINE_LAYOUT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createPipelineLayout(s,n,i),e+10}case f.CREATE_RENDER_BUNDLE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createRenderBundle(s,n,i),e+10}case f.BEGIN_RENDER_PASS:{let s=t.getUint16(e,!0),n=t.getUint8(e+2),i=t.getUint8(e+3),a=t.getUint16(e+4,!0);return this._beginRenderPass(s,n,i,a),e+6}case f.BEGIN_COMPUTE_PASS:return this._beginComputePass(),e;case f.SET_PIPELINE:{let s=t.getUint16(e,!0);return this.pass?.setPipeline(this.pipelines.get(s)),e+2}case f.SET_BIND_GROUP:{let s=t.getUint8(e),n=t.getUint16(e+1,!0);return this.pass?.setBindGroup(s,this.bindGroups.get(n)),e+3}case f.SET_VERTEX_BUFFER:{let s=t.getUint8(e),n=t.getUint16(e+1,!0);return this.pass?.setVertexBuffer(s,this.buffers.get(n)),e+3}case f.SET_INDEX_BUFFER:{let s=t.getUint16(e,!0),i=t.getUint8(e+2)===1?"uint32":"uint16";return this.pass?.setIndexBuffer(this.buffers.get(s),i),e+3}case f.EXECUTE_BUNDLES:{let s=t.getUint8(e),n=[];for(let i=0;i<s;i++){let a=t.getUint16(e+1+i*2,!0),u=this.renderBundles.get(a);u&&n.push(u)}return this.pass?.executeBundles(n),e+1+s*2}case f.DRAW:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0),a=t.getUint32(e+12,!0);return this.debug&&console.log(`[GPU] draw(vtx=${s}, inst=${n}, firstVtx=${i}, firstInst=${a})`),this.pass?.draw(s,n,i,a),e+16}case f.DRAW_INDEXED:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0),a=t.getInt32(e+12,!0),u=t.getUint32(e+16,!0);return this.pass?.drawIndexed(s,n,i,a,u),e+20}case f.DISPATCH:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0);return this.debug&&console.log(`[GPU] dispatch(${s}, ${n}, ${i})`),this.pass?.dispatchWorkgroups(s,n,i),e+12}case f.END_PASS:return this.pass?.end(),this.pass=null,e;case f.WRITE_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0);return this._writeBuffer(s,n,i,a),e+14}case f.WRITE_TIME_UNIFORM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0);return this._writeTimeUniform(s,n,i),e+8}case f.CREATE_IMAGE_BITMAP:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createImageBitmap(s,n,i),e+10}case f.COPY_EXTERNAL_IMAGE_TO_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint8(e+4),a=t.getUint16(e+5,!0),u=t.getUint16(e+7,!0),c=e+9;return this._copyExternalImageToTexture(s,n,i,a,u).then(()=>c)}case f.COPY_BUFFER_TO_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0),a=t.getUint32(e+8,!0),u=t.getUint32(e+12,!0);return this._copyBufferToBuffer(s,n,i,a,u),e+16}case f.COPY_TEXTURE_TO_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint16(e+4,!0),a=t.getUint16(e+6,!0);return this._copyTextureToTexture(s,n,i,a),e+8}case f.WRITE_BUFFER_FROM_WASM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0);return this._writeBufferFromWasm(s,n,i,a),e+14}case f.INIT_WASM_MODULE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._initWasmModule(s,n,i),e+10}case f.CALL_WASM_FUNC:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0),u=t.getUint32(e+12,!0),c=t.getUint32(e+16,!0);return this._callWasmFunc(s,n,i,a,u,c),e+20}case f.CREATE_TYPED_ARRAY:{let s=t.getUint16(e,!0),n=t.getUint8(e+2),i=t.getUint32(e+3,!0);return this._createTypedArray(s,n,i),e+7}case f.FILL_RANDOM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0);return this._fillRandom(s,n,i,a,u),e+15}case f.FILL_EXPRESSION:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0),c=t.getUint16(e+15,!0);return this._fillExpression(s,n,i,a,u,c),e+17}case f.FILL_CONSTANT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0);return this._fillConstant(s,n,i,a,u),e+15}case f.WRITE_BUFFER_FROM_ARRAY:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0);return this._writeBufferFromArray(s,n,i),e+8}case f.SUBMIT:return this.encoder&&(this.device.queue.submit([this.encoder.finish()]),this.encoder=null),e;case f.END:return e;default:return console.warn(`Unknown command: 0x${r.toString(16)}`),e}}_createBuffer(r,t,e){if(this.buffers.has(r))return;let s=this._translateUsage(e);this.buffers.set(r,this.device.createBuffer({size:t,usage:s}))}_translateUsage(r){let t=0;return r&p.MAP_READ&&(t|=GPUBufferUsage.MAP_READ),r&p.MAP_WRITE&&(t|=GPUBufferUsage.MAP_WRITE),r&p.COPY_SRC&&(t|=GPUBufferUsage.COPY_SRC),r&p.COPY_DST&&(t|=GPUBufferUsage.COPY_DST),r&p.INDEX&&(t|=GPUBufferUsage.INDEX),r&p.VERTEX&&(t|=GPUBufferUsage.VERTEX),r&p.UNIFORM&&(t|=GPUBufferUsage.UNIFORM),r&p.STORAGE&&(t|=GPUBufferUsage.STORAGE),t||GPUBufferUsage.COPY_DST}_createShader(r,t,e){if(this.shaders.has(r))return;let s=this._readString(t,e);this.shaders.set(r,this.device.createShaderModule({code:s}))}_createRenderPipeline(r,t,e){if(this.pipelines.has(r))return;let s=this._readString(t,e);if(!s||s.length===0){console.error(`[GPU] Empty pipeline descriptor for id=${r}, ptr=${t}, len=${e}`);return}let n=JSON.parse(s),i=this._buildRenderPipeline(n);this.pipelines.set(r,i),this.bindGroupLayouts.set(r,i.getBindGroupLayout(0))}_buildRenderPipeline(r){let t=navigator.gpu.getPreferredCanvasFormat();return this.device.createRenderPipeline({layout:"auto",vertex:{module:this.shaders.get(r.vertex?.shader??0),entryPoint:r.vertex?.entryPoint??"vs_main",buffers:r.vertex?.buffers??[]},fragment:{module:this.shaders.get(r.fragment?.shader??r.vertex?.shader??0),entryPoint:r.fragment?.entryPoint??"fs_main",targets:[{format:t}]},primitive:r.primitive??{topology:"triangle-list"},depthStencil:r.depthStencil})}_createComputePipeline(r,t,e){if(this.pipelines.has(r))return;let s=this._readString(t,e);if(!s||s.length===0){console.error(`[GPU] Empty compute pipeline descriptor for id=${r}, ptr=${t}, len=${e}`);return}let n=JSON.parse(s),i="auto";n.layout&&n.layout!=="auto"&&(i=this.pipelineLayouts.get(n.layout)??"auto");let a=this.device.createComputePipeline({layout:i,compute:{module:this.shaders.get(n.compute?.shader??0),entryPoint:n.compute?.entryPoint??"main"}});this.pipelines.set(r,a),i==="auto"&&this.bindGroupLayouts.set(r,a.getBindGroupLayout(0))}_createBindGroup(r,t,e,s){if(this.bindGroups.has(r))return;let n=new Uint8Array(this.memory.buffer,e,s),i=this._decodeBindGroupDescriptor(n);i.layoutId=t,this.bindGroupDescriptors.set(r,i);let a=this.pipelines.get(t);if(!a){console.error(`[GPU] Pipeline ${t} not found for bind group ${r}`);return}let u=i.entries.map(c=>{let g={binding:c.binding};if(c.resourceType===0){let l={buffer:this.buffers.get(c.resourceId)};c.offset&&(l.offset=c.offset),c.size&&(l.size=c.size),g.resource=l}else c.resourceType===1?g.resource=this.textures.get(c.resourceId)?.createView():c.resourceType===2&&(g.resource=this.samplers.get(c.resourceId));return g});this.bindGroups.set(r,this.device.createBindGroup({layout:a.getBindGroupLayout(i.groupIndex),entries:u}))}_decodeBindGroupDescriptor(r){let t=new DataView(r.buffer,r.byteOffset,r.byteLength),e=0,s=r[e++];if(s!==3)return console.error(`[GPU] Invalid bind group descriptor type tag: ${s}`),{groupIndex:0,entries:[]};let n=r[e++],i=0,a=[],u=1,c=2,g=3,l=7;for(let E=0;E<n;E++){let I=r[e++],m=r[e++];if(I===u&&m===l)i=r[e++];else if(I===c&&m===g){let C=r[e++];for(let b=0;b<C;b++){let T=r[e++],R=r[e++],U=t.getUint16(e,!0);e+=2;let S={binding:T,resourceType:R,resourceId:U};R===0&&(S.offset=t.getUint32(e,!0),e+=4,S.size=t.getUint32(e,!0),e+=4),a.push(S)}}}return{groupIndex:i,entries:a}}_createTexture(r,t,e){if(this.textures.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=this._decodeTextureDescriptor(s);this.textureDescriptors.set(r,{format:n.format,usage:n.usage}),this.textures.set(r,this.device.createTexture(n))}_createSampler(r,t,e){if(this.samplers.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=this._decodeSamplerDescriptor(s);this.samplers.set(r,this.device.createSampler(n))}_decodeTextureDescriptor(r){let t=new DataView(r.buffer,r.byteOffset,r.byteLength),e=0,s=r[e++];if(s!==1)return console.error(`[GPU] Invalid texture descriptor type tag: ${s}`),{size:[256,256],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT};let n=r[e++],i={size:[this.canvasWidth||512,this.canvasHeight||512],format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:1},a=1,u=2,c=5,g=7,l=8,E=10,I=0,m=6,C=7;for(let b=0;b<n;b++){let T=r[e++],R=r[e++];if(R===I){let U=t.getUint32(e,!0);e+=4,T===a?i.size[0]=U:T===u?i.size[1]=U:T===c&&(i.sampleCount=U)}else if(R===m){let U=t.getUint16(e,!0);e+=2,T===E&&(i.size=[1,1],i.imageBitmapId=U)}else if(R===C){let U=r[e++];T===g?i.format=this._decodeTextureFormat(U):T===l&&(i.usage=this._decodeTextureUsage(U))}}return i}_decodeSamplerDescriptor(r){let t=0,e=r[t++];if(e!==2)return console.error(`[GPU] Invalid sampler descriptor type tag: ${e}`),{};let s=r[t++],n={magFilter:"linear",minFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},i=1,a=2,u=4,c=5,g=7;for(let l=0;l<s;l++){let E=r[t++];if(r[t++]===g){let m=r[t++];E===u?n.magFilter=m===0?"nearest":"linear":E===c?n.minFilter=m===0?"nearest":"linear":E===i?n.addressModeU=["clamp-to-edge","repeat","mirror-repeat"][m]||"clamp-to-edge":E===a&&(n.addressModeV=["clamp-to-edge","repeat","mirror-repeat"][m]||"clamp-to-edge")}}return n}_decodeTextureFormat(r){return{0:"rgba8unorm",1:"rgba8snorm",2:"rgba8uint",3:"rgba8sint",4:"bgra8unorm",5:"rgba16float",6:"rgba32float",16:"depth24plus",17:"depth24plus-stencil8",18:"depth32float"}[r]||navigator.gpu.getPreferredCanvasFormat()}_decodeTextureUsage(r){let t=0;return r&1&&(t|=GPUTextureUsage.COPY_SRC),r&2&&(t|=GPUTextureUsage.COPY_DST),r&4&&(t|=GPUTextureUsage.TEXTURE_BINDING),r&8&&(t|=GPUTextureUsage.STORAGE_BINDING),r&16&&(t|=GPUTextureUsage.RENDER_ATTACHMENT),t||GPUTextureUsage.RENDER_ATTACHMENT}_beginRenderPass(r,t,e,s){this.encoder||(this.encoder=this.device.createCommandEncoder());let c={colorAttachments:[{view:r===65534?this.context.getCurrentTexture().createView():this.textures.get(r)?.createView(),loadOp:t===1?"clear":"load",storeOp:e===0?"store":"discard",clearValue:{r:0,g:0,b:0,a:1}}]};if(s!==65535){let g=this.textures.get(s)?.createView();g&&(c.depthStencilAttachment={view:g,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1})}this.pass=this.encoder.beginRenderPass(c)}_beginComputePass(){this.encoder||(this.encoder=this.device.createCommandEncoder()),this.pass=this.encoder.beginComputePass()}_writeBuffer(r,t,e,s){let n=this.buffers.get(r);if(!n)return;let i=new Uint8Array(this.memory.buffer,e,s);this.device.queue.writeBuffer(n,t,i)}_writeTimeUniform(r,t,e){let s=this.buffers.get(r);if(!s)return;let n=new Float32Array([this.time,this.canvasWidth,this.canvasHeight,this.canvasWidth/(this.canvasHeight||1)]),i=new Uint8Array(n.buffer,0,Math.min(e,16));this.device.queue.writeBuffer(s,t,i)}_readString(r,t){let e=new Uint8Array(this.memory.buffer,r,t);return new TextDecoder().decode(e)}_createImageBitmap(r,t,e){if(this.imageBitmaps.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=s[0],i=s.slice(1,1+n),a=new TextDecoder().decode(i),u=s.slice(1+n),c=new Blob([u],{type:a}),g=globalThis.createImageBitmap(c);this.imageBitmaps.set(r,g)}async _copyExternalImageToTexture(r,t,e,s,n){let i=this.imageBitmaps.get(r);if(!i){console.error(`[GPU] ImageBitmap ${r} not found`);return}i instanceof Promise&&(i=await i,this.imageBitmaps.set(r,i));let a=this.textures.get(t);if(!a){console.error(`[GPU] Texture ${t} not found`);return}if(a.width!==i.width||a.height!==i.height){a.destroy();let u=this.textureDescriptors.get(t)||{format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};a=this.device.createTexture({size:[i.width,i.height],format:u.format,usage:u.usage}),this.textures.set(t,a),this._recreateBindGroupsForTexture(t)}this.device.queue.copyExternalImageToTexture({source:i},{texture:a,mipLevel:e,origin:{x:s,y:n}},{width:i.width,height:i.height})}_recreateBindGroupsForTexture(r){for(let[t,e]of this.bindGroupDescriptors.entries())e.entries.some(n=>n.resourceType===1&&n.resourceId===r)&&(this.bindGroups.delete(t),this._recreateBindGroup(t,e))}_recreateBindGroup(r,t){let e=this.pipelines.get(t.layoutId);if(!e)return;let s=t.entries.map(n=>{let i={binding:n.binding};if(n.resourceType===0){let a={buffer:this.buffers.get(n.resourceId)};n.offset&&(a.offset=n.offset),n.size&&(a.size=n.size),i.resource=a}else n.resourceType===1?i.resource=this.textures.get(n.resourceId)?.createView():n.resourceType===2&&(i.resource=this.samplers.get(n.resourceId));return i});this.bindGroups.set(r,this.device.createBindGroup({layout:e.getBindGroupLayout(t.groupIndex),entries:s}))}_createTextureView(r,t,e,s){if(this.textureViews.has(r))return;let n=this.textures.get(t);n&&this.textureViews.set(r,n.createView())}_createQuerySet(r,t,e){this.querySets.has(r)}_createBindGroupLayout(r,t,e){this.bindGroupLayouts.has(r)}_createPipelineLayout(r,t,e){this.pipelineLayouts.has(r)}_createRenderBundle(r,t,e){this.renderBundles.has(r)}_copyBufferToBuffer(r,t,e,s,n){let i=this.buffers.get(r),a=this.buffers.get(e);if(!i||!a)return;let u=this.encoder||this.device.createCommandEncoder();u.copyBufferToBuffer(i,t,a,s,n),this.encoder||this.device.queue.submit([u.finish()])}_copyTextureToTexture(r,t,e,s){let n=this.textures.get(r),i=this.textures.get(t);if(!n||!i)return;let a=this.encoder||this.device.createCommandEncoder();a.copyTextureToTexture({texture:n},{texture:i},{width:e,height:s}),this.encoder||this.device.queue.submit([a.finish()])}_writeBufferFromWasm(r,t,e,s){let n=this.buffers.get(r);if(!n)return;let i=new Uint8Array(this.memory.buffer,e,s);this.device.queue.writeBuffer(n,t,i)}_initWasmModule(r,t,e){}_callWasmFunc(r,t,e,s,n,i){}_createTypedArray(r,t,e){if(this.typedArrays.has(r))return;let n=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t]||Float32Array,i=new n(e);this.debug&&console.log(`[GPU] createTypedArray(id=${r}, type=${t}/${n.name}, size=${e}, byteLength=${i.byteLength})`),this.typedArrays.set(r,i)}_fillRandom(r,t,e,s,n){let i=this.typedArrays.get(r);if(!i){console.error(`[GPU] fillRandom: array ${r} not found`);return}let a=new Float32Array(this.memory.buffer,n,e);this.debug&&console.log(`[GPU] fillRandom(array=${r}, offset=${t}, count=${e}, stride=${s}, dataPtr=${n})`);for(let u=0;u<e;u++){let c=t+u*s;c<i.length&&(i[c]=a[u])}}_fillExpression(r,t,e,s,n,i){let a=this.typedArrays.get(r);if(!a){console.error(`[GPU] fillExpression: array ${r} not found`);return}let u=this._readString(n,i);if(this.debug&&console.log(`[GPU] fillExpression(array=${r}, offset=${t}, count=${e}, stride=${s}, expr="${u}")`),!!u)try{let c=u.replace(/NUM_PARTICLES/g,String(e)).replace(/PI/g,"Math.PI").replace(/random\\(\\)/g,"Math.random()").replace(/sin\\(/g,"Math.sin(").replace(/cos\\(/g,"Math.cos(").replace(/sqrt\\(/g,"Math.sqrt(").replace(/ceil\\(/g,"Math.ceil(").replace(/floor\\(/g,"Math.floor(").replace(/abs\\(/g,"Math.abs("),g=new Function("ELEMENT_ID",`return ${c};`);for(let l=0;l<e;l++){let E=l*s+t;a[E]=g(l)}}catch(c){console.error(`[GPU] Error evaluating expression "${u}":`,c)}}_fillConstant(r,t,e,s,n){let i=this.typedArrays.get(r);if(!i)return;let u=new Float32Array(this.memory.buffer,n,1)[0];for(let c=0;c<e;c++){let g=c*s+t;i[g]=u}}_writeBufferFromArray(r,t,e){let s=this.typedArrays.get(e),n=this.buffers.get(r);if(!s||!n){console.error(`[GPU] writeBufferFromArray: missing array ${e} or buffer ${r}`);return}if(this.debug){console.log(`[GPU] writeBufferFromArray(buffer=${r}, offset=${t}, array=${e}, type=${s.constructor.name}, byteLen=${s.byteLength})`);let i=s instanceof Float32Array?s:new Float32Array(s.buffer,s.byteOffset,Math.min(8,s.byteLength/4));console.log(`[GPU]   first values: [${Array.from(i.slice(0,8)).join(", ")}]`)}this.device.queue.writeBuffer(n,t,s)}destroy(){for(let r of this.buffers.values())r.destroy?.();for(let r of this.textures.values())r.destroy?.();for(let r of this.imageBitmaps.values())r instanceof ImageBitmap&&r.close?.();this.buffers.clear(),this.textures.clear(),this.textureViews.clear(),this.samplers.clear(),this.shaders.clear(),this.pipelines.clear(),this.bindGroups.clear(),this.bindGroupLayouts.clear(),this.pipelineLayouts.clear(),this.querySets.clear(),this.renderBundles.clear(),this.imageBitmaps.clear(),this.wasmModules.clear(),this.typedArrays.clear(),this.bindGroupDescriptors.clear(),this.textureDescriptors.clear()}};var x,y,B,h,d,_,L=!1,P=!1,M=0,D=null,A={INIT:"init",DRAW:"draw",LOAD:"load",DESTROY:"destroy",READY:"ready",ERROR:"error"};onmessage=async o=>{let{type:r,...t}=o.data;try{switch(r){case A.INIT:await $(t);break;case A.DRAW:w(t);break;case A.LOAD:await W(t);break;case A.DESTROY:q();break;default:throw new Error(`Unknown message: ${r}`)}}catch(e){postMessage({type:A.ERROR,message:e.message})}};async function $(o){if(L)throw new Error("Already initialized");x=o.canvas;let r=await navigator.gpu?.requestAdapter();if(!r)throw new Error("WebGPU not supported");y=await r.requestDevice(),B=x.getContext("webgpu");let t=navigator.gpu.getPreferredCanvasFormat();if(B.configure({device:y,format:t,alphaMode:"premultiplied"}),h=new F(y,B),h.setDebug(o.debug),h.setCanvasSize(x.width,x.height),!o.wasmUrl)throw new Error("wasmUrl required");let e=await fetch(o.wasmUrl);if(!e.ok)throw new Error(`Failed to fetch WASM: ${e.status}`);let{instance:s}=await WebAssembly.instantiateStreaming(e,H());d=s.exports,_=d.memory,h.setMemory(_),d.onInit(),L=!0,o.bytecode&&await N(o.bytecode),postMessage({type:A.READY,width:x.width,height:x.height,frameCount:M,animation:D})}async function W(o){if(!L)throw new Error("Not initialized");await N(o.bytecode),postMessage({type:A.READY,frameCount:M,animation:D})}async function N(o){if(P){let e=h.debug;d.freeModule(),h.destroy(),h=new F(y,B),h.setDebug(e),h.setMemory(_),h.setCanvasSize(x.width,x.height),P=!1,D=null}let r=d.alloc(o.byteLength);if(!r)throw new Error("Failed to allocate memory");new Uint8Array(_.buffer,r,o.byteLength).set(new Uint8Array(o));let t=d.loadModule(r,o.byteLength);if(d.free(r,o.byteLength),t!==0)throw new Error(`Load failed: ${t}`);P=!0,M=d.getFrameCount(),D=V(),O(0,0)}function V(){if(!d.hasAnimationInfo())return null;let o=d.getAnimationDuration(),r=d.getAnimationLoop()===1,t=d.getAnimationEndBehavior(),e=d.getSceneCount(),s=Y(d.getAnimationName),n=[];for(let i=0;i<e;i++){let a=d.getSceneInfo(i);if(a===0xFFFFFFFFFFFFFFFFn)continue;let u=Number(a&0xFFFFFFFFn),c=Number(a>>32n&0xFFFFFFFFn),g=G(d.getSceneId,i),l=G(d.getSceneFrame,i);n.push({id:g,frame:l,startMs:u,endMs:c})}return{name:s,duration:o,loop:r,endBehavior:["hold","stop","restart"][t]||"hold",scenes:n}}function Y(o){let t=d.alloc(256);if(!t)return"";let e=o(t,256),s=e>0?new TextDecoder().decode(new Uint8Array(_.buffer,t,e)):"";return d.free(t,256),s}function G(o,r){let e=d.alloc(256);if(!e)return"";let s=o(r,e,256),n=s>0?new TextDecoder().decode(new Uint8Array(_.buffer,e,s)):"";return d.free(e,256),n}function w(o){!L||!P||(o.uniforms&&X(o.uniforms),O(o.time??0,0))}function X(o){let r=new TextEncoder;for(let[t,e]of Object.entries(o)){let s=r.encode(t),n=d.alloc(s.length);if(!n)continue;new Uint8Array(_.buffer,n,s.length).set(s);let i=z(e);if(!i){d.free(n,s.length);continue}let a=d.alloc(i.length);if(!a){d.free(n,s.length);continue}new Uint8Array(_.buffer,a,i.length).set(i),d.setUniform(n,s.length,a,i.length),d.free(n,s.length),d.free(a,i.length)}}function z(o){if(typeof o=="number")return new Uint8Array(new Float32Array([o]).buffer);if(Array.isArray(o)){let r=o.flat(2);if(r.length===2||r.length===3||r.length===4||r.length===9||r.length===16)return new Uint8Array(new Float32Array(r).buffer)}return null}function O(o,r){h.setTime(o);let t=d.renderFrame(o,r);t&&h.execute(t)}function q(){P&&(d.freeModule(),P=!1),h?.destroy(),y&&(y.destroy(),y=null),L=!1}function H(){let o=()=>{};return{env:{gpuCreateBuffer:o,gpuCreateTexture:o,gpuCreateSampler:o,gpuCreateShaderModule:o,gpuCreateRenderPipeline:o,gpuCreateComputePipeline:o,gpuCreateBindGroup:o,gpuCreateImageBitmap:o,gpuCreateTextureView:o,gpuCreateQuerySet:o,gpuCreateBindGroupLayout:o,gpuCreatePipelineLayout:o,gpuCreateRenderBundle:o,gpuBeginRenderPass:o,gpuBeginComputePass:o,gpuSetPipeline:o,gpuSetBindGroup:o,gpuSetVertexBuffer:o,gpuSetIndexBuffer:o,gpuDraw:o,gpuDrawIndexed:o,gpuDispatch:o,gpuExecuteBundles:o,gpuEndPass:o,gpuWriteBuffer:(r,t,e,s)=>{let n=h?.buffers?.get(r);if(!n)return;let i=new Uint8Array(_.buffer,e,s);y.queue.writeBuffer(n,t,i)},gpuSubmit:o,gpuCopyExternalImageToTexture:o,gpuInitWasmModule:o,gpuCallWasmFunc:o,gpuWriteBufferFromWasm:o,gpuCreateTypedArray:o,gpuFillRandomData:o,gpuFillExpression:o,gpuFillConstant:o,gpuWriteBufferFromArray:o,gpuWriteTimeUniform:o,gpuDebugLog:o,jsConsoleLog:o,jsConsoleLogInt:o}}}\n';function B(){let e=new Blob([F],{type:"application/javascript"});return URL.createObjectURL(e)}var b=[137,80,78,71,13,10,26,10],U=[112,78,71,98],P=e=>e.length>=8&&b.every((t,r)=>e[r]===t),C=e=>e.length>=4&&e[0]===80&&e[1]===75&&(e[2]===3||e[2]===5),S=e=>e.length>=4&&e[0]===80&&e[1]===78&&e[2]===71&&e[3]===66;function D(e){return C(e)?"zip":P(e)?"png":S(e)?"pngb":null}async function R(e){let t=e instanceof Uint8Array?e:new Uint8Array(e),r=D(t);if(r==="pngb")return t;if(r==="png")return M(t);if(r==="zip")return L(t);throw new Error("Unknown format")}async function M(e){if(!P(e))throw new Error("Invalid PNG");let t=8;for(;t+12<=e.length;){let r=N(e,t),n=e.subarray(t+4,t+8);if(n[0]===U[0]&&n[1]===U[1]&&n[2]===U[2]&&n[3]===U[3]){let i=e.subarray(t+8,t+8+r);return G(i)}t+=12+r}throw new Error("No pNGb chunk found")}async function G(e){if(e.length<2)throw new Error("Invalid pNGb chunk");let t=e[0],r=e[1],n=e.subarray(2);if(t!==1)throw new Error(`Unsupported pNGb version: ${t}`);return r&1?x(n):new Uint8Array(n)}async function L(e){let t=-1;for(let u=22;u<=Math.min(e.length,65557);u++){let a=e.length-u;if(l(e,a)===101010256){t=a;break}}if(t===-1)throw new Error("Invalid ZIP");let r=c(e,t+10),n=l(e,t+16),i=null,s=null;for(let u=0;u<r&&l(e,n)===33639248;u++){let a=c(e,n+10),o=l(e,n+20),g=l(e,n+24),d=c(e,n+28),f=c(e,n+30),y=c(e,n+32),_=l(e,n+42),p=new TextDecoder().decode(e.subarray(n+46,n+46+d)),m=c(e,_+28),w=_+30+d+m,E={name:p,compression:a,compSize:o,uncompSize:g,dataOff:w};p==="manifest.json"?i=E:p.endsWith(".pngb")&&!s&&(s=E),n+=46+d+f+y}if(i){let u=JSON.parse(new TextDecoder().decode(await T(e,i)));if(u.entry){n=l(e,t+16);for(let a=0;a<r&&l(e,n)===33639248;a++){let o=c(e,n+28);if(new TextDecoder().decode(e.subarray(n+46,n+46+o))===u.entry){let d=c(e,n+10),f=l(e,n+20),y=l(e,n+24),_=c(e,n+30),p=c(e,n+32),m=l(e,n+42),w=c(e,m+28),E=m+30+o+w;return T(e,{compression:d,compSize:f,uncompSize:y,dataOff:E})}n+=46+o+c(e,n+30)+c(e,n+32)}}}if(s)return T(e,s);throw new Error("No bytecode found in ZIP")}async function T(e,t){let r=e.subarray(t.dataOff,t.dataOff+t.compSize);if(t.compression===0)return new Uint8Array(r);if(t.compression===8)return x(r);throw new Error(`Unsupported compression: ${t.compression}`)}async function x(e){let t=new DecompressionStream("deflate-raw"),r=t.writable.getWriter(),n=t.readable.getReader();r.write(e),r.close();let i=[],s=0;for(;;){let{done:o,value:g}=await n.read();if(o)break;i.push(g),s+=g.length}let u=new Uint8Array(s),a=0;for(let o of i)u.set(o,a),a+=o.length;return u}var c=(e,t)=>e[t]|e[t+1]<<8,l=(e,t)=>(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0,N=(e,t)=>(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0;function I(e,t){if(!e||e.length===0)return null;for(let r of e)if(t>=r.startMs&&t<r.endMs)return r;return e[e.length-1]}function h(e,t={}){let r=e._;if(!r)throw new Error("Pngine destroyed");if(!r.ready)throw new Error("Not initialized");let n=t.time??r.time,i=t.frame??null;if(i===null&&r.animation&&r.animation.scenes.length>0){let s=I(r.animation.scenes,n*1e3);s&&(i=s.frame,s!==r.currentScene&&(r.currentScene=s,r.currentFrame=s.frame))}r.worker.postMessage({type:"draw",time:n,frame:i,uniforms:t.uniforms??null}),t.time!==void 0&&(r.time=t.time)}function W(e){let t=e._;if(!t||t.playing)return e;t.playing=!0,t.startTime=performance.now()-t.time*1e3;let r=()=>{if(!t.playing)return;let n=performance.now(),i=(n-t.startTime)/1e3;if(t.animation){let s=t.animation.duration/1e3;if(i>=s)switch(t.animation.endBehavior){case"loop":case"restart":t.startTime=n,i=0;break;case"stop":t.playing=!1,t.time=s,h(e,{time:s});return;case"hold":default:i=s;break}let u=I(t.animation.scenes,i*1e3);u&&u!==t.currentScene&&(t.currentScene=u,t.currentFrame=u.frame)}t.time=i,h(e,{time:t.time,frame:t.currentFrame}),t.animationId=requestAnimationFrame(r)};return t.animationId=requestAnimationFrame(r),e}function v(e){let t=e._;return!t||!t.playing||(t.playing=!1,t.time=(performance.now()-t.startTime)/1e3,t.animationId&&(cancelAnimationFrame(t.animationId),t.animationId=null)),e}function $(e){v(e);let t=e._;return t&&(t.time=0,t.startTime=performance.now(),h(e,{time:0})),e}function Y(e,t){let r=e._;return r&&(r.time=t,r.playing&&(r.startTime=performance.now()-t*1e3),h(e,{time:t})),e}function k(e,t){let r=e._;return r&&(r.currentFrame=t,h(e,{time:r.time,frame:t})),e}function V(e,t,r,n=!0){let i=e._;return i&&(i.uniforms||(i.uniforms={}),i.uniforms[t]=r,n&&h(e,{time:i.time,uniforms:{[t]:r}})),e}function X(e,t,r=!0){let n=e._;return n&&(n.uniforms||(n.uniforms={}),Object.assign(n.uniforms,t),r&&h(e,{time:n.time,uniforms:t})),e}async function z(e,t={}){let r,n;if(typeof e=="string")if(e.startsWith("#")||e.startsWith(".")&&!e.startsWith("./")&&!e.startsWith("..")){let o=document.querySelector(e);if(!o)throw new Error(`Element not found: ${e}`);if(o instanceof HTMLImageElement)({canvas:r,bytecode:n}=await A(o,t));else throw o instanceof HTMLCanvasElement?(r=o,new Error("Canvas source requires URL or data")):new Error("Invalid element type")}else{if(r=t.canvas,!r)throw new Error("Canvas required for URL source");let o=await fetch(e);if(!o.ok)throw new Error(`Fetch failed: ${o.status}`);n=await R(await o.arrayBuffer())}else if(e instanceof HTMLImageElement)({canvas:r,bytecode:n}=await A(e,t));else if(e instanceof ArrayBuffer||e instanceof Uint8Array||e instanceof Blob){if(r=t.canvas,!r)throw new Error("Canvas required for data source");let a=e instanceof Blob?await e.arrayBuffer():e;n=await R(a)}else throw new Error("Invalid source type");let i=r.transferControlToOffscreen(),s=new Worker(B()),u=await new Promise((a,o)=>{let g=setTimeout(()=>o(new Error("Worker init timeout")),15e3);s.onmessage=f=>{f.data.type==="ready"?(clearTimeout(g),a(f.data)):f.data.type==="error"&&(clearTimeout(g),o(new Error(f.data.message)))},s.onerror=f=>{clearTimeout(g),o(new Error(f.message||"Worker error"))};let d=t.wasmUrl?new URL(t.wasmUrl,window.location.href).href:new URL("pngine.wasm",import.meta.url).href;s.postMessage({type:"init",canvas:i,bytecode:n,wasmUrl:d,debug:t.debug||!1},[i,n.buffer])});return s.onmessage=a=>{a.data.type==="error"&&t.onError&&t.onError(new Error(a.data.message))},O({canvas:r,worker:s,width:u.width,height:u.height,frameCount:u.frameCount,animation:u.animation||null,currentScene:null,currentFrame:null,ready:!0,playing:!1,time:0,startTime:0,animationId:null})}async function A(e,t){e.complete||await new Promise((a,o)=>{e.onload=a,e.onerror=o});let{naturalWidth:r,naturalHeight:n}=e;if(r===0||n===0)throw new Error("Image has no dimensions");let i=t.canvas||document.createElement("canvas");if(i.width=r,i.height=n,!t.canvas){let a=e.parentElement;a&&getComputedStyle(a).position==="static"&&(a.style.position="relative"),Object.assign(i.style,{position:"absolute",top:e.offsetTop+"px",left:e.offsetLeft+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px",pointerEvents:"none"}),a&&a.appendChild(i)}let s=await fetch(e.src);if(!s.ok)throw new Error(`Failed to fetch image: ${s.status}`);let u=await R(await s.arrayBuffer());return{canvas:i,bytecode:u}}function O(e){return{get width(){return e.width},get height(){return e.height},get isPlaying(){return e.playing},get time(){return e.time},get frameCount(){return e.frameCount},get animation(){return e.animation},get currentScene(){return e.currentScene},get currentFrame(){return e.currentFrame},get duration(){return e.animation?e.animation.duration/1e3:0},_:e}}function q(e){let t=e._;return t&&(t.animationId&&cancelAnimationFrame(t.animationId),t.worker.postMessage({type:"destroy"}),t.worker.terminate(),e._=null),e}export{q as destroy,D as detectFormat,h as draw,R as extractBytecode,P as isPng,S as isPngb,C as isZip,v as pause,W as play,z as pngine,Y as seek,k as setFrame,V as setUniform,X as setUniforms,$ as stop};
