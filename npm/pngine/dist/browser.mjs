var T='var Le={0:"rgba8unorm",1:"rgba8snorm",2:"rgba8uint",3:"rgba8sint",4:"bgra8unorm",5:"rgba16float",6:"rgba32float",16:"depth24plus",17:"depth24plus-stencil8",18:"depth32float",32:"r32float",33:"rg32float"},Se=r=>Le[r]??navigator.gpu.getPreferredCanvasFormat(),K=["nearest","linear"],ae=r=>K[r]??"linear",Q=["clamp-to-edge","repeat","mirror-repeat"],ie=r=>Q[r]??"clamp-to-edge",Ce=0,Me=1,Ne=2,Oe=3,Re=4,Fe=5,Ve=6,ze=7,ke=8,We=9,je=10,qe=11,He=12,Ye=13;var Xe=1111969360;function ue(r){let l=new DataView(r.buffer,r.byteOffset,r.byteLength);if(l.getUint32(0,!0)!==Xe)return{uniforms:new Map,strings:[]};let c=l.getUint32(20,!0),g=l.getUint32(32,!0),d=Je(r,c),u=new Map;if(g===0||g>=r.length)return{uniforms:u,strings:d};let m=g,y=l.getUint16(m,!0);m+=2;for(let f=0;f<y&&m+8<=r.length;f++){let b=l.getUint16(m,!0);m+=2,m+=4;let G=l.getUint16(m,!0);m+=2;for(let D=0;D<G&&m+10<=r.length;D++){m+=2;let B=l.getUint16(m,!0);m+=2;let w=l.getUint16(m,!0);m+=2;let p=l.getUint16(m,!0);m+=2;let N=l.getUint8(m);m+=2;let S=d[B]||`field_${B}`;u.set(S,{bufferId:b,offset:w,size:p,type:N})}}return{uniforms:u,strings:d}}function Je(r,l){if(l===0||l>=r.length-2)return[];let c=new DataView(r.buffer,r.byteOffset,r.byteLength),g=new TextDecoder,d=[],u=c.getUint16(l,!0);if(u===0)return d;let m=l+2,y=m+u*2,f=y+u*2;if(f>r.length)return d;for(let b=0;b<u;b++){let G=c.getUint16(m+b*2,!0),D=c.getUint16(y+b*2,!0),B=f+G;B+D<=r.length?d.push(g.decode(r.subarray(B,B+D))):d.push(`string_${b}`)}return d}function v(r,l){let c=null,g=0,d=0,u=0,m=null,y=null,f=!1,b=[],G=[],D=[],B=[],w=[],p=[],N=[],S=[],te=[],Y=[],q=[],X=[],re=[],ne=[];function k(o,t){return t===0?"":new TextDecoder().decode(new Uint8Array(c.buffer,o,t))}let de=Se;function xe(o,t,e){b[o]||(f&&console.log(`[GPU] createBuffer(${o}, ${t}, 0x${e.toString(16)})`),b[o]=r.createBuffer({size:t,usage:e||GPUBufferUsage.COPY_DST}))}function be(o,t,e){if(w[o])return;if(f&&console.log(`[GPU] createShader(${o}, ${e}b)`),e===0){f&&console.warn(`[GPU] createShader(${o}) skipped: len=0`);return}let n=k(t,e);f&&console.log(`[GPU]   code:\n${n}`);let s=r.createShaderModule({code:n});s.getCompilationInfo().then(i=>{for(let a of i.messages)a.type==="error"&&(console.error(`[GPU] Shader ${o} error at line ${a.lineNum}:${a.linePos}: ${a.message}`),console.error(`[GPU] Context: ${n.split(`\n`).slice(Math.max(0,a.lineNum-3),a.lineNum+2).join(`\n`)}`))}),w[o]=s}function he(o,t,e){if(p[o])return;if(e===0){f&&console.warn(`[GPU] createRenderPipeline(${o}) skipped: len=0`);return}let n=JSON.parse(k(t,e)),s=navigator.gpu.getPreferredCanvasFormat();f&&console.log(`[GPU] createRenderPipeline(${o}) desc=`,JSON.stringify(n));let i=n.fragment?.targetFormat;(!i||i==="preferredCanvasFormat")&&(i=s),f&&console.log(`[GPU]   targetFormat: ${i}`);let a=[{format:i}],U=r.createRenderPipeline({layout:"auto",vertex:{module:w[n.vertex?.shader??0],entryPoint:n.vertex?.entryPoint??"vs_main",buffers:n.vertex?.buffers??[]},fragment:{module:w[n.fragment?.shader??n.vertex?.shader??0],entryPoint:n.fragment?.entryPoint??"fs_main",targets:a},primitive:n.primitive??{topology:"triangle-list"},depthStencil:n.depthStencil});p[o]=U,S[o]=U.getBindGroupLayout(0)}function ye(o,t,e){if(p[o])return;if(e<4){f&&console.warn(`[GPU] createComputePipeline(${o}) skipped: len=${e}`);return}let n=new Uint8Array(c.buffer,t,e),i=new DataView(n.buffer,n.byteOffset,n.byteLength).getUint16(1,!0),a=n[3],U=a>0?new TextDecoder().decode(n.slice(4,4+a)):"main";f&&console.log(`[GPU] createComputePipeline(${o}) shader=${i} entry=${U}`);let x=r.createComputePipeline({layout:"auto",compute:{module:w[i]??w[0],entryPoint:U}});p[o]=x,S[o]=x.getBindGroupLayout(0)}function Ge(o,t,e){if(G[o])return;if(e===0){f&&console.warn(`[GPU] createTexture(${o}) skipped: len=0`);return}let n=new Uint8Array(c.buffer,t,e),s=new DataView(n.buffer,n.byteOffset,n.byteLength),i=2,a={size:[d||512,u||512],format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:1},U=n[1];for(let x=0;x<U;x++){let E=n[i++],P=n[i++];if(P===0){let _=s.getUint32(i,!0);i+=4,E===1?a.size[0]=_:E===2?a.size[1]=_:E===5&&(a.sampleCount=_)}else if(P===7){let _=n[i++];E===7?a.format=de(_):E===8&&(a.usage=_||GPUTextureUsage.RENDER_ATTACHMENT)}}ne[o]={format:a.format,usage:a.usage},f&&console.log(`[GPU] createTexture(${o}) ${a.size[0]}x${a.size[1]} ${a.format} usage=0x${a.usage.toString(16)}`),G[o]=r.createTexture(a)}function Ee(o,t,e){if(B[o])return;if(e===0){f&&console.warn(`[GPU] createSampler(${o}) skipped: len=0`);return}let n=new Uint8Array(c.buffer,t,e),s=2,i={magFilter:K[1],minFilter:K[1],addressModeU:Q[0],addressModeV:Q[0]},a=n[1];for(let U=0;U<a;U++){let x=n[s++];if(n[s++]===7){let P=n[s++];x===4?i.magFilter=ae(P):x===5?i.minFilter=ae(P):x===1?i.addressModeU=ie(P):x===2&&(i.addressModeV=ie(P))}}f&&console.log(`[GPU] createSampler(${o}) ${i.magFilter}/${i.minFilter}`),B[o]=r.createSampler(i)}function $e(o,t,e,n){if(N[o])return;if(n===0){f&&console.warn(`[GPU] createBindGroup(${o}) skipped: len=0`);return}let s=new Uint8Array(c.buffer,e,n),i=new DataView(s.buffer,s.byteOffset,s.byteLength),a=2,U=0,x=[],E=s[1];for(let h=0;h<E;h++){let A=s[a++],C=s[a++];if(A===1&&C===7)U=s[a++];else if(A===2&&C===3){let O=s[a++];for(let R=0;R<O;R++){let _e=s[a++],se=s[a++],Ie=i.getUint16(a,!0);a+=2;let Z={binding:_e,rt:se,rid:Ie};se===0&&(Z.offset=i.getUint32(a,!0),a+=4,Z.size=i.getUint32(a,!0),a+=4),x.push(Z)}}}re[o]={layoutId:t,gi:U,entries:x},f&&console.log(`[GPU] createBindGroup(${o}) layoutId=${t} entries=[${x.map(h=>`{b=${h.binding} rt=${h.rt} rid=${h.rid}}`).join(",")}]`);let P=p[t];if(!P)return;let _=x.map(h=>{let A={binding:h.binding};return h.rt===0?(A.resource={buffer:b[h.rid]},h.offset&&(A.resource.offset=h.offset),h.size&&(A.resource.size=h.size)):h.rt===1?(A.resource=G[h.rid]?.createView(),f&&console.log(`[GPU]   bindGroup entry b=${h.binding}: tex[${h.rid}]=${G[h.rid]?"exists":"MISSING"} view=${A.resource?"valid":"NULL"}`)):h.rt===2&&(A.resource=B[h.rid]),A});N[o]=r.createBindGroup({layout:P.getBindGroupLayout(U),entries:_})}function Pe(o,t,e,n){m||(m=r.createCommandEncoder());let s=65534,i;if(o===s){let U=l.getCurrentTexture();f&&console.log(`[GPU]   canvasTex: ${U?.width}x${U?.height} ${U?.format}`),i=U.createView()}else i=G[o]?.createView();f&&console.log(`[GPU] beginRenderPass colorId=${o===s?"CANVAS":o} loadOp=${t} storeOp=${e} depthId=${n}`),f&&console.log(`[GPU]   tex[${o}]=${G[o]?"exists":"MISSING"} view=${i?"valid":"NULL"}`);let a={colorAttachments:[{view:i,loadOp:t===1?"clear":"load",storeOp:e===0?"store":"discard",clearValue:{r:0,g:0,b:0,a:0}}]};n!==65535&&G[n]&&(a.depthStencilAttachment={view:G[n].createView(),depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1}),y=m.beginRenderPass(a)}function De(){m||(m=r.createCommandEncoder()),y=m.beginComputePass()}function we(o,t,e){switch(o){case 1:return xe(t.getUint16(e,!0),t.getUint32(e+2,!0),t.getUint8(e+6)),e+7;case 2:return Ge(t.getUint16(e,!0),t.getUint32(e+2,!0),t.getUint32(e+6,!0)),e+10;case 3:return Ee(t.getUint16(e,!0),t.getUint32(e+2,!0),t.getUint32(e+6,!0)),e+10;case 4:return be(t.getUint16(e,!0),t.getUint32(e+2,!0),t.getUint32(e+6,!0)),e+10;case 5:return he(t.getUint16(e,!0),t.getUint32(e+2,!0),t.getUint32(e+6,!0)),e+10;case 6:return ye(t.getUint16(e,!0),t.getUint32(e+2,!0),t.getUint32(e+6,!0)),e+10;case 7:return $e(t.getUint16(e,!0),t.getUint16(e+2,!0),t.getUint32(e+4,!0),t.getUint32(e+8,!0)),e+12;case 8:{let n=t.getUint16(e,!0),s=t.getUint16(e+2,!0);return!D[n]&&G[s]&&(D[n]=G[s].createView()),e+12}case 9:return e+10;case 10:{let n=t.getUint16(e,!0),s=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return S[n]||(S[n]=r.createBindGroupLayout(JSON.parse(k(s,i)))),e+10}case 11:{let n=t.getUint16(e,!0),s=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);if(i===0)return e+10;let a=new Blob([new Uint8Array(c.buffer,s,i)]);return createImageBitmap(a).then(U=>(Y[n]=U,e+10))}case 12:{let n=t.getUint16(e,!0),s=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=JSON.parse(k(s,i));return te[n]=r.createPipelineLayout({bindGroupLayouts:a.bindGroupLayouts.map(U=>S[U])}),e+10}case 13:return e+10;case 16:return Pe(t.getUint16(e,!0),t.getUint8(e+2),t.getUint8(e+3),t.getUint16(e+4,!0)),e+6;case 17:return De(),e;case 18:{let n=t.getUint16(e,!0);return f&&console.log(`[GPU] setPipeline(${n})`),y?.setPipeline(p[n]),e+2}case 19:{let n=t.getUint8(e),s=t.getUint16(e+1,!0);return f&&console.log(`[GPU] setBindGroup(${n}, ${s}) pass=${y?"valid":"NULL"} bg[${s}]=${N[s]?"exists":"MISSING"}`),y?.setBindGroup(n,N[s]),e+3}case 20:return y?.setVertexBuffer(t.getUint8(e),b[t.getUint16(e+1,!0)]),e+3;case 21:{let n=t.getUint32(e,!0),s=t.getUint32(e+4,!0);return f&&console.log(`[GPU] draw(${n}, ${s}) pass=${y?"valid":"NULL"}`),y?.draw(n,s,t.getUint32(e+8,!0),t.getUint32(e+12,!0)),e+16}case 22:return y?.drawIndexed(t.getUint32(e,!0),t.getUint32(e+4,!0),t.getUint32(e+8,!0),t.getInt32(e+12,!0),t.getUint32(e+16,!0)),e+20;case 23:return f&&console.log("[GPU] endPass"),y?.end(),y=null,e;case 24:return y?.dispatchWorkgroups(t.getUint32(e,!0),t.getUint32(e+4,!0),t.getUint32(e+8,!0)),e+12;case 25:return y?.setIndexBuffer(b[t.getUint16(e,!0)],t.getUint8(e+2)===1?"uint32":"uint16"),e+3;case 26:{let n=t.getUint8(e);return e+1+n*2}case 32:{let n=t.getUint16(e,!0),s=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0);return f&&console.log(`[GPU] write_buffer: id=${n}, offset=${s}, dataPtr=${i}, dataLen=${a}`),b[n]&&a>0&&r.queue.writeBuffer(b[n],s,new Uint8Array(c.buffer,i,a)),e+14}case 33:{let n=t.getUint16(e,!0),s=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0);if(f&&console.log(`[GPU] writeTimeUniform buf[${n}] time=${g} cw=${d} ch=${u}`),b[n]){let a=new Float32Array([g,d,u,d/(u||1)]);r.queue.writeBuffer(b[n],s,new Uint8Array(a.buffer,0,Math.min(i,16)))}return e+8}case 34:{let n=t.getUint16(e,!0),s=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0),a=t.getUint32(e+8,!0),U=t.getUint32(e+12,!0);return m||(m=r.createCommandEncoder()),m.copyBufferToBuffer(b[n],s,b[i],a,U),e+16}case 35:{let n=t.getUint16(e,!0),s=t.getUint16(e+2,!0),i=t.getUint16(e+4,!0),a=t.getUint16(e+6,!0);return m||(m=r.createCommandEncoder()),m.copyTextureToTexture({texture:G[n]},{texture:G[s]},[i,a]),e+8}case 36:{let n=t.getUint16(e,!0),s=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0),U=X[i];if(f&&console.log(`[GPU] write_buffer_from_wasm: bid=${n}, off=${s}, callId=${i}, sz=${a}, cr=`,U),b[n]&&U&&a>0){let x=q[U.mid],E=x?.inst?.exports?.memory?.buffer||x?.importedMem?.buffer;f&&console.log(`[GPU] write_buffer_from_wasm: mod=${!!x}, wasmMem=${!!E}, result=${U.result}, memSize=${E?.byteLength}`),E&&U.result!=null&&U.result+a<=E.byteLength?r.queue.writeBuffer(b[n],s,new Uint8Array(E,U.result,a)):f&&console.warn(`[GPU] write_buffer_from_wasm: invalid params - result=${U.result}, sz=${a}, memSize=${E?.byteLength}`)}return e+14}case 37:{let n=t.getUint16(e,!0),s=t.getUint16(e+2,!0),i=t.getUint8(e+4),a=t.getUint16(e+5,!0),U=t.getUint16(e+7,!0),x=Y[n];return x&&G[s]&&r.queue.copyExternalImageToTexture({source:x},{texture:G[s],mipLevel:i,origin:[a,U]},[x.width,x.height]),e+9}case 48:{let n=t.getUint16(e,!0),s=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);if(f&&console.log(`[GPU] init_wasm_module: id=${n}, ptr=${s}, len=${i}`),i===0)return e+10;let a=new Uint8Array(c.buffer,s,i).slice(),U=new WebAssembly.Memory({initial:1}),x={env:{abort:()=>{throw new Error("WASM abort")},memory:U}};return WebAssembly.compile(a).then(E=>WebAssembly.instantiate(E,x).then(P=>(q[n]={inst:P,importedMem:U},f&&console.log(`[GPU] init_wasm_module done: id=${n}, exports=`,Object.keys(P.exports)),e+10)))}case 49:{let n=t.getUint16(e,!0),s=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0),U=t.getUint8(e+12),x=new Uint8Array(c.buffer,e+13,U).slice(),E=k(i,a);f&&console.log(`[GPU] call_wasm_func: cid=${n}, mid=${s}, name="${E}", ac=${U}`);let{inst:P}=q[s]||{},_=P?.exports[E],h=[],A=new DataView(x.buffer,x.byteOffset,x.byteLength);for(let C=0,O=0;C<U/5|0;C++){let R=x[O++];R===0?h.push(A.getFloat32(O,!0)):R===1?h.push(A.getInt32(O,!0)):R===2&&h.push(A.getUint32(O,!0)),O+=4}if(_){let C=_(...h);X[n]={mid:s,result:C},f&&console.log(`[GPU] call_wasm_func result: cid=${n}, result=${C}`)}else f&&console.log(`[GPU] call_wasm_func: fn not found! mid=${s}, name="${E}"`);return e+13+U}case 240:return f&&console.log(`[GPU] submit enc=${!!m}`),m&&(r.queue.submit([m.finish()]),m=null),e;case 255:return e;default:return console.warn(`Unknown cmd: 0x${o.toString(16)}`),e}}async function Ae(o){let t=new DataView(c.buffer),e=t.getUint32(o,!0),n=t.getUint16(o+4,!0);f&&console.log(`[GPU] Execute: ${n} cmds, ${e}b`);let s=o+8,i=o+e;for(let a=0;a<n&&s<i;a++){let U=t.getUint8(s++),x=we(U,t,s);x instanceof Promise?(s=await x,t=new DataView(c.buffer)):s=x}}function Be(){b.forEach(o=>o?.destroy?.()),G.forEach(o=>o?.destroy?.()),b.length=G.length=D.length=B.length=w.length=p.length=0,N.length=S.length=te.length=Y.length=q.length=0,X.length=re.length=ne.length=0}let J=null;function pe(o){J=o,f&&console.log(`[GPU] setUniformTable: ${o.size} uniforms`)}function oe(o,t){if(!J)return!1;let e=J.get(o);if(!e)return f&&console.warn(`[GPU] setUniform: unknown uniform \'${o}\'`),!1;let n=b[e.bufferId];if(!n)return f&&console.warn(`[GPU] setUniform: buffer ${e.bufferId} not found`),!1;let s=Ze(t,e.type,e.size);return s?(r.queue.writeBuffer(n,e.offset,s),f&&console.log(`[GPU] setUniform: ${o} = ${Array.isArray(t)?`[${t.join(",")}]`:t} @ buffer[${e.bufferId}]+${e.offset}`),!0):(f&&console.warn(`[GPU] setUniform: failed to convert value for \'${o}\'`),!1)}function Te(o){let t=0;for(let[e,n]of Object.entries(o))oe(e,n)&&t++;return t}return{setDebug(o){f=o},setMemory(o){c=o},setTime(o){g=o},setCanvasSize(o,t){d=o,u=t},setUniformTable:pe,setUniform:oe,setUniforms:Te,execute:Ae,destroy:Be}}function Ze(r,l,c){let g=Array.isArray(r)?r:[r];switch(l){case Ce:case Oe:case Re:case Fe:{let u=new Float32Array(g);return new Uint8Array(u.buffer,0,Math.min(u.byteLength,c))}case Me:case ke:case We:case je:{let u=new Int32Array(g);return new Uint8Array(u.buffer,0,Math.min(u.byteLength,c))}case Ne:case qe:case He:case Ye:{let u=new Uint32Array(g);return new Uint8Array(u.buffer,0,Math.min(u.byteLength,c))}case Ve:{let u=new Float32Array(12);return g.length>=9&&(u[0]=g[0],u[1]=g[3],u[2]=g[6],u[3]=0,u[4]=g[1],u[5]=g[4],u[6]=g[7],u[7]=0,u[8]=g[2],u[9]=g[5],u[10]=g[8],u[11]=0),new Uint8Array(u.buffer,0,Math.min(48,c))}case ze:{let u=new Float32Array(g.length>=16?g:[...g,...Array(16-g.length).fill(0)]);return new Uint8Array(u.buffer,0,Math.min(64,c))}default:let d=new Float32Array(g);return new Uint8Array(d.buffer,0,Math.min(d.byteLength,c))}}var Ke=[80,78,71,66],ce=0,fe=40,Qe=1,ve=2,et=1,tt=2,rt=4,nt=8,ot=16,st=32;function le(r){if(r.length<fe)throw new Error("Invalid PNGB: too short");if(!Ke.every((g,d)=>r[d]===g))throw new Error("Invalid PNGB: bad magic");let l=new DataView(r.buffer,r.byteOffset,r.byteLength),c=l.getUint16(4,!0);if(c!==ce)throw new Error(`Unsupported PNGB version: ${c}`);return at(r,l)}function at(r,l){let c=l.getUint16(6,!0),g=r[8],d=l.getUint32(12,!0),u=l.getUint32(16,!0),m=l.getUint32(20,!0),y=l.getUint32(24,!0),f=l.getUint32(28,!0),b=l.getUint32(32,!0),G=l.getUint32(36,!0),D=(c&Qe)!==0,B=(c&ve)!==0,w=D?d+u:fe,p=m-w;return{version:ce,hasEmbeddedExecutor:D,hasAnimationTable:B,plugins:it(g),executor:D?r.subarray(d,d+u):null,bytecode:r.subarray(w,w+p),payload:r,offsets:{executor:D?d:0,executorLength:u,bytecode:w,bytecodeLength:p,stringTable:m,data:y,wgsl:f,uniform:b,animation:G}}}function it(r){return{core:(r&et)!==0,render:(r&tt)!==0,compute:(r&rt)!==0,wasm:(r&nt)!==0,animation:(r&ot)!==0,texture:(r&st)!==0}}function ge(r={}){return{env:{log:r.log||((l,c)=>{}),wasmInstantiate:r.wasmInstantiate||((l,c,g)=>{}),wasmCall:r.wasmCall||((l,c,g,d,u,m)=>{}),wasmGetResult:r.wasmGetResult||((l,c,g)=>0)}}}var T,M,H,$,L,W,z=!1,F=!1,ee=0,j=!1,V=null,I={INIT:"init",DRAW:"draw",LOAD:"load",DESTROY:"destroy",SET_UNIFORM:"setUniform",GET_UNIFORMS:"getUniforms",READY:"ready",ERROR:"error",UNIFORMS:"uniforms"};onmessage=async r=>{let{type:l,...c}=r.data;try{switch(l){case I.INIT:await ut(c);break;case I.DRAW:ft(c);break;case I.LOAD:await ct(c);break;case I.DESTROY:lt();break;case I.SET_UNIFORM:gt(c);break;case I.GET_UNIFORMS:mt();break;default:throw new Error(`Unknown message: ${l}`)}}catch(g){postMessage({type:I.ERROR,message:g.message})}};async function ut(r){if(z)throw new Error("Already initialized");T=r.canvas,j=r.debug;let l=await navigator.gpu?.requestAdapter();if(!l)throw new Error("WebGPU not supported");M=await l.requestDevice(),M.onuncapturederror=u=>{console.error("[Worker] WebGPU uncaptured error:",u.error.message)},H=T.getContext("webgpu");let c=navigator.gpu.getPreferredCanvasFormat();H.configure({device:M,format:c,alphaMode:"premultiplied"}),$=v(M,H),$.setDebug(j),$.setCanvasSize(T.width,T.height);let g=!1,d=null;if(r.bytecode)try{let u=new Uint8Array(r.bytecode);d=le(u),g=d.hasEmbeddedExecutor}catch(u){r.debug&&console.log("[Worker] Bytecode parse failed, using shared executor:",u.message)}if(g&&d.executor){r.debug&&console.log("[Worker] Using embedded executor from payload");let u=ge({log:(y,f)=>{if(r.debug){let b=new TextDecoder().decode(new Uint8Array(W.buffer,y,f));console.log("[Executor]",b)}}}),{instance:m}=await WebAssembly.instantiate(d.executor,u);L=m.exports,W=L.memory,$.setMemory(W),z=!0,await me(d.payload)}else throw new Error("No embedded executor in payload. Use a PNG with embedded executor, or build with --shared flag.");postMessage({type:I.READY,width:T.width,height:T.height,frameCount:ee})}async function ct(r){if(!z)throw new Error("Not initialized");await me(r.bytecode),postMessage({type:I.READY,frameCount:ee})}async function me(r){F&&($.destroy(),$=v(M,H),$.setDebug(j),$.setMemory(W),$.setCanvasSize(T.width,T.height),F=!1,V=null);let l=L.getBytecodePtr(),c=r instanceof Uint8Array?r:new Uint8Array(r);new Uint8Array(W.buffer,l,c.length).set(c),L.setBytecodeLen(c.length);let{uniforms:g}=ue(c);V=g,j&&g.size>0&&console.log(`[Worker] Parsed ${g.size} uniform fields:`,[...g.keys()]);let d=L.init();if(d!==0)throw new Error(`Init failed: ${d}`);let u=L.getCommandPtr(),m=L.getCommandLen();u&&m>0&&await $.execute(u),$.setUniformTable(V),F=!0,ee=1,Ue(0,T.width,T.height)}function Ue(r,l,c){$.setTime(r);let g=L.frame(r,l,c);if(g!==0){console.warn("[Worker] frame() returned non-zero:",g);return}let d=L.getCommandPtr(),u=L.getCommandLen();!d||u===0||$.execute(d)}function ft(r){if(!(!z||!F)){if(r.uniforms&&typeof r.uniforms=="object"){let l=$.setUniforms(r.uniforms);j&&l>0&&console.log(`[Worker] Set ${l} uniforms`)}Ue(r.time??0,T.width,T.height)}}function lt(){F=!1,V=null,$?.destroy(),M&&(M.destroy(),M=null),z=!1}function gt(r){!z||!F||(r.uniforms&&typeof r.uniforms=="object"?$.setUniforms(r.uniforms):r.name!==void 0&&r.value!==void 0&&$.setUniform(r.name,r.value))}function mt(){if(!V){postMessage({type:I.UNIFORMS,uniforms:{}});return}let r={};for(let[l,c]of V)r[l]={type:c.type,size:c.size,bufferId:c.bufferId,offset:c.offset};postMessage({type:I.UNIFORMS,uniforms:r})}\n';function S(){let e=new Blob([T],{type:"application/javascript"});return URL.createObjectURL(e)}var _=[137,80,78,71,13,10,26,10],b=[112,78,71,98],G=e=>e.length>=8&&_.every((t,n)=>e[n]===t),N=e=>e.length>=4&&e[0]===80&&e[1]===75&&(e[2]===3||e[2]===5),O=e=>e.length>=4&&e[0]===80&&e[1]===78&&e[2]===71&&e[3]===66;function C(e){return N(e)?"zip":G(e)?"png":O(e)?"pngb":null}async function $(e){let t=e instanceof Uint8Array?e:new Uint8Array(e),n=C(t);if(n==="pngb")return t;if(n==="png")return M(t);if(n==="zip")return D(t);throw new Error("Unknown format")}async function M(e){if(!G(e))throw new Error("Invalid PNG");let t=8;for(;t+12<=e.length;){let n=k(e,t),r=e.subarray(t+4,t+8);if(r[0]===b[0]&&r[1]===b[1]&&r[2]===b[2]&&r[3]===b[3]){let o=e.subarray(t+8,t+8+n);return B(o)}t+=12+n}throw new Error("No pNGb chunk found")}async function B(e){if(e.length<2)throw new Error("Invalid pNGb chunk");let t=e[0],n=e[1],r=e.subarray(2);if(t!==1)throw new Error(`Unsupported pNGb version: ${t}`);return n&1?A(r):new Uint8Array(r)}async function D(e){let t=-1;for(let a=22;a<=Math.min(e.length,65557);a++){let s=e.length-a;if(g(e,s)===101010256){t=s;break}}if(t===-1)throw new Error("Invalid ZIP");let n=l(e,t+10),r=g(e,t+16),o=null,i=null;for(let a=0;a<n&&g(e,r)===33639248;a++){let s=l(e,r+10),u=g(e,r+20),c=g(e,r+24),m=l(e,r+28),f=l(e,r+30),h=l(e,r+32),d=g(e,r+42),U=new TextDecoder().decode(e.subarray(r+46,r+46+m)),y=l(e,d+28),x=d+30+m+y,p={name:U,compression:s,compSize:u,uncompSize:c,dataOff:x};U==="manifest.json"?o=p:U.endsWith(".pngb")&&!i&&(i=p),r+=46+m+f+h}if(o){let a=JSON.parse(new TextDecoder().decode(await P(e,o)));if(a.entry){r=g(e,t+16);for(let s=0;s<n&&g(e,r)===33639248;s++){let u=l(e,r+28);if(new TextDecoder().decode(e.subarray(r+46,r+46+u))===a.entry){let m=l(e,r+10),f=g(e,r+20),h=g(e,r+24),d=l(e,r+30),U=l(e,r+32),y=g(e,r+42),x=l(e,y+28),p=y+30+u+x;return P(e,{compression:m,compSize:f,uncompSize:h,dataOff:p})}r+=46+u+l(e,r+30)+l(e,r+32)}}}if(i)return P(e,i);throw new Error("No bytecode found in ZIP")}async function P(e,t){let n=e.subarray(t.dataOff,t.dataOff+t.compSize);if(t.compression===0)return new Uint8Array(n);if(t.compression===8)return A(n);throw new Error(`Unsupported compression: ${t.compression}`)}async function A(e){let t=new DecompressionStream("deflate-raw"),n=t.writable.getWriter(),r=t.readable.getReader();n.write(e),n.close();let o=[],i=0;for(;;){let{done:u,value:c}=await r.read();if(u)break;o.push(c),i+=c.length}let a=new Uint8Array(i),s=0;for(let u of o)a.set(u,s),s+=u.length;return a}var l=(e,t)=>e[t]|e[t+1]<<8,g=(e,t)=>(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0,k=(e,t)=>(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0,R=[80,78,71,66],I=0,L=40,F=1,z=2,W=1,V=2,q=4,j=8,H=16,Y=32;function Q(e){if(e.length<L)throw new Error("Invalid PNGB: too short");if(!R.every((r,o)=>e[o]===r))throw new Error("Invalid PNGB: bad magic");let t=new DataView(e.buffer,e.byteOffset,e.byteLength),n=t.getUint16(4,!0);if(n!==I)throw new Error(`Unsupported PNGB version: ${n}`);return J(e,t)}function J(e,t){let n=t.getUint16(6,!0),r=e[8],o=t.getUint32(12,!0),i=t.getUint32(16,!0),a=t.getUint32(20,!0),s=t.getUint32(24,!0),u=t.getUint32(28,!0),c=t.getUint32(32,!0),m=t.getUint32(36,!0),f=(n&F)!==0,h=(n&z)!==0,d=f?o+i:L,U=a-d;return{version:I,hasEmbeddedExecutor:f,hasAnimationTable:h,plugins:Z(r),executor:f?e.subarray(o,o+i):null,bytecode:e.subarray(d,d+U),payload:e,offsets:{executor:f?o:0,executorLength:i,bytecode:d,bytecodeLength:U,stringTable:a,data:s,wgsl:u,uniform:c,animation:m}}}function Z(e){return{core:(e&W)!==0,render:(e&V)!==0,compute:(e&q)!==0,wasm:(e&j)!==0,animation:(e&H)!==0,texture:(e&Y)!==0}}function ee(e={}){return{env:{log:e.log||((t,n)=>{}),wasmInstantiate:e.wasmInstantiate||((t,n,r)=>{}),wasmCall:e.wasmCall||((t,n,r,o,i,a)=>{}),wasmGetResult:e.wasmGetResult||((t,n,r)=>0)}}}async function te(e,t={}){let{instance:n}=await WebAssembly.instantiate(e,t),r=n.exports,o=r.memory;return{instance:n,memory:o,exports:r,getBytecodePtr(){return r.getBytecodePtr?.()||0},setBytecodeLen(i){r.setBytecodeLen?.(i)},getDataPtr(){return r.getDataPtr?.()||0},setDataLen(i){r.setDataLen?.(i)},init(){r.init?.()},frame(i,a,s){r.frame?.(i,a,s)},getCommandPtr(){return r.getCommandPtr?.()||0},getCommandLen(){return r.getCommandLen?.()||0}}}function v(e,t){if(!e||e.length===0)return null;for(let n of e)if(t>=n.startMs&&t<n.endMs)return n;return e[e.length-1]}function w(e,t={}){let n=e._;if(!n)throw new Error("Pngine destroyed");if(!n.ready)throw new Error("Not initialized");let r=t.time??n.time,o=t.frame??null;if(o===null&&n.animation&&n.animation.scenes.length>0){let i=v(n.animation.scenes,r*1e3);i&&(o=i.frame,i!==n.currentScene&&(n.currentScene=i,n.currentFrame=i.frame))}n.worker.postMessage({type:"draw",time:r,frame:o,uniforms:t.uniforms??null}),t.time!==void 0&&(n.time=t.time)}function ne(e){let t=e._;if(!t||t.playing)return e;t.playing=!0,t.startTime=performance.now()-t.time*1e3;let n=()=>{if(!t.playing)return;let r=performance.now(),o=(r-t.startTime)/1e3;if(t.animation){let i=t.animation.duration/1e3;if(o>=i)switch(t.animation.endBehavior){case"loop":case"restart":t.startTime=r,o=0;break;case"stop":t.playing=!1,t.time=i,w(e,{time:i});return;case"hold":default:o=i;break}let a=v(t.animation.scenes,o*1e3);a&&a!==t.currentScene&&(t.currentScene=a,t.currentFrame=a.frame)}t.time=o,w(e,{time:t.time,frame:t.currentFrame}),t.animationId=requestAnimationFrame(n)};return t.animationId=requestAnimationFrame(n),e}function K(e){let t=e._;return!t||!t.playing||(t.playing=!1,t.time=(performance.now()-t.startTime)/1e3,t.animationId&&(cancelAnimationFrame(t.animationId),t.animationId=null)),e}function re(e){K(e);let t=e._;return t&&(t.time=0,t.startTime=performance.now(),w(e,{time:0})),e}function oe(e,t){let n=e._;return n&&(n.time=t,n.playing&&(n.startTime=performance.now()-t*1e3),w(e,{time:t})),e}function ie(e,t){let n=e._;return n&&(n.currentFrame=t,w(e,{time:n.time,frame:t})),e}function ae(e,t,n,r=!0){let o=e._;return o&&(o.uniforms||(o.uniforms={}),o.uniforms[t]=n,r&&w(e,{time:o.time,uniforms:{[t]:n}})),e}function se(e,t,n=!0){let r=e._;return r&&(r.uniforms||(r.uniforms={}),Object.assign(r.uniforms,t),n&&w(e,{time:r.time,uniforms:t})),e}async function ue(e,t={}){let n,r;if(typeof e=="string")if(e.startsWith("#")||e.startsWith(".")&&!e.startsWith("./")&&!e.startsWith("..")){let u=document.querySelector(e);if(!u)throw new Error(`Element not found: ${e}`);if(u instanceof HTMLImageElement)({canvas:n,bytecode:r}=await E(u,t));else throw u instanceof HTMLCanvasElement?(n=u,new Error("Canvas source requires URL or data")):new Error("Invalid element type")}else{if(n=t.canvas,!n)throw new Error("Canvas required for URL source");let u=await fetch(e);if(!u.ok)throw new Error(`Fetch failed: ${u.status}`);r=await $(await u.arrayBuffer())}else if(e instanceof HTMLImageElement)({canvas:n,bytecode:r}=await E(e,t));else if(e instanceof ArrayBuffer||e instanceof Uint8Array||e instanceof Blob){if(n=t.canvas,!n)throw new Error("Canvas required for data source");let s=e instanceof Blob?await e.arrayBuffer():e;r=await $(s)}else throw new Error("Invalid source type");let o=n.transferControlToOffscreen(),i=new Worker(S()),a=await new Promise((s,u)=>{let c=setTimeout(()=>u(new Error("Worker init timeout")),15e3);i.onmessage=f=>{f.data.type==="ready"?(clearTimeout(c),s(f.data)):f.data.type==="error"&&(clearTimeout(c),u(new Error(f.data.message)))},i.onerror=f=>{clearTimeout(c),u(new Error(f.message||"Worker error"))};let m=t.wasmUrl?new URL(t.wasmUrl,window.location.href).href:new URL("pngine.wasm",import.meta.url).href;i.postMessage({type:"init",canvas:o,bytecode:r,wasmUrl:m,debug:t.debug||!1},[o,r.buffer])});return i.onmessage=s=>{s.data.type==="error"&&t.onError&&t.onError(new Error(s.data.message))},X({canvas:n,worker:i,width:a.width,height:a.height,frameCount:a.frameCount,animation:a.animation||null,currentScene:null,currentFrame:null,ready:!0,playing:!1,time:0,startTime:0,animationId:null})}async function E(e,t){e.complete||await new Promise((s,u)=>{e.onload=s,e.onerror=u});let{naturalWidth:n,naturalHeight:r}=e;if(n===0||r===0)throw new Error("Image has no dimensions");let o=t.canvas||document.createElement("canvas");if(o.width=n,o.height=r,!t.canvas){let s=e.parentElement;s&&getComputedStyle(s).position==="static"&&(s.style.position="relative"),Object.assign(o.style,{position:"absolute",top:e.offsetTop+"px",left:e.offsetLeft+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px",pointerEvents:"none"}),s&&s.appendChild(o)}let i=await fetch(e.src);if(!i.ok)throw new Error(`Failed to fetch image: ${i.status}`);let a=await $(await i.arrayBuffer());return{canvas:o,bytecode:a}}function X(e){return{get width(){return e.width},get height(){return e.height},get isPlaying(){return e.playing},get time(){return e.time},get frameCount(){return e.frameCount},get animation(){return e.animation},get currentScene(){return e.currentScene},get currentFrame(){return e.currentFrame},get duration(){return e.animation?e.animation.duration/1e3:0},_:e}}function fe(e){let t=e._;return t&&(t.animationId&&cancelAnimationFrame(t.animationId),t.worker.postMessage({type:"destroy"}),t.worker.terminate(),e._=null),e}export{te as createExecutor,fe as destroy,C as detectFormat,w as draw,$ as extractBytecode,ee as getExecutorImports,G as isPng,O as isPngb,N as isZip,Q as parsePayload,K as pause,ne as play,ue as pngine,oe as seek,ie as setFrame,ae as setUniform,se as setUniforms,re as stop};
