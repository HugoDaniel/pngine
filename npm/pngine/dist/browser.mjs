var F='var d={CREATE_BUFFER:1,CREATE_TEXTURE:2,CREATE_SAMPLER:3,CREATE_SHADER:4,CREATE_RENDER_PIPELINE:5,CREATE_COMPUTE_PIPELINE:6,CREATE_BIND_GROUP:7,CREATE_TEXTURE_VIEW:8,CREATE_QUERY_SET:9,CREATE_BIND_GROUP_LAYOUT:10,CREATE_IMAGE_BITMAP:11,CREATE_PIPELINE_LAYOUT:12,CREATE_RENDER_BUNDLE:13,BEGIN_RENDER_PASS:16,BEGIN_COMPUTE_PASS:17,SET_PIPELINE:18,SET_BIND_GROUP:19,SET_VERTEX_BUFFER:20,DRAW:21,DRAW_INDEXED:22,END_PASS:23,DISPATCH:24,SET_INDEX_BUFFER:25,EXECUTE_BUNDLES:26,WRITE_BUFFER:32,WRITE_TIME_UNIFORM:33,COPY_BUFFER_TO_BUFFER:34,COPY_TEXTURE_TO_TEXTURE:35,WRITE_BUFFER_FROM_WASM:36,COPY_EXTERNAL_IMAGE_TO_TEXTURE:37,INIT_WASM_MODULE:48,CALL_WASM_FUNC:49,CREATE_TYPED_ARRAY:64,FILL_RANDOM:65,FILL_EXPRESSION:66,FILL_CONSTANT:67,WRITE_BUFFER_FROM_ARRAY:68,SUBMIT:240,END:255},p={MAP_READ:1,MAP_WRITE:2,COPY_SRC:4,COPY_DST:8,INDEX:16,VERTEX:32,UNIFORM:64,STORAGE:128},B=class{constructor(r,t){this.device=r,this.context=t,this.memory=null,this.debug=!1,this.buffers=new Map,this.textures=new Map,this.textureViews=new Map,this.samplers=new Map,this.shaders=new Map,this.pipelines=new Map,this.bindGroups=new Map,this.bindGroupLayouts=new Map,this.pipelineLayouts=new Map,this.querySets=new Map,this.renderBundles=new Map,this.imageBitmaps=new Map,this.wasmModules=new Map,this.wasmCallResults=new Map,this.typedArrays=new Map,this.bindGroupDescriptors=new Map,this.textureDescriptors=new Map,this.encoder=null,this.pass=null,this.time=0,this.canvasWidth=0,this.canvasHeight=0}setDebug(r){this.debug=r}setMemory(r){this.memory=r}setTime(r){this.time=r}setCanvasSize(r,t){this.canvasWidth=r,this.canvasHeight=t}async execute(r){let t=new DataView(this.memory.buffer),e=t.getUint32(r,!0),s=t.getUint16(r+4,!0);this.debug&&console.log(`[GPU] Execute: ${s} commands, ${e} bytes`);let n=r+8,i=r+e;for(let a=0;a<s&&n<i;a++){let u=t.getUint8(n++);this.debug&&console.log(`[GPU] Cmd ${a}: 0x${u.toString(16)}`);let c=this._dispatch(u,t,n);c instanceof Promise?(n=await c,t=new DataView(this.memory.buffer)):n=c}}_dispatch(r,t,e){switch(r){case d.CREATE_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint8(e+6);return this._createBuffer(s,n,i),e+7}case d.CREATE_SHADER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createShader(s,n,i),e+10}case d.CREATE_RENDER_PIPELINE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createRenderPipeline(s,n,i),e+10}case d.CREATE_COMPUTE_PIPELINE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createComputePipeline(s,n,i),e+10}case d.CREATE_BIND_GROUP:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0);return this._createBindGroup(s,n,i,a),e+12}case d.CREATE_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createTexture(s,n,i),e+10}case d.CREATE_SAMPLER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createSampler(s,n,i),e+10}case d.CREATE_TEXTURE_VIEW:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0);return this._createTextureView(s,n,i,a),e+12}case d.CREATE_QUERY_SET:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createQuerySet(s,n,i),e+10}case d.CREATE_BIND_GROUP_LAYOUT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createBindGroupLayout(s,n,i),e+10}case d.CREATE_PIPELINE_LAYOUT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createPipelineLayout(s,n,i),e+10}case d.CREATE_RENDER_BUNDLE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createRenderBundle(s,n,i),e+10}case d.BEGIN_RENDER_PASS:{let s=t.getUint16(e,!0),n=t.getUint8(e+2),i=t.getUint8(e+3),a=t.getUint16(e+4,!0);return this._beginRenderPass(s,n,i,a),e+6}case d.BEGIN_COMPUTE_PASS:return this._beginComputePass(),e;case d.SET_PIPELINE:{let s=t.getUint16(e,!0);return this.pass?.setPipeline(this.pipelines.get(s)),e+2}case d.SET_BIND_GROUP:{let s=t.getUint8(e),n=t.getUint16(e+1,!0);return this.pass?.setBindGroup(s,this.bindGroups.get(n)),e+3}case d.SET_VERTEX_BUFFER:{let s=t.getUint8(e),n=t.getUint16(e+1,!0);return this.pass?.setVertexBuffer(s,this.buffers.get(n)),e+3}case d.SET_INDEX_BUFFER:{let s=t.getUint16(e,!0),i=t.getUint8(e+2)===1?"uint32":"uint16";return this.pass?.setIndexBuffer(this.buffers.get(s),i),e+3}case d.EXECUTE_BUNDLES:{let s=t.getUint8(e),n=[];for(let i=0;i<s;i++){let a=t.getUint16(e+1+i*2,!0),u=this.renderBundles.get(a);u&&n.push(u)}return this.pass?.executeBundles(n),e+1+s*2}case d.DRAW:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0),a=t.getUint32(e+12,!0);return this.debug&&console.log(`[GPU] draw(vtx=${s}, inst=${n}, firstVtx=${i}, firstInst=${a})`),this.pass?.draw(s,n,i,a),e+16}case d.DRAW_INDEXED:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0),a=t.getInt32(e+12,!0),u=t.getUint32(e+16,!0);return this.pass?.drawIndexed(s,n,i,a,u),e+20}case d.DISPATCH:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0);return this.debug&&console.log(`[GPU] dispatch(${s}, ${n}, ${i})`),this.pass?.dispatchWorkgroups(s,n,i),e+12}case d.END_PASS:return this.pass?.end(),this.pass=null,e;case d.WRITE_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0);return this._writeBuffer(s,n,i,a),e+14}case d.WRITE_TIME_UNIFORM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0);return this._writeTimeUniform(s,n,i),e+8}case d.CREATE_IMAGE_BITMAP:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createImageBitmap(s,n,i),e+10}case d.COPY_EXTERNAL_IMAGE_TO_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint8(e+4),a=t.getUint16(e+5,!0),u=t.getUint16(e+7,!0),c=e+9;return this._copyExternalImageToTexture(s,n,i,a,u).then(()=>c)}case d.COPY_BUFFER_TO_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0),a=t.getUint32(e+8,!0),u=t.getUint32(e+12,!0);return this._copyBufferToBuffer(s,n,i,a,u),e+16}case d.COPY_TEXTURE_TO_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint16(e+4,!0),a=t.getUint16(e+6,!0);return this._copyTextureToTexture(s,n,i,a),e+8}case d.WRITE_BUFFER_FROM_WASM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0);return this._writeBufferFromWasm(s,n,i,a),e+14}case d.INIT_WASM_MODULE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._initWasmModule(s,n,i),e+10}case d.CALL_WASM_FUNC:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0),u=t.getUint32(e+12,!0),c=t.getUint32(e+16,!0),l=e+20;return this._callWasmFunc(s,n,i,a,u,c).then(()=>l)}case d.CREATE_TYPED_ARRAY:{let s=t.getUint16(e,!0),n=t.getUint8(e+2),i=t.getUint32(e+3,!0);return this._createTypedArray(s,n,i),e+7}case d.FILL_RANDOM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0);return this._fillRandom(s,n,i,a,u),e+15}case d.FILL_EXPRESSION:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0),c=t.getUint16(e+15,!0);return this._fillExpression(s,n,i,a,u,c),e+17}case d.FILL_CONSTANT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0);return this._fillConstant(s,n,i,a,u),e+15}case d.WRITE_BUFFER_FROM_ARRAY:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0);return this._writeBufferFromArray(s,n,i),e+8}case d.SUBMIT:return this.encoder&&(this.device.queue.submit([this.encoder.finish()]),this.encoder=null),e;case d.END:return e;default:return console.warn(`Unknown command: 0x${r.toString(16)}`),e}}_createBuffer(r,t,e){if(this.buffers.has(r))return;let s=this._translateUsage(e);this.buffers.set(r,this.device.createBuffer({size:t,usage:s}))}_translateUsage(r){let t=0;return r&p.MAP_READ&&(t|=GPUBufferUsage.MAP_READ),r&p.MAP_WRITE&&(t|=GPUBufferUsage.MAP_WRITE),r&p.COPY_SRC&&(t|=GPUBufferUsage.COPY_SRC),r&p.COPY_DST&&(t|=GPUBufferUsage.COPY_DST),r&p.INDEX&&(t|=GPUBufferUsage.INDEX),r&p.VERTEX&&(t|=GPUBufferUsage.VERTEX),r&p.UNIFORM&&(t|=GPUBufferUsage.UNIFORM),r&p.STORAGE&&(t|=GPUBufferUsage.STORAGE),t||GPUBufferUsage.COPY_DST}_createShader(r,t,e){if(this.shaders.has(r))return;let s=this._readString(t,e);this.shaders.set(r,this.device.createShaderModule({code:s}))}_createRenderPipeline(r,t,e){if(this.pipelines.has(r))return;let s=this._readString(t,e);if(!s||s.length===0){console.error(`[GPU] Empty pipeline descriptor for id=${r}, ptr=${t}, len=${e}`);return}let n=JSON.parse(s),i=this._buildRenderPipeline(n);this.pipelines.set(r,i),this.bindGroupLayouts.set(r,i.getBindGroupLayout(0))}_buildRenderPipeline(r){let t=navigator.gpu.getPreferredCanvasFormat();return this.device.createRenderPipeline({layout:"auto",vertex:{module:this.shaders.get(r.vertex?.shader??0),entryPoint:r.vertex?.entryPoint??"vs_main",buffers:r.vertex?.buffers??[]},fragment:{module:this.shaders.get(r.fragment?.shader??r.vertex?.shader??0),entryPoint:r.fragment?.entryPoint??"fs_main",targets:[{format:t}]},primitive:r.primitive??{topology:"triangle-list"},depthStencil:r.depthStencil})}_createComputePipeline(r,t,e){if(this.pipelines.has(r))return;let s=this._readString(t,e);if(!s||s.length===0){console.error(`[GPU] Empty compute pipeline descriptor for id=${r}, ptr=${t}, len=${e}`);return}let n=JSON.parse(s),i="auto";n.layout&&n.layout!=="auto"&&(i=this.pipelineLayouts.get(n.layout)??"auto");let a=this.device.createComputePipeline({layout:i,compute:{module:this.shaders.get(n.compute?.shader??0),entryPoint:n.compute?.entryPoint??"main"}});this.pipelines.set(r,a),i==="auto"&&this.bindGroupLayouts.set(r,a.getBindGroupLayout(0))}_createBindGroup(r,t,e,s){if(this.bindGroups.has(r))return;let n=new Uint8Array(this.memory.buffer,e,s),i=this._decodeBindGroupDescriptor(n);i.layoutId=t,this.bindGroupDescriptors.set(r,i);let a=this.pipelines.get(t);if(!a){console.error(`[GPU] Pipeline ${t} not found for bind group ${r}`);return}let u=i.entries.map(c=>{let l={binding:c.binding};if(c.resourceType===0){let g={buffer:this.buffers.get(c.resourceId)};c.offset&&(g.offset=c.offset),c.size&&(g.size=c.size),l.resource=g}else c.resourceType===1?l.resource=this.textures.get(c.resourceId)?.createView():c.resourceType===2&&(l.resource=this.samplers.get(c.resourceId));return l});this.bindGroups.set(r,this.device.createBindGroup({layout:a.getBindGroupLayout(i.groupIndex),entries:u}))}_decodeBindGroupDescriptor(r){let t=new DataView(r.buffer,r.byteOffset,r.byteLength),e=0,s=r[e++];if(s!==3)return console.error(`[GPU] Invalid bind group descriptor type tag: ${s}`),{groupIndex:0,entries:[]};let n=r[e++],i=0,a=[],u=1,c=2,l=3,g=7;for(let h=0;h<n;h++){let E=r[e++],_=r[e++];if(E===u&&_===g)i=r[e++];else if(E===c&&_===l){let S=r[e++];for(let L=0;L<S;L++){let x=r[e++],R=r[e++],y=t.getUint16(e,!0);e+=2;let G={binding:x,resourceType:R,resourceId:y};R===0&&(G.offset=t.getUint32(e,!0),e+=4,G.size=t.getUint32(e,!0),e+=4),a.push(G)}}}return{groupIndex:i,entries:a}}_createTexture(r,t,e){if(this.textures.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=this._decodeTextureDescriptor(s);this.textureDescriptors.set(r,{format:n.format,usage:n.usage}),this.textures.set(r,this.device.createTexture(n))}_createSampler(r,t,e){if(this.samplers.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=this._decodeSamplerDescriptor(s);this.samplers.set(r,this.device.createSampler(n))}_decodeTextureDescriptor(r){let t=new DataView(r.buffer,r.byteOffset,r.byteLength),e=0,s=r[e++];if(s!==1)return console.error(`[GPU] Invalid texture descriptor type tag: ${s}`),{size:[256,256],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT};let n=r[e++],i={size:[this.canvasWidth||512,this.canvasHeight||512],format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:1},a=1,u=2,c=5,l=7,g=8,h=10,E=0,_=6,S=7;for(let L=0;L<n;L++){let x=r[e++],R=r[e++];if(R===E){let y=t.getUint32(e,!0);e+=4,x===a?i.size[0]=y:x===u?i.size[1]=y:x===c&&(i.sampleCount=y)}else if(R===_){let y=t.getUint16(e,!0);e+=2,x===h&&(i.size=[1,1],i.imageBitmapId=y)}else if(R===S){let y=r[e++];x===l?i.format=this._decodeTextureFormat(y):x===g&&(i.usage=this._decodeTextureUsage(y))}}return i}_decodeSamplerDescriptor(r){let t=0,e=r[t++];if(e!==2)return console.error(`[GPU] Invalid sampler descriptor type tag: ${e}`),{};let s=r[t++],n={magFilter:"linear",minFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},i=1,a=2,u=4,c=5,l=7;for(let g=0;g<s;g++){let h=r[t++];if(r[t++]===l){let _=r[t++];h===u?n.magFilter=_===0?"nearest":"linear":h===c?n.minFilter=_===0?"nearest":"linear":h===i?n.addressModeU=["clamp-to-edge","repeat","mirror-repeat"][_]||"clamp-to-edge":h===a&&(n.addressModeV=["clamp-to-edge","repeat","mirror-repeat"][_]||"clamp-to-edge")}}return n}_decodeTextureFormat(r){return{0:"rgba8unorm",1:"rgba8snorm",2:"rgba8uint",3:"rgba8sint",4:"bgra8unorm",5:"rgba16float",6:"rgba32float",16:"depth24plus",17:"depth24plus-stencil8",18:"depth32float"}[r]||navigator.gpu.getPreferredCanvasFormat()}_decodeTextureUsage(r){let t=0;return r&1&&(t|=GPUTextureUsage.COPY_SRC),r&2&&(t|=GPUTextureUsage.COPY_DST),r&4&&(t|=GPUTextureUsage.TEXTURE_BINDING),r&8&&(t|=GPUTextureUsage.STORAGE_BINDING),r&16&&(t|=GPUTextureUsage.RENDER_ATTACHMENT),t||GPUTextureUsage.RENDER_ATTACHMENT}_beginRenderPass(r,t,e,s){this.encoder||(this.encoder=this.device.createCommandEncoder());let c={colorAttachments:[{view:r===65534?this.context.getCurrentTexture().createView():this.textures.get(r)?.createView(),loadOp:t===1?"clear":"load",storeOp:e===0?"store":"discard",clearValue:{r:0,g:0,b:0,a:1}}]};if(s!==65535){let l=this.textures.get(s)?.createView();l&&(c.depthStencilAttachment={view:l,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1})}this.pass=this.encoder.beginRenderPass(c)}_beginComputePass(){this.encoder||(this.encoder=this.device.createCommandEncoder()),this.pass=this.encoder.beginComputePass()}_writeBuffer(r,t,e,s){let n=this.buffers.get(r);if(!n)return;let i=new Uint8Array(this.memory.buffer,e,s);this.device.queue.writeBuffer(n,t,i)}_writeTimeUniform(r,t,e){let s=this.buffers.get(r);if(!s)return;let n=new Float32Array([this.time,this.canvasWidth,this.canvasHeight,this.canvasWidth/(this.canvasHeight||1)]),i=new Uint8Array(n.buffer,0,Math.min(e,16));this.device.queue.writeBuffer(s,t,i)}_readString(r,t){let e=new Uint8Array(this.memory.buffer,r,t);return new TextDecoder().decode(e)}_createImageBitmap(r,t,e){if(this.imageBitmaps.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=s[0],i=s.slice(1,1+n),a=new TextDecoder().decode(i),u=s.slice(1+n),c=new Blob([u],{type:a}),l=globalThis.createImageBitmap(c);this.imageBitmaps.set(r,l)}async _copyExternalImageToTexture(r,t,e,s,n){let i=this.imageBitmaps.get(r);if(!i){console.error(`[GPU] ImageBitmap ${r} not found`);return}i instanceof Promise&&(i=await i,this.imageBitmaps.set(r,i));let a=this.textures.get(t);if(!a){console.error(`[GPU] Texture ${t} not found`);return}if(a.width!==i.width||a.height!==i.height){a.destroy();let u=this.textureDescriptors.get(t)||{format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};a=this.device.createTexture({size:[i.width,i.height],format:u.format,usage:u.usage}),this.textures.set(t,a),this._recreateBindGroupsForTexture(t)}this.device.queue.copyExternalImageToTexture({source:i},{texture:a,mipLevel:e,origin:{x:s,y:n}},{width:i.width,height:i.height})}_recreateBindGroupsForTexture(r){for(let[t,e]of this.bindGroupDescriptors.entries())e.entries.some(n=>n.resourceType===1&&n.resourceId===r)&&(this.bindGroups.delete(t),this._recreateBindGroup(t,e))}_recreateBindGroup(r,t){let e=this.pipelines.get(t.layoutId);if(!e)return;let s=t.entries.map(n=>{let i={binding:n.binding};if(n.resourceType===0){let a={buffer:this.buffers.get(n.resourceId)};n.offset&&(a.offset=n.offset),n.size&&(a.size=n.size),i.resource=a}else n.resourceType===1?i.resource=this.textures.get(n.resourceId)?.createView():n.resourceType===2&&(i.resource=this.samplers.get(n.resourceId));return i});this.bindGroups.set(r,this.device.createBindGroup({layout:e.getBindGroupLayout(t.groupIndex),entries:s}))}_createTextureView(r,t,e,s){if(this.textureViews.has(r))return;let n=this.textures.get(t);n&&this.textureViews.set(r,n.createView())}_createQuerySet(r,t,e){this.querySets.has(r)}_createBindGroupLayout(r,t,e){this.bindGroupLayouts.has(r)}_createPipelineLayout(r,t,e){this.pipelineLayouts.has(r)}_createRenderBundle(r,t,e){this.renderBundles.has(r)}_copyBufferToBuffer(r,t,e,s,n){let i=this.buffers.get(r),a=this.buffers.get(e);if(!i||!a)return;let u=this.encoder||this.device.createCommandEncoder();u.copyBufferToBuffer(i,t,a,s,n),this.encoder||this.device.queue.submit([u.finish()])}_copyTextureToTexture(r,t,e,s){let n=this.textures.get(r),i=this.textures.get(t);if(!n||!i)return;let a=this.encoder||this.device.createCommandEncoder();a.copyTextureToTexture({texture:n},{texture:i},{width:e,height:s}),this.encoder||this.device.queue.submit([a.finish()])}_writeBufferFromWasm(r,t,e,s){let n=this.buffers.get(r);if(!n)return;let i=this.wasmCallResults.get(e);if(i){this.debug&&console.log(`[GPU] writeBufferFromWasm from call result ${e}`);let{memory:u,resultValue:c}=i;if(typeof c=="number"&&u){let l=new Uint8Array(u.buffer,c,s);this.device.queue.writeBuffer(n,t,l)}else if(typeof c=="number"){let l=new Float32Array([c]);this.device.queue.writeBuffer(n,t,new Uint8Array(l.buffer,0,Math.min(s,4)))}this.wasmCallResults.delete(e);return}let a=new Uint8Array(this.memory.buffer,e,s);this.device.queue.writeBuffer(n,t,a)}_initWasmModule(r,t,e){if(this.wasmModules.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e).slice();this.debug&&console.log(`[GPU] initWasmModule(id=${r}, size=${e})`);let n={env:{}},i=WebAssembly.instantiate(s,n).then(a=>{let u=a.instance,c=u.exports.memory;return this.debug&&console.log(`[GPU] WASM module ${r} loaded, exports:`,Object.keys(u.exports)),{instance:u,memory:c}}).catch(a=>(console.error(`[GPU] Failed to load WASM module ${r}:`,a),null));this.wasmModules.set(r,i)}async _callWasmFunc(r,t,e,s,n,i){let a=this._readString(e,s);this.debug&&console.log(`[GPU] callWasmFunc(callId=${r}, moduleId=${t}, func="${a}")`);let u=this.wasmModules.get(t);if(!u){console.error(`[GPU] WASM module ${t} not found`);return}if(u instanceof Promise){if(u=await u,!u)return;this.wasmModules.set(t,u)}let{instance:c,memory:l}=u,g=c.exports[a];if(!g){console.error(`[GPU] WASM function "${a}" not found in module ${t}`);return}let h=this._decodeWasmArgs(n,i);this.debug&&console.log("[GPU]   args:",h);let E=g(...h);this.debug&&console.log("[GPU]   result:",E),E!==void 0&&l&&this.wasmCallResults.set(r,{moduleId:t,memory:l,resultValue:E})}_decodeWasmArgs(r,t){if(t===0)return[];let e=new Uint8Array(this.memory.buffer,r,t),s=new DataView(e.buffer,e.byteOffset,e.byteLength),n=[],i=0,a=e[i++];for(let u=0;u<a&&i<t;u++){let c=e[i++];switch(c){case 0:n.push(s.getFloat32(i,!0)),i+=4;break;case 1:n.push(this.canvasWidth);break;case 2:n.push(this.canvasHeight);break;case 3:n.push(this.time);break;case 4:n.push(s.getInt32(i,!0)),i+=4;break;case 5:n.push(s.getUint32(i,!0)),i+=4;break;case 6:n.push(1/60);break;default:console.warn(`[GPU] Unknown WASM arg type: 0x${c.toString(16)}`)}}return n}_createTypedArray(r,t,e){if(this.typedArrays.has(r))return;let n=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t]||Float32Array,i=new n(e);this.debug&&console.log(`[GPU] createTypedArray(id=${r}, type=${t}/${n.name}, size=${e}, byteLength=${i.byteLength})`),this.typedArrays.set(r,i)}_fillRandom(r,t,e,s,n){let i=this.typedArrays.get(r);if(!i){console.error(`[GPU] fillRandom: array ${r} not found`);return}let a=new Float32Array(this.memory.buffer,n,e);this.debug&&console.log(`[GPU] fillRandom(array=${r}, offset=${t}, count=${e}, stride=${s}, dataPtr=${n})`);for(let u=0;u<e;u++){let c=t+u*s;c<i.length&&(i[c]=a[u])}}_fillExpression(r,t,e,s,n,i){let a=this.typedArrays.get(r);if(!a){console.error(`[GPU] fillExpression: array ${r} not found`);return}let u=this._readString(n,i);if(this.debug&&console.log(`[GPU] fillExpression(array=${r}, offset=${t}, count=${e}, stride=${s}, expr="${u}")`),!!u)try{let c=u.replace(/NUM_PARTICLES/g,String(e)).replace(/PI/g,"Math.PI").replace(/random\\(\\)/g,"Math.random()").replace(/sin\\(/g,"Math.sin(").replace(/cos\\(/g,"Math.cos(").replace(/sqrt\\(/g,"Math.sqrt(").replace(/ceil\\(/g,"Math.ceil(").replace(/floor\\(/g,"Math.floor(").replace(/abs\\(/g,"Math.abs("),l=new Function("ELEMENT_ID",`return ${c};`);for(let g=0;g<e;g++){let h=g*s+t;a[h]=l(g)}}catch(c){console.error(`[GPU] Error evaluating expression "${u}":`,c)}}_fillConstant(r,t,e,s,n){let i=this.typedArrays.get(r);if(!i)return;let u=new Float32Array(this.memory.buffer,n,1)[0];for(let c=0;c<e;c++){let l=c*s+t;i[l]=u}}_writeBufferFromArray(r,t,e){let s=this.typedArrays.get(e),n=this.buffers.get(r);if(!s||!n){console.error(`[GPU] writeBufferFromArray: missing array ${e} or buffer ${r}`);return}if(this.debug){console.log(`[GPU] writeBufferFromArray(buffer=${r}, offset=${t}, array=${e}, type=${s.constructor.name}, byteLen=${s.byteLength})`);let i=s instanceof Float32Array?s:new Float32Array(s.buffer,s.byteOffset,Math.min(8,s.byteLength/4));console.log(`[GPU]   first values: [${Array.from(i.slice(0,8)).join(", ")}]`)}this.device.queue.writeBuffer(n,t,s)}destroy(){for(let r of this.buffers.values())r.destroy?.();for(let r of this.textures.values())r.destroy?.();for(let r of this.imageBitmaps.values())r instanceof ImageBitmap&&r.close?.();this.buffers.clear(),this.textures.clear(),this.textureViews.clear(),this.samplers.clear(),this.shaders.clear(),this.pipelines.clear(),this.bindGroups.clear(),this.bindGroupLayouts.clear(),this.pipelineLayouts.clear(),this.querySets.clear(),this.renderBundles.clear(),this.imageBitmaps.clear(),this.wasmModules.clear(),this.wasmCallResults.clear(),this.typedArrays.clear(),this.bindGroupDescriptors.clear(),this.textureDescriptors.clear()}};var q=[80,78,71,66],M=5,W=4,k=40,$=28,j=1,Q=2,Z=1,J=2,K=4,v=8,ee=16,te=32;function N(o){if(o.length<$)throw new Error("Invalid PNGB: too short");if(!q.every((e,s)=>o[s]===e))throw new Error("Invalid PNGB: bad magic");let r=new DataView(o.buffer,o.byteOffset,o.byteLength),t=r.getUint16(4,!0);if(t!==M&&t!==W)throw new Error(`Unsupported PNGB version: ${t}`);return t===M?re(o,r):ne(o,r)}function re(o,r){let t=r.getUint16(6,!0),e=o[8],s=r.getUint32(12,!0),n=r.getUint32(16,!0),i=r.getUint32(20,!0),a=r.getUint32(24,!0),u=r.getUint32(28,!0),c=r.getUint32(32,!0),l=r.getUint32(36,!0),g=(t&j)!==0,h=(t&Q)!==0,E=g?s+n:k,_=i-E;return{version:M,hasEmbeddedExecutor:g,hasAnimationTable:h,plugins:se(e),executor:g?o.subarray(s,s+n):null,bytecode:o.subarray(E,E+_),payload:o,offsets:{executor:g?s:0,executorLength:n,bytecode:E,bytecodeLength:_,stringTable:i,data:a,wgsl:u,uniform:c,animation:l}}}function ne(o,r){let t=r.getUint32(8,!0),e=r.getUint32(12,!0),s=r.getUint32(16,!0),n=r.getUint32(20,!0),i=r.getUint32(24,!0),a=$,u=t-a;return{version:W,hasEmbeddedExecutor:!1,hasAnimationTable:!1,plugins:{core:!0,render:!1,compute:!1,wasm:!1,animation:!1,texture:!1},executor:null,bytecode:o.subarray(a,a+u),payload:o,offsets:{executor:0,executorLength:0,bytecode:a,bytecodeLength:u,stringTable:t,data:e,wgsl:s,uniform:n,animation:i}}}function se(o){return{core:(o&Z)!==0,render:(o&J)!==0,compute:(o&K)!==0,wasm:(o&v)!==0,animation:(o&ee)!==0,texture:(o&te)!==0}}function V(o={}){return{env:{log:o.log||((r,t)=>{}),wasmInstantiate:o.wasmInstantiate||((r,t,e)=>{}),wasmCall:o.wasmCall||((r,t,e,s,n,i)=>{}),wasmGetResult:o.wasmGetResult||((r,t,e)=>0)}}}var T,A,D,m,f,U,I=!1,b=!1,F=0,C=null,O=!1,P={INIT:"init",DRAW:"draw",LOAD:"load",DESTROY:"destroy",READY:"ready",ERROR:"error"};onmessage=async o=>{let{type:r,...t}=o.data;try{switch(r){case P.INIT:await ie(t);break;case P.DRAW:ue(t);break;case P.LOAD:await oe(t);break;case P.DESTROY:de();break;default:throw new Error(`Unknown message: ${r}`)}}catch(e){postMessage({type:P.ERROR,message:e.message})}};async function ie(o){if(I)throw new Error("Already initialized");T=o.canvas;let r=await navigator.gpu?.requestAdapter();if(!r)throw new Error("WebGPU not supported");A=await r.requestDevice(),D=T.getContext("webgpu");let t=navigator.gpu.getPreferredCanvasFormat();D.configure({device:A,format:t,alphaMode:"premultiplied"}),m=new B(A,D),m.setDebug(o.debug),m.setCanvasSize(T.width,T.height);let e=!1,s=null;if(o.bytecode)try{let n=new Uint8Array(o.bytecode);s=N(n),e=s.hasEmbeddedExecutor}catch(n){o.debug&&console.log("[Worker] Bytecode parse failed, using shared executor:",n.message)}if(e&&s.executor){o.debug&&console.log("[Worker] Using embedded executor from payload"),O=!0;let n=V({log:(a,u)=>{if(o.debug){let c=new TextDecoder().decode(new Uint8Array(U.buffer,a,u));console.log("[Executor]",c)}}}),{instance:i}=await WebAssembly.instantiate(s.executor,n);f=i.exports,U=f.memory,m.setMemory(U),f.init?f.init():f.onInit&&f.onInit(),I=!0,await z(s)}else{if(!o.wasmUrl)throw new Error("wasmUrl required (no embedded executor)");O=!1;let n=await fetch(o.wasmUrl);if(!n.ok)throw new Error(`Failed to fetch WASM: ${n.status}`);let{instance:i}=await WebAssembly.instantiateStreaming(n,le());f=i.exports,U=f.memory,m.setMemory(U),f.onInit(),I=!0,o.bytecode&&await X(o.bytecode)}postMessage({type:P.READY,width:T.width,height:T.height,frameCount:F,animation:C})}async function oe(o){if(!I)throw new Error("Not initialized");let r=null;try{let t=new Uint8Array(o.bytecode);r=N(t)}catch{}O&&r?await z(r):await X(o.bytecode),postMessage({type:P.READY,frameCount:F,animation:C})}async function X(o){if(b){let e=m.debug;f.freeModule(),m.destroy(),m=new B(A,D),m.setDebug(e),m.setMemory(U),m.setCanvasSize(T.width,T.height),b=!1,C=null}let r=f.alloc(o.byteLength);if(!r)throw new Error("Failed to allocate memory");new Uint8Array(U.buffer,r,o.byteLength).set(new Uint8Array(o));let t=f.loadModule(r,o.byteLength);if(f.free(r,o.byteLength),t!==0)throw new Error(`Load failed: ${t}`);b=!0,F=f.getFrameCount(),C=H(),w(0,0)}async function z(o){if(f.getBytecodePtr&&f.setBytecodeLen){let r=f.getBytecodePtr(),t=o.bytecode;new Uint8Array(U.buffer,r,t.length).set(t),f.setBytecodeLen(t.length)}if(f.alloc&&f.loadModule){let r=o.payload,t=f.alloc(r.byteLength);if(t){new Uint8Array(U.buffer,t,r.byteLength).set(r);let e=f.loadModule(t,r.byteLength);if(f.free(t,r.byteLength),e!==0)throw new Error(`Load failed: ${e}`)}}b=!0,f.getFrameCount?F=f.getFrameCount():F=1,C=H(),w(0,0)}function H(){if(!f.hasAnimationInfo())return null;let o=f.getAnimationDuration(),r=f.getAnimationLoop()===1,t=f.getAnimationEndBehavior(),e=f.getSceneCount(),s=ae(f.getAnimationName),n=[];for(let i=0;i<e;i++){let a=f.getSceneInfo(i);if(a===0xFFFFFFFFFFFFFFFFn)continue;let u=Number(a&0xFFFFFFFFn),c=Number(a>>32n&0xFFFFFFFFn),l=Y(f.getSceneId,i),g=Y(f.getSceneFrame,i);n.push({id:l,frame:g,startMs:u,endMs:c})}return{name:s,duration:o,loop:r,endBehavior:["hold","stop","restart"][t]||"hold",scenes:n}}function ae(o){let t=f.alloc(256);if(!t)return"";let e=o(t,256),s=e>0?new TextDecoder().decode(new Uint8Array(U.buffer,t,e)):"";return f.free(t,256),s}function Y(o,r){let e=f.alloc(256);if(!e)return"";let s=o(r,e,256),n=s>0?new TextDecoder().decode(new Uint8Array(U.buffer,e,s)):"";return f.free(e,256),n}function ue(o){!I||!b||(o.uniforms&&ce(o.uniforms),w(o.time??0,0))}function ce(o){let r=new TextEncoder;for(let[t,e]of Object.entries(o)){let s=r.encode(t),n=f.alloc(s.length);if(!n)continue;new Uint8Array(U.buffer,n,s.length).set(s);let i=fe(e);if(!i){f.free(n,s.length);continue}let a=f.alloc(i.length);if(!a){f.free(n,s.length);continue}new Uint8Array(U.buffer,a,i.length).set(i),f.setUniform(n,s.length,a,i.length),f.free(n,s.length),f.free(a,i.length)}}function fe(o){if(typeof o=="number")return new Uint8Array(new Float32Array([o]).buffer);if(Array.isArray(o)){let r=o.flat(2);if(r.length===2||r.length===3||r.length===4||r.length===9||r.length===16)return new Uint8Array(new Float32Array(r).buffer)}return null}function w(o,r){m.setTime(o);let t=f.renderFrame(o,r);t&&m.execute(t)}function de(){b&&(f.freeModule(),b=!1),m?.destroy(),A&&(A.destroy(),A=null),I=!1}function le(){let o=()=>{};return{env:{gpuCreateBuffer:o,gpuCreateTexture:o,gpuCreateSampler:o,gpuCreateShaderModule:o,gpuCreateRenderPipeline:o,gpuCreateComputePipeline:o,gpuCreateBindGroup:o,gpuCreateImageBitmap:o,gpuCreateTextureView:o,gpuCreateQuerySet:o,gpuCreateBindGroupLayout:o,gpuCreatePipelineLayout:o,gpuCreateRenderBundle:o,gpuBeginRenderPass:o,gpuBeginComputePass:o,gpuSetPipeline:o,gpuSetBindGroup:o,gpuSetVertexBuffer:o,gpuSetIndexBuffer:o,gpuDraw:o,gpuDrawIndexed:o,gpuDispatch:o,gpuExecuteBundles:o,gpuEndPass:o,gpuWriteBuffer:(r,t,e,s)=>{let n=m?.buffers?.get(r);if(!n)return;let i=new Uint8Array(U.buffer,e,s);A.queue.writeBuffer(n,t,i)},gpuSubmit:o,gpuCopyExternalImageToTexture:o,gpuInitWasmModule:o,gpuCallWasmFunc:o,gpuWriteBufferFromWasm:o,gpuCreateTypedArray:o,gpuFillRandomData:o,gpuFillExpression:o,gpuFillConstant:o,gpuWriteBufferFromArray:o,gpuWriteTimeUniform:o,gpuDebugLog:o,jsConsoleLog:o,jsConsoleLogInt:o}}}\n';function S(){let e=new Blob([F],{type:"application/javascript"});return URL.createObjectURL(e)}var L=[137,80,78,71,13,10,26,10],w=[112,78,71,98],R=e=>e.length>=8&&L.every((t,r)=>e[r]===t),G=e=>e.length>=4&&e[0]===80&&e[1]===75&&(e[2]===3||e[2]===5),M=e=>e.length>=4&&e[0]===80&&e[1]===78&&e[2]===71&&e[3]===66;function D(e){return G(e)?"zip":R(e)?"png":M(e)?"pngb":null}async function A(e){let t=e instanceof Uint8Array?e:new Uint8Array(e),r=D(t);if(r==="pngb")return t;if(r==="png")return N(t);if(r==="zip")return v(t);throw new Error("Unknown format")}async function N(e){if(!R(e))throw new Error("Invalid PNG");let t=8;for(;t+12<=e.length;){let r=W(e,t),n=e.subarray(t+4,t+8);if(n[0]===w[0]&&n[1]===w[1]&&n[2]===w[2]&&n[3]===w[3]){let i=e.subarray(t+8,t+8+r);return O(i)}t+=12+r}throw new Error("No pNGb chunk found")}async function O(e){if(e.length<2)throw new Error("Invalid pNGb chunk");let t=e[0],r=e[1],n=e.subarray(2);if(t!==1)throw new Error(`Unsupported pNGb version: ${t}`);return r&1?P(n):new Uint8Array(n)}async function v(e){let t=-1;for(let o=22;o<=Math.min(e.length,65557);o++){let a=e.length-o;if(d(e,a)===101010256){t=a;break}}if(t===-1)throw new Error("Invalid ZIP");let r=l(e,t+10),n=d(e,t+16),i=null,s=null;for(let o=0;o<r&&d(e,n)===33639248;o++){let a=l(e,n+10),u=d(e,n+20),f=d(e,n+24),g=l(e,n+28),c=l(e,n+30),U=l(e,n+32),h=d(e,n+42),m=new TextDecoder().decode(e.subarray(n+46,n+46+g)),E=l(e,h+28),_=h+30+g+E,y={name:m,compression:a,compSize:u,uncompSize:f,dataOff:_};m==="manifest.json"?i=y:m.endsWith(".pngb")&&!s&&(s=y),n+=46+g+c+U}if(i){let o=JSON.parse(new TextDecoder().decode(await T(e,i)));if(o.entry){n=d(e,t+16);for(let a=0;a<r&&d(e,n)===33639248;a++){let u=l(e,n+28);if(new TextDecoder().decode(e.subarray(n+46,n+46+u))===o.entry){let g=l(e,n+10),c=d(e,n+20),U=d(e,n+24),h=l(e,n+30),m=l(e,n+32),E=d(e,n+42),_=l(e,E+28),y=E+30+u+_;return T(e,{compression:g,compSize:c,uncompSize:U,dataOff:y})}n+=46+u+l(e,n+30)+l(e,n+32)}}}if(s)return T(e,s);throw new Error("No bytecode found in ZIP")}async function T(e,t){let r=e.subarray(t.dataOff,t.dataOff+t.compSize);if(t.compression===0)return new Uint8Array(r);if(t.compression===8)return P(r);throw new Error(`Unsupported compression: ${t.compression}`)}async function P(e){let t=new DecompressionStream("deflate-raw"),r=t.writable.getWriter(),n=t.readable.getReader();r.write(e),r.close();let i=[],s=0;for(;;){let{done:u,value:f}=await n.read();if(u)break;i.push(f),s+=f.length}let o=new Uint8Array(s),a=0;for(let u of i)o.set(u,a),a+=u.length;return o}var l=(e,t)=>e[t]|e[t+1]<<8,d=(e,t)=>(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0,W=(e,t)=>(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0,$=[80,78,71,66],x=5,I=4,V=40,B=28,k=1,Y=2,X=1,z=2,H=4,q=8,j=16,Z=32;function re(e){if(e.length<B)throw new Error("Invalid PNGB: too short");if(!$.every((n,i)=>e[i]===n))throw new Error("Invalid PNGB: bad magic");let t=new DataView(e.buffer,e.byteOffset,e.byteLength),r=t.getUint16(4,!0);if(r!==x&&r!==I)throw new Error(`Unsupported PNGB version: ${r}`);return r===x?Q(e,t):J(e,t)}function Q(e,t){let r=t.getUint16(6,!0),n=e[8],i=t.getUint32(12,!0),s=t.getUint32(16,!0),o=t.getUint32(20,!0),a=t.getUint32(24,!0),u=t.getUint32(28,!0),f=t.getUint32(32,!0),g=t.getUint32(36,!0),c=(r&k)!==0,U=(r&Y)!==0,h=c?i+s:V,m=o-h;return{version:x,hasEmbeddedExecutor:c,hasAnimationTable:U,plugins:K(n),executor:c?e.subarray(i,i+s):null,bytecode:e.subarray(h,h+m),payload:e,offsets:{executor:c?i:0,executorLength:s,bytecode:h,bytecodeLength:m,stringTable:o,data:a,wgsl:u,uniform:f,animation:g}}}function J(e,t){let r=t.getUint32(8,!0),n=t.getUint32(12,!0),i=t.getUint32(16,!0),s=t.getUint32(20,!0),o=t.getUint32(24,!0),a=B,u=r-a;return{version:I,hasEmbeddedExecutor:!1,hasAnimationTable:!1,plugins:{core:!0,render:!1,compute:!1,wasm:!1,animation:!1,texture:!1},executor:null,bytecode:e.subarray(a,a+u),payload:e,offsets:{executor:0,executorLength:0,bytecode:a,bytecodeLength:u,stringTable:r,data:n,wgsl:i,uniform:s,animation:o}}}function K(e){return{core:(e&X)!==0,render:(e&z)!==0,compute:(e&H)!==0,wasm:(e&q)!==0,animation:(e&j)!==0,texture:(e&Z)!==0}}function ne(e={}){return{env:{log:e.log||((t,r)=>{}),wasmInstantiate:e.wasmInstantiate||((t,r,n)=>{}),wasmCall:e.wasmCall||((t,r,n,i,s,o)=>{}),wasmGetResult:e.wasmGetResult||((t,r,n)=>0)}}}async function ie(e,t={}){let{instance:r}=await WebAssembly.instantiate(e,t),n=r.exports,i=n.memory;return{instance:r,memory:i,exports:n,getBytecodePtr(){return n.getBytecodePtr?.()||0},setBytecodeLen(s){n.setBytecodeLen?.(s)},getDataPtr(){return n.getDataPtr?.()||0},setDataLen(s){n.setDataLen?.(s)},init(){n.init?.()},frame(s,o,a){n.frame?.(s,o,a)},getCommandPtr(){return n.getCommandPtr?.()||0},getCommandLen(){return n.getCommandLen?.()||0}}}function se(e){let t=["core"];return e.render&&t.push("render"),e.compute&&t.push("compute"),e.wasm&&t.push("wasm"),e.animation&&t.push("anim"),e.texture&&t.push("texture"),t.join("-")}function C(e,t){if(!e||e.length===0)return null;for(let r of e)if(t>=r.startMs&&t<r.endMs)return r;return e[e.length-1]}function p(e,t={}){let r=e._;if(!r)throw new Error("Pngine destroyed");if(!r.ready)throw new Error("Not initialized");let n=t.time??r.time,i=t.frame??null;if(i===null&&r.animation&&r.animation.scenes.length>0){let s=C(r.animation.scenes,n*1e3);s&&(i=s.frame,s!==r.currentScene&&(r.currentScene=s,r.currentFrame=s.frame))}r.worker.postMessage({type:"draw",time:n,frame:i,uniforms:t.uniforms??null}),t.time!==void 0&&(r.time=t.time)}function ae(e){let t=e._;if(!t||t.playing)return e;t.playing=!0,t.startTime=performance.now()-t.time*1e3;let r=()=>{if(!t.playing)return;let n=performance.now(),i=(n-t.startTime)/1e3;if(t.animation){let s=t.animation.duration/1e3;if(i>=s)switch(t.animation.endBehavior){case"loop":case"restart":t.startTime=n,i=0;break;case"stop":t.playing=!1,t.time=s,p(e,{time:s});return;case"hold":default:i=s;break}let o=C(t.animation.scenes,i*1e3);o&&o!==t.currentScene&&(t.currentScene=o,t.currentFrame=o.frame)}t.time=i,p(e,{time:t.time,frame:t.currentFrame}),t.animationId=requestAnimationFrame(r)};return t.animationId=requestAnimationFrame(r),e}function ee(e){let t=e._;return!t||!t.playing||(t.playing=!1,t.time=(performance.now()-t.startTime)/1e3,t.animationId&&(cancelAnimationFrame(t.animationId),t.animationId=null)),e}function oe(e){ee(e);let t=e._;return t&&(t.time=0,t.startTime=performance.now(),p(e,{time:0})),e}function ue(e,t){let r=e._;return r&&(r.time=t,r.playing&&(r.startTime=performance.now()-t*1e3),p(e,{time:t})),e}function ce(e,t){let r=e._;return r&&(r.currentFrame=t,p(e,{time:r.time,frame:t})),e}function le(e,t,r,n=!0){let i=e._;return i&&(i.uniforms||(i.uniforms={}),i.uniforms[t]=r,n&&p(e,{time:i.time,uniforms:{[t]:r}})),e}function fe(e,t,r=!0){let n=e._;return n&&(n.uniforms||(n.uniforms={}),Object.assign(n.uniforms,t),r&&p(e,{time:n.time,uniforms:t})),e}async function de(e,t={}){let r,n;if(typeof e=="string")if(e.startsWith("#")||e.startsWith(".")&&!e.startsWith("./")&&!e.startsWith("..")){let u=document.querySelector(e);if(!u)throw new Error(`Element not found: ${e}`);if(u instanceof HTMLImageElement)({canvas:r,bytecode:n}=await b(u,t));else throw u instanceof HTMLCanvasElement?(r=u,new Error("Canvas source requires URL or data")):new Error("Invalid element type")}else{if(r=t.canvas,!r)throw new Error("Canvas required for URL source");let u=await fetch(e);if(!u.ok)throw new Error(`Fetch failed: ${u.status}`);n=await A(await u.arrayBuffer())}else if(e instanceof HTMLImageElement)({canvas:r,bytecode:n}=await b(e,t));else if(e instanceof ArrayBuffer||e instanceof Uint8Array||e instanceof Blob){if(r=t.canvas,!r)throw new Error("Canvas required for data source");let a=e instanceof Blob?await e.arrayBuffer():e;n=await A(a)}else throw new Error("Invalid source type");let i=r.transferControlToOffscreen(),s=new Worker(S()),o=await new Promise((a,u)=>{let f=setTimeout(()=>u(new Error("Worker init timeout")),15e3);s.onmessage=c=>{c.data.type==="ready"?(clearTimeout(f),a(c.data)):c.data.type==="error"&&(clearTimeout(f),u(new Error(c.data.message)))},s.onerror=c=>{clearTimeout(f),u(new Error(c.message||"Worker error"))};let g=t.wasmUrl?new URL(t.wasmUrl,window.location.href).href:new URL("pngine.wasm",import.meta.url).href;s.postMessage({type:"init",canvas:i,bytecode:n,wasmUrl:g,debug:t.debug||!1},[i,n.buffer])});return s.onmessage=a=>{a.data.type==="error"&&t.onError&&t.onError(new Error(a.data.message))},te({canvas:r,worker:s,width:o.width,height:o.height,frameCount:o.frameCount,animation:o.animation||null,currentScene:null,currentFrame:null,ready:!0,playing:!1,time:0,startTime:0,animationId:null})}async function b(e,t){e.complete||await new Promise((a,u)=>{e.onload=a,e.onerror=u});let{naturalWidth:r,naturalHeight:n}=e;if(r===0||n===0)throw new Error("Image has no dimensions");let i=t.canvas||document.createElement("canvas");if(i.width=r,i.height=n,!t.canvas){let a=e.parentElement;a&&getComputedStyle(a).position==="static"&&(a.style.position="relative"),Object.assign(i.style,{position:"absolute",top:e.offsetTop+"px",left:e.offsetLeft+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px",pointerEvents:"none"}),a&&a.appendChild(i)}let s=await fetch(e.src);if(!s.ok)throw new Error(`Failed to fetch image: ${s.status}`);let o=await A(await s.arrayBuffer());return{canvas:i,bytecode:o}}function te(e){return{get width(){return e.width},get height(){return e.height},get isPlaying(){return e.playing},get time(){return e.time},get frameCount(){return e.frameCount},get animation(){return e.animation},get currentScene(){return e.currentScene},get currentFrame(){return e.currentFrame},get duration(){return e.animation?e.animation.duration/1e3:0},_:e}}function ge(e){let t=e._;return t&&(t.animationId&&cancelAnimationFrame(t.animationId),t.worker.postMessage({type:"destroy"}),t.worker.terminate(),e._=null),e}export{ie as createExecutor,ge as destroy,D as detectFormat,p as draw,A as extractBytecode,ne as getExecutorImports,se as getExecutorVariantName,R as isPng,M as isPngb,G as isZip,re as parsePayload,ee as pause,ae as play,de as pngine,ue as seek,ce as setFrame,le as setUniform,fe as setUniforms,oe as stop};
