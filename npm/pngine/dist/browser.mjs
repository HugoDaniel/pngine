var P='var d={CREATE_BUFFER:1,CREATE_TEXTURE:2,CREATE_SAMPLER:3,CREATE_SHADER:4,CREATE_RENDER_PIPELINE:5,CREATE_COMPUTE_PIPELINE:6,CREATE_BIND_GROUP:7,CREATE_TEXTURE_VIEW:8,CREATE_QUERY_SET:9,CREATE_BIND_GROUP_LAYOUT:10,CREATE_IMAGE_BITMAP:11,CREATE_PIPELINE_LAYOUT:12,CREATE_RENDER_BUNDLE:13,BEGIN_RENDER_PASS:16,BEGIN_COMPUTE_PASS:17,SET_PIPELINE:18,SET_BIND_GROUP:19,SET_VERTEX_BUFFER:20,DRAW:21,DRAW_INDEXED:22,END_PASS:23,DISPATCH:24,SET_INDEX_BUFFER:25,EXECUTE_BUNDLES:26,WRITE_BUFFER:32,WRITE_TIME_UNIFORM:33,COPY_BUFFER_TO_BUFFER:34,COPY_TEXTURE_TO_TEXTURE:35,WRITE_BUFFER_FROM_WASM:36,COPY_EXTERNAL_IMAGE_TO_TEXTURE:37,INIT_WASM_MODULE:48,CALL_WASM_FUNC:49,CREATE_TYPED_ARRAY:64,FILL_RANDOM:65,FILL_EXPRESSION:66,FILL_CONSTANT:67,WRITE_BUFFER_FROM_ARRAY:68,SUBMIT:240,END:255},T={MAP_READ:1,MAP_WRITE:2,COPY_SRC:4,COPY_DST:8,INDEX:16,VERTEX:32,UNIFORM:64,STORAGE:128},C=class{constructor(r,t){this.device=r,this.context=t,this.memory=null,this.buffers=new Map,this.textures=new Map,this.textureViews=new Map,this.samplers=new Map,this.shaders=new Map,this.pipelines=new Map,this.bindGroups=new Map,this.bindGroupLayouts=new Map,this.pipelineLayouts=new Map,this.querySets=new Map,this.renderBundles=new Map,this.imageBitmaps=new Map,this.wasmModules=new Map,this.typedArrays=new Map,this.bindGroupDescriptors=new Map,this.textureDescriptors=new Map,this.encoder=null,this.pass=null,this.time=0,this.canvasWidth=0,this.canvasHeight=0}setMemory(r){this.memory=r}setTime(r){this.time=r}setCanvasSize(r,t){this.canvasWidth=r,this.canvasHeight=t}async execute(r){let t=new DataView(this.memory.buffer),e=t.getUint32(r,!0),s=t.getUint16(r+4,!0),n=r+8,i=r+e;for(let a=0;a<s&&n<i;a++){let u=t.getUint8(n++),c=this._dispatch(u,t,n);c instanceof Promise?(n=await c,t=new DataView(this.memory.buffer)):n=c}}_dispatch(r,t,e){switch(r){case d.CREATE_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint8(e+6);return this._createBuffer(s,n,i),e+7}case d.CREATE_SHADER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createShader(s,n,i),e+10}case d.CREATE_RENDER_PIPELINE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createRenderPipeline(s,n,i),e+10}case d.CREATE_COMPUTE_PIPELINE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createComputePipeline(s,n,i),e+10}case d.CREATE_BIND_GROUP:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0);return this._createBindGroup(s,n,i,a),e+12}case d.CREATE_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createTexture(s,n,i),e+10}case d.CREATE_SAMPLER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createSampler(s,n,i),e+10}case d.CREATE_TEXTURE_VIEW:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0);return this._createTextureView(s,n,i,a),e+12}case d.CREATE_QUERY_SET:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createQuerySet(s,n,i),e+10}case d.CREATE_BIND_GROUP_LAYOUT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createBindGroupLayout(s,n,i),e+10}case d.CREATE_PIPELINE_LAYOUT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createPipelineLayout(s,n,i),e+10}case d.CREATE_RENDER_BUNDLE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createRenderBundle(s,n,i),e+10}case d.BEGIN_RENDER_PASS:{let s=t.getUint16(e,!0),n=t.getUint8(e+2),i=t.getUint8(e+3),a=t.getUint16(e+4,!0);return this._beginRenderPass(s,n,i,a),e+6}case d.BEGIN_COMPUTE_PASS:return this._beginComputePass(),e;case d.SET_PIPELINE:{let s=t.getUint16(e,!0);return this.pass?.setPipeline(this.pipelines.get(s)),e+2}case d.SET_BIND_GROUP:{let s=t.getUint8(e),n=t.getUint16(e+1,!0);return this.pass?.setBindGroup(s,this.bindGroups.get(n)),e+3}case d.SET_VERTEX_BUFFER:{let s=t.getUint8(e),n=t.getUint16(e+1,!0);return this.pass?.setVertexBuffer(s,this.buffers.get(n)),e+3}case d.SET_INDEX_BUFFER:{let s=t.getUint16(e,!0),i=t.getUint8(e+2)===1?"uint32":"uint16";return this.pass?.setIndexBuffer(this.buffers.get(s),i),e+3}case d.EXECUTE_BUNDLES:{let s=t.getUint8(e),n=[];for(let i=0;i<s;i++){let a=t.getUint16(e+1+i*2,!0),u=this.renderBundles.get(a);u&&n.push(u)}return this.pass?.executeBundles(n),e+1+s*2}case d.DRAW:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0),a=t.getUint32(e+12,!0);return this.pass?.draw(s,n,i,a),e+16}case d.DRAW_INDEXED:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0),a=t.getInt32(e+12,!0),u=t.getUint32(e+16,!0);return this.pass?.drawIndexed(s,n,i,a,u),e+20}case d.DISPATCH:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0);return this.pass?.dispatchWorkgroups(s,n,i),e+12}case d.END_PASS:return this.pass?.end(),this.pass=null,e;case d.WRITE_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0);return this._writeBuffer(s,n,i,a),e+14}case d.WRITE_TIME_UNIFORM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0);return this._writeTimeUniform(s,n,i),e+8}case d.CREATE_IMAGE_BITMAP:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createImageBitmap(s,n,i),e+10}case d.COPY_EXTERNAL_IMAGE_TO_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint8(e+4),a=t.getUint16(e+5,!0),u=t.getUint16(e+7,!0),c=e+9;return this._copyExternalImageToTexture(s,n,i,a,u).then(()=>c)}case d.COPY_BUFFER_TO_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0),a=t.getUint32(e+8,!0),u=t.getUint32(e+12,!0);return this._copyBufferToBuffer(s,n,i,a,u),e+16}case d.COPY_TEXTURE_TO_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint16(e+4,!0),a=t.getUint16(e+6,!0);return this._copyTextureToTexture(s,n,i,a),e+8}case d.WRITE_BUFFER_FROM_WASM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0);return this._writeBufferFromWasm(s,n,i,a),e+14}case d.INIT_WASM_MODULE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._initWasmModule(s,n,i),e+10}case d.CALL_WASM_FUNC:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0),u=t.getUint32(e+12,!0),c=t.getUint32(e+16,!0);return this._callWasmFunc(s,n,i,a,u,c),e+20}case d.CREATE_TYPED_ARRAY:{let s=t.getUint16(e,!0),n=t.getUint8(e+2),i=t.getUint32(e+3,!0);return this._createTypedArray(s,n,i),e+7}case d.FILL_RANDOM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint16(e+11,!0),c=t.getUint16(e+13,!0);return this._fillRandom(s,n,i,a,u,c),e+15}case d.FILL_EXPRESSION:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0),c=t.getUint16(e+15,!0);return this._fillExpression(s,n,i,a,u,c),e+17}case d.FILL_CONSTANT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0);return this._fillConstant(s,n,i,a,u),e+15}case d.WRITE_BUFFER_FROM_ARRAY:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0);return this._writeBufferFromArray(s,n,i),e+8}case d.SUBMIT:return this.encoder&&(this.device.queue.submit([this.encoder.finish()]),this.encoder=null),e;case d.END:return e;default:return e}}_createBuffer(r,t,e){if(this.buffers.has(r))return;let s=this._translateUsage(e);this.buffers.set(r,this.device.createBuffer({size:t,usage:s}))}_translateUsage(r){let t=0;return r&T.MAP_READ&&(t|=GPUBufferUsage.MAP_READ),r&T.MAP_WRITE&&(t|=GPUBufferUsage.MAP_WRITE),r&T.COPY_SRC&&(t|=GPUBufferUsage.COPY_SRC),r&T.COPY_DST&&(t|=GPUBufferUsage.COPY_DST),r&T.INDEX&&(t|=GPUBufferUsage.INDEX),r&T.VERTEX&&(t|=GPUBufferUsage.VERTEX),r&T.UNIFORM&&(t|=GPUBufferUsage.UNIFORM),r&T.STORAGE&&(t|=GPUBufferUsage.STORAGE),t||GPUBufferUsage.COPY_DST}_createShader(r,t,e){if(this.shaders.has(r))return;let s=this._readString(t,e);this.shaders.set(r,this.device.createShaderModule({code:s}))}_createRenderPipeline(r,t,e){if(this.pipelines.has(r))return;let s=this._readString(t,e);if(!s||s.length===0)return;let n=JSON.parse(s),i=this._buildRenderPipeline(n);this.pipelines.set(r,i),this.bindGroupLayouts.set(r,i.getBindGroupLayout(0))}_buildRenderPipeline(r){let t=navigator.gpu.getPreferredCanvasFormat();return this.device.createRenderPipeline({layout:"auto",vertex:{module:this.shaders.get(r.vertex?.shader??0),entryPoint:r.vertex?.entryPoint??"vs_main",buffers:r.vertex?.buffers??[]},fragment:{module:this.shaders.get(r.fragment?.shader??r.vertex?.shader??0),entryPoint:r.fragment?.entryPoint??"fs_main",targets:[{format:t}]},primitive:r.primitive??{topology:"triangle-list"},depthStencil:r.depthStencil})}_createComputePipeline(r,t,e){if(this.pipelines.has(r))return;let s=this._readString(t,e);if(!s||s.length===0)return;let n=JSON.parse(s),i="auto";n.layout&&n.layout!=="auto"&&(i=this.pipelineLayouts.get(n.layout)??"auto");let a=this.device.createComputePipeline({layout:i,compute:{module:this.shaders.get(n.compute?.shader??0),entryPoint:n.compute?.entryPoint??"main"}});this.pipelines.set(r,a),i==="auto"&&this.bindGroupLayouts.set(r,a.getBindGroupLayout(0))}_createBindGroup(r,t,e,s){if(this.bindGroups.has(r))return;let n=new Uint8Array(this.memory.buffer,e,s),i=this._decodeBindGroupDescriptor(n);i.layoutId=t,this.bindGroupDescriptors.set(r,i);let a=this.pipelines.get(t);if(!a)return;let u=i.entries.map(c=>{let f={binding:c.binding};if(c.resourceType===0){let g={buffer:this.buffers.get(c.resourceId)};c.offset&&(g.offset=c.offset),c.size&&(g.size=c.size),f.resource=g}else c.resourceType===1?f.resource=this.textures.get(c.resourceId)?.createView():c.resourceType===2&&(f.resource=this.samplers.get(c.resourceId));return f});this.bindGroups.set(r,this.device.createBindGroup({layout:a.getBindGroupLayout(i.groupIndex),entries:u}))}_decodeBindGroupDescriptor(r){let t=new DataView(r.buffer,r.byteOffset,r.byteLength),e=0;if(r[e++]!==3)return{groupIndex:0,entries:[]};let n=r[e++],i=0,a=[],u=1,c=2,f=3,g=7;for(let l=0;l<n;l++){let L=r[e++],_=r[e++];if(L===u&&_===g)i=r[e++];else if(L===c&&_===f){let M=r[e++];for(let b=0;b<M;b++){let m=r[e++],R=r[e++],h=t.getUint16(e,!0);e+=2;let F={binding:m,resourceType:R,resourceId:h};R===0&&(F.offset=t.getUint32(e,!0),e+=4,F.size=t.getUint32(e,!0),e+=4),a.push(F)}}}return{groupIndex:i,entries:a}}_createTexture(r,t,e){if(this.textures.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=this._decodeTextureDescriptor(s);this.textureDescriptors.set(r,{format:n.format,usage:n.usage}),this.textures.set(r,this.device.createTexture(n))}_createSampler(r,t,e){if(this.samplers.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=this._decodeSamplerDescriptor(s);this.samplers.set(r,this.device.createSampler(n))}_decodeTextureDescriptor(r){let t=new DataView(r.buffer,r.byteOffset,r.byteLength),e=0;if(r[e++]!==1)return{size:[256,256],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT};let n=r[e++],i={size:[this.canvasWidth||512,this.canvasHeight||512],format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:1},a=1,u=2,c=5,f=7,g=8,l=10,L=0,_=6,M=7;for(let b=0;b<n;b++){let m=r[e++],R=r[e++];if(R===L){let h=t.getUint32(e,!0);e+=4,m===a?i.size[0]=h:m===u?i.size[1]=h:m===c&&(i.sampleCount=h)}else if(R===_){let h=t.getUint16(e,!0);e+=2,m===l&&(i.size=[1,1],i.imageBitmapId=h)}else if(R===M){let h=r[e++];m===f?i.format=this._decodeTextureFormat(h):m===g&&(i.usage=this._decodeTextureUsage(h))}}return i}_decodeSamplerDescriptor(r){let t=0;if(r[t++]!==2)return{};let s=r[t++],n={magFilter:"linear",minFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},i=1,a=2,u=4,c=5,f=7;for(let g=0;g<s;g++){let l=r[t++];if(r[t++]===f){let _=r[t++];l===u?n.magFilter=_===0?"nearest":"linear":l===c?n.minFilter=_===0?"nearest":"linear":l===i?n.addressModeU=["clamp-to-edge","repeat","mirror-repeat"][_]||"clamp-to-edge":l===a&&(n.addressModeV=["clamp-to-edge","repeat","mirror-repeat"][_]||"clamp-to-edge")}}return n}_decodeTextureFormat(r){return{0:"rgba8unorm",1:"rgba8snorm",2:"rgba8uint",3:"rgba8sint",4:"bgra8unorm",5:"rgba16float",6:"rgba32float",16:"depth24plus",17:"depth24plus-stencil8",18:"depth32float"}[r]||navigator.gpu.getPreferredCanvasFormat()}_decodeTextureUsage(r){let t=0;return r&1&&(t|=GPUTextureUsage.COPY_SRC),r&2&&(t|=GPUTextureUsage.COPY_DST),r&4&&(t|=GPUTextureUsage.TEXTURE_BINDING),r&8&&(t|=GPUTextureUsage.STORAGE_BINDING),r&16&&(t|=GPUTextureUsage.RENDER_ATTACHMENT),t||GPUTextureUsage.RENDER_ATTACHMENT}_beginRenderPass(r,t,e,s){this.encoder||(this.encoder=this.device.createCommandEncoder());let c={colorAttachments:[{view:r===65534?this.context.getCurrentTexture().createView():this.textures.get(r)?.createView(),loadOp:t===1?"clear":"load",storeOp:e===0?"store":"discard",clearValue:{r:0,g:0,b:0,a:1}}]};if(s!==65535){let f=this.textures.get(s)?.createView();f&&(c.depthStencilAttachment={view:f,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1})}this.pass=this.encoder.beginRenderPass(c)}_beginComputePass(){this.encoder||(this.encoder=this.device.createCommandEncoder()),this.pass=this.encoder.beginComputePass()}_writeBuffer(r,t,e,s){let n=this.buffers.get(r);if(!n)return;let i=new Uint8Array(this.memory.buffer,e,s);this.device.queue.writeBuffer(n,t,i)}_writeTimeUniform(r,t,e){let s=this.buffers.get(r);if(!s)return;let n=new Float32Array([this.time,this.canvasWidth,this.canvasHeight,this.canvasWidth/(this.canvasHeight||1)]),i=new Uint8Array(n.buffer,0,Math.min(e,16));this.device.queue.writeBuffer(s,t,i)}_readString(r,t){let e=new Uint8Array(this.memory.buffer,r,t);return new TextDecoder().decode(e)}_createImageBitmap(r,t,e){if(this.imageBitmaps.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=s[0],i=s.slice(1,1+n),a=new TextDecoder().decode(i),u=s.slice(1+n),c=new Blob([u],{type:a}),f=globalThis.createImageBitmap(c);this.imageBitmaps.set(r,f)}async _copyExternalImageToTexture(r,t,e,s,n){let i=this.imageBitmaps.get(r);if(!i)return;i instanceof Promise&&(i=await i,this.imageBitmaps.set(r,i));let a=this.textures.get(t);if(a){if(a.width!==i.width||a.height!==i.height){a.destroy();let u=this.textureDescriptors.get(t)||{format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};a=this.device.createTexture({size:[i.width,i.height],format:u.format,usage:u.usage}),this.textures.set(t,a),this._recreateBindGroupsForTexture(t)}this.device.queue.copyExternalImageToTexture({source:i},{texture:a,mipLevel:e,origin:{x:s,y:n}},{width:i.width,height:i.height})}}_recreateBindGroupsForTexture(r){for(let[t,e]of this.bindGroupDescriptors.entries())e.entries.some(n=>n.resourceType===1&&n.resourceId===r)&&(this.bindGroups.delete(t),this._recreateBindGroup(t,e))}_recreateBindGroup(r,t){let e=this.pipelines.get(t.layoutId);if(!e)return;let s=t.entries.map(n=>{let i={binding:n.binding};if(n.resourceType===0){let a={buffer:this.buffers.get(n.resourceId)};n.offset&&(a.offset=n.offset),n.size&&(a.size=n.size),i.resource=a}else n.resourceType===1?i.resource=this.textures.get(n.resourceId)?.createView():n.resourceType===2&&(i.resource=this.samplers.get(n.resourceId));return i});this.bindGroups.set(r,this.device.createBindGroup({layout:e.getBindGroupLayout(t.groupIndex),entries:s}))}_createTextureView(r,t,e,s){if(this.textureViews.has(r))return;let n=this.textures.get(t);n&&this.textureViews.set(r,n.createView())}_createQuerySet(r,t,e){this.querySets.has(r)}_createBindGroupLayout(r,t,e){this.bindGroupLayouts.has(r)}_createPipelineLayout(r,t,e){this.pipelineLayouts.has(r)}_createRenderBundle(r,t,e){this.renderBundles.has(r)}_copyBufferToBuffer(r,t,e,s,n){let i=this.buffers.get(r),a=this.buffers.get(e);if(!i||!a)return;let u=this.encoder||this.device.createCommandEncoder();u.copyBufferToBuffer(i,t,a,s,n),this.encoder||this.device.queue.submit([u.finish()])}_copyTextureToTexture(r,t,e,s){let n=this.textures.get(r),i=this.textures.get(t);if(!n||!i)return;let a=this.encoder||this.device.createCommandEncoder();a.copyTextureToTexture({texture:n},{texture:i},{width:e,height:s}),this.encoder||this.device.queue.submit([a.finish()])}_writeBufferFromWasm(r,t,e,s){let n=this.buffers.get(r);if(!n)return;let i=new Uint8Array(this.memory.buffer,e,s);this.device.queue.writeBuffer(n,t,i)}_initWasmModule(r,t,e){}_callWasmFunc(r,t,e,s,n,i){}_createTypedArray(r,t,e){if(this.typedArrays.has(r))return;let n=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t]||Float32Array,i=new n(e);this.typedArrays.set(r,i)}_fillRandom(r,t,e,s,n,i){let a=this.buffers.get(r);if(!a)return;let u,c=i-n;if(s===6){u=new Float32Array(e/4);for(let f=0;f<u.length;f++)u[f]=n+Math.random()*c}else{u=new Uint8Array(e);for(let f=0;f<u.length;f++)u[f]=n+Math.floor(Math.random()*c)}this.device.queue.writeBuffer(a,t,u)}_fillExpression(r,t,e,s,n,i){let a=this.typedArrays.get(r);if(!a)return;let u=this._readString(n,i);if(u)try{let c=u.replace(/NUM_PARTICLES/g,String(e)).replace(/PI/g,"Math.PI").replace(/random\\(\\)/g,"Math.random()").replace(/sin\\(/g,"Math.sin(").replace(/cos\\(/g,"Math.cos(").replace(/sqrt\\(/g,"Math.sqrt(").replace(/ceil\\(/g,"Math.ceil(").replace(/floor\\(/g,"Math.floor(").replace(/abs\\(/g,"Math.abs("),f=new Function("ELEMENT_ID",`return ${c};`);for(let g=0;g<e;g++){let l=g*s+t;a[l]=f(g)}}catch{}}_fillConstant(r,t,e,s,n){let i=this.typedArrays.get(r);if(!i)return;let u=new Float32Array(this.memory.buffer,n,1)[0];for(let c=0;c<e;c++){let f=c*s+t;i[f]=u}}_writeBufferFromArray(r,t,e){let s=this.typedArrays.get(e),n=this.buffers.get(r);if(!s||!n)return;let i=s instanceof Float32Array?s:new Float32Array(s.buffer,s.byteOffset,Math.min(8,s.byteLength/4));this.device.queue.writeBuffer(n,t,s)}destroy(){for(let r of this.buffers.values())r.destroy?.();for(let r of this.textures.values())r.destroy?.();for(let r of this.imageBitmaps.values())r instanceof ImageBitmap&&r.close?.();this.buffers.clear(),this.textures.clear(),this.textureViews.clear(),this.samplers.clear(),this.shaders.clear(),this.pipelines.clear(),this.bindGroups.clear(),this.bindGroupLayouts.clear(),this.pipelineLayouts.clear(),this.querySets.clear(),this.renderBundles.clear(),this.imageBitmaps.clear(),this.wasmModules.clear(),this.typedArrays.clear(),this.bindGroupDescriptors.clear(),this.textureDescriptors.clear()}};var p,y,D,U,E,P,B=!1,A=!1,S=0,I=()=>{},x={INIT:"init",DRAW:"draw",LOAD:"load",DESTROY:"destroy",READY:"ready",ERROR:"error"};onmessage=async o=>{let{type:r,...t}=o.data;try{switch(r){case x.INIT:await O(t);break;case x.DRAW:$(t);break;case x.LOAD:await W(t);break;case x.DESTROY:V();break;default:throw new Error(`Unknown message: ${r}`)}}catch(e){postMessage({type:x.ERROR,message:e.message})}};async function O(o){if(B)throw new Error("Already initialized");p=o.canvas,I=o.debug?void 0:()=>{};let r=await navigator.gpu?.requestAdapter();if(!r)throw new Error("WebGPU not supported");y=await r.requestDevice(),D=p.getContext("webgpu");let t=navigator.gpu.getPreferredCanvasFormat();if(D.configure({device:y,format:t,alphaMode:"premultiplied"}),U=new C(y,D),U.setCanvasSize(p.width,p.height),!o.wasmUrl)throw new Error("wasmUrl required");let e=await fetch(o.wasmUrl);if(!e.ok)throw new Error(`Failed to fetch WASM: ${e.status}`);let{instance:s}=await WebAssembly.instantiateStreaming(e,Y());E=s.exports,P=E.memory,U.setMemory(P),E.onInit(),B=!0,I("Initialized"),o.bytecode&&await G(o.bytecode),postMessage({type:x.READY,width:p.width,height:p.height,frameCount:S})}async function W(o){if(!B)throw new Error("Not initialized");await G(o.bytecode),postMessage({type:x.READY,frameCount:S})}async function G(o){A&&(E.freeModule(),U.destroy(),U=new C(y,D),U.setMemory(P),U.setCanvasSize(p.width,p.height),A=!1);let r=E.alloc(o.byteLength);if(!r)throw new Error("Failed to allocate memory");new Uint8Array(P.buffer,r,o.byteLength).set(new Uint8Array(o));let t=E.loadModule(r,o.byteLength);if(E.free(r,o.byteLength),t!==0)throw new Error(`Load failed: ${t}`);A=!0,S=E.getFrameCount(),N(0,0),I(`Loaded module: ${S} frames`)}function $(o){!B||!A||N(o.time??0,0)}function N(o,r){U.setTime(o);let t=E.renderFrame(o,r);if(!t){I("renderFrame returned null");return}U.execute(t)}function V(){A&&(E.freeModule(),A=!1),U?.destroy(),y&&(y.destroy(),y=null),B=!1,I("Destroyed")}function Y(){let o=()=>{};return{env:{gpuCreateBuffer:o,gpuCreateTexture:o,gpuCreateSampler:o,gpuCreateShaderModule:o,gpuCreateRenderPipeline:o,gpuCreateComputePipeline:o,gpuCreateBindGroup:o,gpuCreateImageBitmap:o,gpuCreateTextureView:o,gpuCreateQuerySet:o,gpuCreateBindGroupLayout:o,gpuCreatePipelineLayout:o,gpuCreateRenderBundle:o,gpuBeginRenderPass:o,gpuBeginComputePass:o,gpuSetPipeline:o,gpuSetBindGroup:o,gpuSetVertexBuffer:o,gpuDraw:o,gpuDrawIndexed:o,gpuDispatch:o,gpuExecuteBundles:o,gpuEndPass:o,gpuWriteBuffer:o,gpuSubmit:o,gpuCopyExternalImageToTexture:o,gpuInitWasmModule:o,gpuCallWasmFunc:o,gpuWriteBufferFromWasm:o,gpuCreateTypedArray:o,gpuFillRandom:o,gpuFillExpression:o,gpuFillConstant:o,gpuWriteBufferFromArray:o,gpuWriteTimeUniform:o,gpuDebugLog:o,jsConsoleLog:(r,t)=>{let e=new TextDecoder().decode(new Uint8Array(P.buffer,r,t));I(e)},jsConsoleLogInt:(r,t,e)=>{let s=new TextDecoder().decode(new Uint8Array(P.buffer,r,t));I(s,e)}}}}\n';function B(){let e=new Blob([P],{type:"application/javascript"});return URL.createObjectURL(e)}var C=[137,80,78,71,13,10,26,10],U=[112,78,71,98],I=e=>e.length>=8&&C.every((t,i)=>e[i]===t),S=e=>e.length>=4&&e[0]===80&&e[1]===75&&(e[2]===3||e[2]===5),M=e=>e.length>=4&&e[0]===80&&e[1]===78&&e[2]===71&&e[3]===66;function D(e){return S(e)?"zip":I(e)?"png":M(e)?"pngb":null}async function R(e){let t=e instanceof Uint8Array?e:new Uint8Array(e),i=D(t);if(i==="pngb")return t;if(i==="png")return b(t);if(i==="zip")return L(t);throw new Error("Unknown format")}async function b(e){if(!I(e))throw new Error("Invalid PNG");let t=8;for(;t+12<=e.length;){let i=N(e,t),r=e.subarray(t+4,t+8);if(r[0]===U[0]&&r[1]===U[1]&&r[2]===U[2]&&r[3]===U[3]){let o=e.subarray(t+8,t+8+i);return F(o)}t+=12+i}throw new Error("No pNGb chunk found")}async function F(e){if(e.length<2)throw new Error("Invalid pNGb chunk");let t=e[0],i=e[1],r=e.subarray(2);if(t!==1)throw new Error(`Unsupported pNGb version: ${t}`);return i&1?x(r):new Uint8Array(r)}async function L(e){let t=-1;for(let s=22;s<=Math.min(e.length,65557);s++){let u=e.length-s;if(f(e,u)===101010256){t=u;break}}if(t===-1)throw new Error("Invalid ZIP");let i=l(e,t+10),r=f(e,t+16),o=null,c=null;for(let s=0;s<i&&f(e,r)===33639248;s++){let u=l(e,r+10),n=f(e,r+20),a=f(e,r+24),d=l(e,r+28),h=l(e,r+30),g=l(e,r+32),y=f(e,r+42),p=new TextDecoder().decode(e.subarray(r+46,r+46+d)),m=l(e,y+28),T=y+30+d+m,E={name:p,compression:u,compSize:n,uncompSize:a,dataOff:T};p==="manifest.json"?o=E:p.endsWith(".pngb")&&!c&&(c=E),r+=46+d+h+g}if(o){let s=JSON.parse(new TextDecoder().decode(await w(e,o)));if(s.entry){r=f(e,t+16);for(let u=0;u<i&&f(e,r)===33639248;u++){let n=l(e,r+28);if(new TextDecoder().decode(e.subarray(r+46,r+46+n))===s.entry){let d=l(e,r+10),h=f(e,r+20),g=f(e,r+24),y=l(e,r+30),p=l(e,r+32),m=f(e,r+42),T=l(e,m+28),E=m+30+n+T;return w(e,{compression:d,compSize:h,uncompSize:g,dataOff:E})}r+=46+n+l(e,r+30)+l(e,r+32)}}}if(c)return w(e,c);throw new Error("No bytecode found in ZIP")}async function w(e,t){let i=e.subarray(t.dataOff,t.dataOff+t.compSize);if(t.compression===0)return new Uint8Array(i);if(t.compression===8)return x(i);throw new Error(`Unsupported compression: ${t.compression}`)}async function x(e){let t=new DecompressionStream("deflate-raw"),i=t.writable.getWriter(),r=t.readable.getReader();i.write(e),i.close();let o=[],c=0;for(;;){let{done:n,value:a}=await r.read();if(n)break;o.push(a),c+=a.length}let s=new Uint8Array(c),u=0;for(let n of o)s.set(n,u),u+=n.length;return s}var l=(e,t)=>e[t]|e[t+1]<<8,f=(e,t)=>(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0,N=(e,t)=>(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0;function _(e,t={}){let i=e._;if(!i)throw new Error("Pngine destroyed");if(!i.ready)throw new Error("Not initialized");i.worker.postMessage({type:"draw",time:t.time??i.time,frame:t.frame??null,uniforms:t.uniforms??null}),t.time!==void 0&&(i.time=t.time)}function O(e){let t=e._;if(!t||t.playing)return e;t.playing=!0,t.startTime=performance.now()-t.time*1e3;let i=()=>{if(!t.playing)return;let r=performance.now();t.time=(r-t.startTime)/1e3,_(e,{time:t.time}),t.animationId=requestAnimationFrame(i)};return t.animationId=requestAnimationFrame(i),t.log?.("Playing"),e}function v(e){let t=e._;return!t||!t.playing||(t.playing=!1,t.time=(performance.now()-t.startTime)/1e3,t.animationId&&(cancelAnimationFrame(t.animationId),t.animationId=null),t.log?.("Paused")),e}function W(e){v(e);let t=e._;return t&&(t.time=0,t.startTime=performance.now(),_(e,{time:0}),t.log?.("Stopped")),e}function Y(e,t){let i=e._;return i&&(i.time=t,i.playing&&(i.startTime=performance.now()-t*1e3),_(e,{time:t})),e}function V(e,t){let i=e._;return i&&(i.currentFrame=t,_(e,{time:i.time,frame:t})),e}async function k(e,t={}){let i=t.debug?void 0:()=>{},r,o;if(typeof e=="string")if(e.startsWith("#")||e.startsWith(".")&&!e.startsWith("..")){let a=document.querySelector(e);if(!a)throw new Error(`Element not found: ${e}`);if(a instanceof HTMLImageElement)({canvas:r,bytecode:o}=await A(a,t,i));else throw a instanceof HTMLCanvasElement?(r=a,new Error("Canvas source requires URL or data")):new Error("Invalid element type")}else{if(r=t.canvas,!r)throw new Error("Canvas required for URL source");i(`Fetching: ${e}`);let a=await fetch(e);if(!a.ok)throw new Error(`Fetch failed: ${a.status}`);o=await R(await a.arrayBuffer())}else if(e instanceof HTMLImageElement)({canvas:r,bytecode:o}=await A(e,t,i));else if(e instanceof ArrayBuffer||e instanceof Uint8Array||e instanceof Blob){if(r=t.canvas,!r)throw new Error("Canvas required for data source");let n=e instanceof Blob?await e.arrayBuffer():e;o=await R(n)}else throw new Error("Invalid source type");i(`Canvas: ${r.width}x${r.height}`),i(`Bytecode: ${o.byteLength} bytes`);let c=r.transferControlToOffscreen(),s=new Worker(B()),u=await new Promise((n,a)=>{let d=setTimeout(()=>a(new Error("Worker init timeout")),15e3);s.onmessage=g=>{g.data.type==="ready"?(clearTimeout(d),n(g.data)):g.data.type==="error"&&(clearTimeout(d),a(new Error(g.data.message)))},s.onerror=g=>{clearTimeout(d),a(new Error(g.message||"Worker error"))};let h=t.wasmUrl?new URL(t.wasmUrl,window.location.href).href:new URL("pngine.wasm",import.meta.url).href;s.postMessage({type:"init",canvas:c,bytecode:o,wasmUrl:h,debug:t.debug||!1},[c,o.buffer])});return s.onmessage=n=>{n.data.type==="error"&&t.onError&&t.onError(new Error(n.data.message))},i(`Ready: ${u.frameCount} frames`),G({canvas:r,worker:s,width:u.width,height:u.height,frameCount:u.frameCount,ready:!0,playing:!1,time:0,startTime:0,animationId:null,debug:t.debug||!1,log:i})}async function A(e,t,i){e.complete||await new Promise((n,a)=>{e.onload=n,e.onerror=a});let{naturalWidth:r,naturalHeight:o}=e;if(r===0||o===0)throw new Error("Image has no dimensions");i(`Image: ${r}x${o} from ${e.src}`);let c=t.canvas||document.createElement("canvas");if(c.width=r,c.height=o,!t.canvas){let n=e.parentElement;n&&getComputedStyle(n).position==="static"&&(n.style.position="relative"),Object.assign(c.style,{position:"absolute",top:e.offsetTop+"px",left:e.offsetLeft+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px",pointerEvents:"none"}),n&&n.appendChild(c)}let s=await fetch(e.src);if(!s.ok)throw new Error(`Failed to fetch image: ${s.status}`);let u=await R(await s.arrayBuffer());return{canvas:c,bytecode:u}}function G(e){return{get width(){return e.width},get height(){return e.height},get isPlaying(){return e.playing},get time(){return e.time},get frameCount(){return e.frameCount},_:e}}function X(e){let t=e._;return t&&(t.animationId&&cancelAnimationFrame(t.animationId),t.worker.postMessage({type:"destroy"}),t.worker.terminate(),e._=null,t.log("Destroyed")),e}export{X as destroy,D as detectFormat,_ as draw,R as extractBytecode,I as isPng,M as isPngb,S as isZip,v as pause,O as play,k as pngine,Y as seek,V as setFrame,W as stop};
