var I='var f={CREATE_BUFFER:1,CREATE_TEXTURE:2,CREATE_SAMPLER:3,CREATE_SHADER:4,CREATE_RENDER_PIPELINE:5,CREATE_COMPUTE_PIPELINE:6,CREATE_BIND_GROUP:7,CREATE_TEXTURE_VIEW:8,CREATE_QUERY_SET:9,CREATE_BIND_GROUP_LAYOUT:10,CREATE_IMAGE_BITMAP:11,CREATE_PIPELINE_LAYOUT:12,CREATE_RENDER_BUNDLE:13,BEGIN_RENDER_PASS:16,BEGIN_COMPUTE_PASS:17,SET_PIPELINE:18,SET_BIND_GROUP:19,SET_VERTEX_BUFFER:20,DRAW:21,DRAW_INDEXED:22,END_PASS:23,DISPATCH:24,SET_INDEX_BUFFER:25,EXECUTE_BUNDLES:26,WRITE_BUFFER:32,WRITE_TIME_UNIFORM:33,COPY_BUFFER_TO_BUFFER:34,COPY_TEXTURE_TO_TEXTURE:35,WRITE_BUFFER_FROM_WASM:36,COPY_EXTERNAL_IMAGE_TO_TEXTURE:37,INIT_WASM_MODULE:48,CALL_WASM_FUNC:49,CREATE_TYPED_ARRAY:64,FILL_RANDOM:65,FILL_EXPRESSION:66,FILL_CONSTANT:67,WRITE_BUFFER_FROM_ARRAY:68,SUBMIT:240,END:255},x={MAP_READ:1,MAP_WRITE:2,COPY_SRC:4,COPY_DST:8,INDEX:16,VERTEX:32,UNIFORM:64,STORAGE:128},D=class{constructor(r,t){this.device=r,this.context=t,this.memory=null,this.debug=!1,this.buffers=new Map,this.textures=new Map,this.textureViews=new Map,this.samplers=new Map,this.shaders=new Map,this.pipelines=new Map,this.bindGroups=new Map,this.bindGroupLayouts=new Map,this.pipelineLayouts=new Map,this.querySets=new Map,this.renderBundles=new Map,this.imageBitmaps=new Map,this.wasmModules=new Map,this.typedArrays=new Map,this.bindGroupDescriptors=new Map,this.textureDescriptors=new Map,this.encoder=null,this.pass=null,this.time=0,this.canvasWidth=0,this.canvasHeight=0}setDebug(r){this.debug=r}setMemory(r){this.memory=r}setTime(r){this.time=r}setCanvasSize(r,t){this.canvasWidth=r,this.canvasHeight=t}async execute(r){let t=new DataView(this.memory.buffer),e=t.getUint32(r,!0),s=t.getUint16(r+4,!0);this.debug&&console.log(`[GPU] Execute: ${s} commands, ${e} bytes`);let n=r+8,i=r+e;for(let a=0;a<s&&n<i;a++){let u=t.getUint8(n++);this.debug&&console.log(`[GPU] Cmd ${a}: 0x${u.toString(16)}`);let c=this._dispatch(u,t,n);c instanceof Promise?(n=await c,t=new DataView(this.memory.buffer)):n=c}}_dispatch(r,t,e){switch(r){case f.CREATE_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint8(e+6);return this._createBuffer(s,n,i),e+7}case f.CREATE_SHADER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createShader(s,n,i),e+10}case f.CREATE_RENDER_PIPELINE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createRenderPipeline(s,n,i),e+10}case f.CREATE_COMPUTE_PIPELINE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createComputePipeline(s,n,i),e+10}case f.CREATE_BIND_GROUP:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0);return this._createBindGroup(s,n,i,a),e+12}case f.CREATE_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createTexture(s,n,i),e+10}case f.CREATE_SAMPLER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createSampler(s,n,i),e+10}case f.CREATE_TEXTURE_VIEW:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0);return this._createTextureView(s,n,i,a),e+12}case f.CREATE_QUERY_SET:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createQuerySet(s,n,i),e+10}case f.CREATE_BIND_GROUP_LAYOUT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createBindGroupLayout(s,n,i),e+10}case f.CREATE_PIPELINE_LAYOUT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createPipelineLayout(s,n,i),e+10}case f.CREATE_RENDER_BUNDLE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createRenderBundle(s,n,i),e+10}case f.BEGIN_RENDER_PASS:{let s=t.getUint16(e,!0),n=t.getUint8(e+2),i=t.getUint8(e+3),a=t.getUint16(e+4,!0);return this._beginRenderPass(s,n,i,a),e+6}case f.BEGIN_COMPUTE_PASS:return this._beginComputePass(),e;case f.SET_PIPELINE:{let s=t.getUint16(e,!0);return this.pass?.setPipeline(this.pipelines.get(s)),e+2}case f.SET_BIND_GROUP:{let s=t.getUint8(e),n=t.getUint16(e+1,!0);return this.pass?.setBindGroup(s,this.bindGroups.get(n)),e+3}case f.SET_VERTEX_BUFFER:{let s=t.getUint8(e),n=t.getUint16(e+1,!0);return this.pass?.setVertexBuffer(s,this.buffers.get(n)),e+3}case f.SET_INDEX_BUFFER:{let s=t.getUint16(e,!0),i=t.getUint8(e+2)===1?"uint32":"uint16";return this.pass?.setIndexBuffer(this.buffers.get(s),i),e+3}case f.EXECUTE_BUNDLES:{let s=t.getUint8(e),n=[];for(let i=0;i<s;i++){let a=t.getUint16(e+1+i*2,!0),u=this.renderBundles.get(a);u&&n.push(u)}return this.pass?.executeBundles(n),e+1+s*2}case f.DRAW:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0),a=t.getUint32(e+12,!0);return this.debug&&console.log(`[GPU] draw(vtx=${s}, inst=${n}, firstVtx=${i}, firstInst=${a})`),this.pass?.draw(s,n,i,a),e+16}case f.DRAW_INDEXED:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0),a=t.getInt32(e+12,!0),u=t.getUint32(e+16,!0);return this.pass?.drawIndexed(s,n,i,a,u),e+20}case f.DISPATCH:{let s=t.getUint32(e,!0),n=t.getUint32(e+4,!0),i=t.getUint32(e+8,!0);return this.debug&&console.log(`[GPU] dispatch(${s}, ${n}, ${i})`),this.pass?.dispatchWorkgroups(s,n,i),e+12}case f.END_PASS:return this.pass?.end(),this.pass=null,e;case f.WRITE_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0);return this._writeBuffer(s,n,i,a),e+14}case f.WRITE_TIME_UNIFORM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0);return this._writeTimeUniform(s,n,i),e+8}case f.CREATE_IMAGE_BITMAP:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._createImageBitmap(s,n,i),e+10}case f.COPY_EXTERNAL_IMAGE_TO_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint8(e+4),a=t.getUint16(e+5,!0),u=t.getUint16(e+7,!0),c=e+9;return this._copyExternalImageToTexture(s,n,i,a,u).then(()=>c)}case f.COPY_BUFFER_TO_BUFFER:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0),a=t.getUint32(e+8,!0),u=t.getUint32(e+12,!0);return this._copyBufferToBuffer(s,n,i,a,u),e+16}case f.COPY_TEXTURE_TO_TEXTURE:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint16(e+4,!0),a=t.getUint16(e+6,!0);return this._copyTextureToTexture(s,n,i,a),e+8}case f.WRITE_BUFFER_FROM_WASM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint32(e+10,!0);return this._writeBufferFromWasm(s,n,i,a),e+14}case f.INIT_WASM_MODULE:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0);return this._initWasmModule(s,n,i),e+10}case f.CALL_WASM_FUNC:{let s=t.getUint16(e,!0),n=t.getUint16(e+2,!0),i=t.getUint32(e+4,!0),a=t.getUint32(e+8,!0),u=t.getUint32(e+12,!0),c=t.getUint32(e+16,!0);return this._callWasmFunc(s,n,i,a,u,c),e+20}case f.CREATE_TYPED_ARRAY:{let s=t.getUint16(e,!0),n=t.getUint8(e+2),i=t.getUint32(e+3,!0);return this._createTypedArray(s,n,i),e+7}case f.FILL_RANDOM:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0);return this._fillRandom(s,n,i,a,u),e+15}case f.FILL_EXPRESSION:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0),c=t.getUint16(e+15,!0);return this._fillExpression(s,n,i,a,u,c),e+17}case f.FILL_CONSTANT:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint32(e+6,!0),a=t.getUint8(e+10),u=t.getUint32(e+11,!0);return this._fillConstant(s,n,i,a,u),e+15}case f.WRITE_BUFFER_FROM_ARRAY:{let s=t.getUint16(e,!0),n=t.getUint32(e+2,!0),i=t.getUint16(e+6,!0);return this._writeBufferFromArray(s,n,i),e+8}case f.SUBMIT:return this.encoder&&(this.device.queue.submit([this.encoder.finish()]),this.encoder=null),e;case f.END:return e;default:return console.warn(`Unknown command: 0x${r.toString(16)}`),e}}_createBuffer(r,t,e){if(this.buffers.has(r))return;let s=this._translateUsage(e);this.buffers.set(r,this.device.createBuffer({size:t,usage:s}))}_translateUsage(r){let t=0;return r&x.MAP_READ&&(t|=GPUBufferUsage.MAP_READ),r&x.MAP_WRITE&&(t|=GPUBufferUsage.MAP_WRITE),r&x.COPY_SRC&&(t|=GPUBufferUsage.COPY_SRC),r&x.COPY_DST&&(t|=GPUBufferUsage.COPY_DST),r&x.INDEX&&(t|=GPUBufferUsage.INDEX),r&x.VERTEX&&(t|=GPUBufferUsage.VERTEX),r&x.UNIFORM&&(t|=GPUBufferUsage.UNIFORM),r&x.STORAGE&&(t|=GPUBufferUsage.STORAGE),t||GPUBufferUsage.COPY_DST}_createShader(r,t,e){if(this.shaders.has(r))return;let s=this._readString(t,e);this.shaders.set(r,this.device.createShaderModule({code:s}))}_createRenderPipeline(r,t,e){if(this.pipelines.has(r))return;let s=this._readString(t,e);if(!s||s.length===0){console.error(`[GPU] Empty pipeline descriptor for id=${r}, ptr=${t}, len=${e}`);return}let n=JSON.parse(s),i=this._buildRenderPipeline(n);this.pipelines.set(r,i),this.bindGroupLayouts.set(r,i.getBindGroupLayout(0))}_buildRenderPipeline(r){let t=navigator.gpu.getPreferredCanvasFormat();return this.device.createRenderPipeline({layout:"auto",vertex:{module:this.shaders.get(r.vertex?.shader??0),entryPoint:r.vertex?.entryPoint??"vs_main",buffers:r.vertex?.buffers??[]},fragment:{module:this.shaders.get(r.fragment?.shader??r.vertex?.shader??0),entryPoint:r.fragment?.entryPoint??"fs_main",targets:[{format:t}]},primitive:r.primitive??{topology:"triangle-list"},depthStencil:r.depthStencil})}_createComputePipeline(r,t,e){if(this.pipelines.has(r))return;let s=this._readString(t,e);if(!s||s.length===0){console.error(`[GPU] Empty compute pipeline descriptor for id=${r}, ptr=${t}, len=${e}`);return}let n=JSON.parse(s),i="auto";n.layout&&n.layout!=="auto"&&(i=this.pipelineLayouts.get(n.layout)??"auto");let a=this.device.createComputePipeline({layout:i,compute:{module:this.shaders.get(n.compute?.shader??0),entryPoint:n.compute?.entryPoint??"main"}});this.pipelines.set(r,a),i==="auto"&&this.bindGroupLayouts.set(r,a.getBindGroupLayout(0))}_createBindGroup(r,t,e,s){if(this.bindGroups.has(r))return;let n=new Uint8Array(this.memory.buffer,e,s),i=this._decodeBindGroupDescriptor(n);i.layoutId=t,this.bindGroupDescriptors.set(r,i);let a=this.pipelines.get(t);if(!a){console.error(`[GPU] Pipeline ${t} not found for bind group ${r}`);return}let u=i.entries.map(c=>{let d={binding:c.binding};if(c.resourceType===0){let l={buffer:this.buffers.get(c.resourceId)};c.offset&&(l.offset=c.offset),c.size&&(l.size=c.size),d.resource=l}else c.resourceType===1?d.resource=this.textures.get(c.resourceId)?.createView():c.resourceType===2&&(d.resource=this.samplers.get(c.resourceId));return d});this.bindGroups.set(r,this.device.createBindGroup({layout:a.getBindGroupLayout(i.groupIndex),entries:u}))}_decodeBindGroupDescriptor(r){let t=new DataView(r.buffer,r.byteOffset,r.byteLength),e=0,s=r[e++];if(s!==3)return console.error(`[GPU] Invalid bind group descriptor type tag: ${s}`),{groupIndex:0,entries:[]};let n=r[e++],i=0,a=[],u=1,c=2,d=3,l=7;for(let U=0;U<n;U++){let b=r[e++],_=r[e++];if(b===u&&_===l)i=r[e++];else if(b===c&&_===d){let F=r[e++];for(let B=0;B<F;B++){let p=r[e++],P=r[e++],m=t.getUint16(e,!0);e+=2;let M={binding:p,resourceType:P,resourceId:m};P===0&&(M.offset=t.getUint32(e,!0),e+=4,M.size=t.getUint32(e,!0),e+=4),a.push(M)}}}return{groupIndex:i,entries:a}}_createTexture(r,t,e){if(this.textures.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=this._decodeTextureDescriptor(s);this.textureDescriptors.set(r,{format:n.format,usage:n.usage}),this.textures.set(r,this.device.createTexture(n))}_createSampler(r,t,e){if(this.samplers.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=this._decodeSamplerDescriptor(s);this.samplers.set(r,this.device.createSampler(n))}_decodeTextureDescriptor(r){let t=new DataView(r.buffer,r.byteOffset,r.byteLength),e=0,s=r[e++];if(s!==1)return console.error(`[GPU] Invalid texture descriptor type tag: ${s}`),{size:[256,256],format:"rgba8unorm",usage:GPUTextureUsage.RENDER_ATTACHMENT};let n=r[e++],i={size:[this.canvasWidth||512,this.canvasHeight||512],format:navigator.gpu.getPreferredCanvasFormat(),usage:GPUTextureUsage.RENDER_ATTACHMENT,sampleCount:1},a=1,u=2,c=5,d=7,l=8,U=10,b=0,_=6,F=7;for(let B=0;B<n;B++){let p=r[e++],P=r[e++];if(P===b){let m=t.getUint32(e,!0);e+=4,p===a?i.size[0]=m:p===u?i.size[1]=m:p===c&&(i.sampleCount=m)}else if(P===_){let m=t.getUint16(e,!0);e+=2,p===U&&(i.size=[1,1],i.imageBitmapId=m)}else if(P===F){let m=r[e++];p===d?i.format=this._decodeTextureFormat(m):p===l&&(i.usage=this._decodeTextureUsage(m))}}return i}_decodeSamplerDescriptor(r){let t=0,e=r[t++];if(e!==2)return console.error(`[GPU] Invalid sampler descriptor type tag: ${e}`),{};let s=r[t++],n={magFilter:"linear",minFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},i=1,a=2,u=4,c=5,d=7;for(let l=0;l<s;l++){let U=r[t++];if(r[t++]===d){let _=r[t++];U===u?n.magFilter=_===0?"nearest":"linear":U===c?n.minFilter=_===0?"nearest":"linear":U===i?n.addressModeU=["clamp-to-edge","repeat","mirror-repeat"][_]||"clamp-to-edge":U===a&&(n.addressModeV=["clamp-to-edge","repeat","mirror-repeat"][_]||"clamp-to-edge")}}return n}_decodeTextureFormat(r){return{0:"rgba8unorm",1:"rgba8snorm",2:"rgba8uint",3:"rgba8sint",4:"bgra8unorm",5:"rgba16float",6:"rgba32float",16:"depth24plus",17:"depth24plus-stencil8",18:"depth32float"}[r]||navigator.gpu.getPreferredCanvasFormat()}_decodeTextureUsage(r){let t=0;return r&1&&(t|=GPUTextureUsage.COPY_SRC),r&2&&(t|=GPUTextureUsage.COPY_DST),r&4&&(t|=GPUTextureUsage.TEXTURE_BINDING),r&8&&(t|=GPUTextureUsage.STORAGE_BINDING),r&16&&(t|=GPUTextureUsage.RENDER_ATTACHMENT),t||GPUTextureUsage.RENDER_ATTACHMENT}_beginRenderPass(r,t,e,s){this.encoder||(this.encoder=this.device.createCommandEncoder());let c={colorAttachments:[{view:r===65534?this.context.getCurrentTexture().createView():this.textures.get(r)?.createView(),loadOp:t===1?"clear":"load",storeOp:e===0?"store":"discard",clearValue:{r:0,g:0,b:0,a:1}}]};if(s!==65535){let d=this.textures.get(s)?.createView();d&&(c.depthStencilAttachment={view:d,depthLoadOp:"clear",depthStoreOp:"store",depthClearValue:1})}this.pass=this.encoder.beginRenderPass(c)}_beginComputePass(){this.encoder||(this.encoder=this.device.createCommandEncoder()),this.pass=this.encoder.beginComputePass()}_writeBuffer(r,t,e,s){let n=this.buffers.get(r);if(!n)return;let i=new Uint8Array(this.memory.buffer,e,s);this.device.queue.writeBuffer(n,t,i)}_writeTimeUniform(r,t,e){let s=this.buffers.get(r);if(!s)return;let n=new Float32Array([this.time,this.canvasWidth,this.canvasHeight,this.canvasWidth/(this.canvasHeight||1)]),i=new Uint8Array(n.buffer,0,Math.min(e,16));this.device.queue.writeBuffer(s,t,i)}_readString(r,t){let e=new Uint8Array(this.memory.buffer,r,t);return new TextDecoder().decode(e)}_createImageBitmap(r,t,e){if(this.imageBitmaps.has(r))return;let s=new Uint8Array(this.memory.buffer,t,e),n=s[0],i=s.slice(1,1+n),a=new TextDecoder().decode(i),u=s.slice(1+n),c=new Blob([u],{type:a}),d=globalThis.createImageBitmap(c);this.imageBitmaps.set(r,d)}async _copyExternalImageToTexture(r,t,e,s,n){let i=this.imageBitmaps.get(r);if(!i){console.error(`[GPU] ImageBitmap ${r} not found`);return}i instanceof Promise&&(i=await i,this.imageBitmaps.set(r,i));let a=this.textures.get(t);if(!a){console.error(`[GPU] Texture ${t} not found`);return}if(a.width!==i.width||a.height!==i.height){a.destroy();let u=this.textureDescriptors.get(t)||{format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT};a=this.device.createTexture({size:[i.width,i.height],format:u.format,usage:u.usage}),this.textures.set(t,a),this._recreateBindGroupsForTexture(t)}this.device.queue.copyExternalImageToTexture({source:i},{texture:a,mipLevel:e,origin:{x:s,y:n}},{width:i.width,height:i.height})}_recreateBindGroupsForTexture(r){for(let[t,e]of this.bindGroupDescriptors.entries())e.entries.some(n=>n.resourceType===1&&n.resourceId===r)&&(this.bindGroups.delete(t),this._recreateBindGroup(t,e))}_recreateBindGroup(r,t){let e=this.pipelines.get(t.layoutId);if(!e)return;let s=t.entries.map(n=>{let i={binding:n.binding};if(n.resourceType===0){let a={buffer:this.buffers.get(n.resourceId)};n.offset&&(a.offset=n.offset),n.size&&(a.size=n.size),i.resource=a}else n.resourceType===1?i.resource=this.textures.get(n.resourceId)?.createView():n.resourceType===2&&(i.resource=this.samplers.get(n.resourceId));return i});this.bindGroups.set(r,this.device.createBindGroup({layout:e.getBindGroupLayout(t.groupIndex),entries:s}))}_createTextureView(r,t,e,s){if(this.textureViews.has(r))return;let n=this.textures.get(t);n&&this.textureViews.set(r,n.createView())}_createQuerySet(r,t,e){this.querySets.has(r)}_createBindGroupLayout(r,t,e){this.bindGroupLayouts.has(r)}_createPipelineLayout(r,t,e){this.pipelineLayouts.has(r)}_createRenderBundle(r,t,e){this.renderBundles.has(r)}_copyBufferToBuffer(r,t,e,s,n){let i=this.buffers.get(r),a=this.buffers.get(e);if(!i||!a)return;let u=this.encoder||this.device.createCommandEncoder();u.copyBufferToBuffer(i,t,a,s,n),this.encoder||this.device.queue.submit([u.finish()])}_copyTextureToTexture(r,t,e,s){let n=this.textures.get(r),i=this.textures.get(t);if(!n||!i)return;let a=this.encoder||this.device.createCommandEncoder();a.copyTextureToTexture({texture:n},{texture:i},{width:e,height:s}),this.encoder||this.device.queue.submit([a.finish()])}_writeBufferFromWasm(r,t,e,s){let n=this.buffers.get(r);if(!n)return;let i=new Uint8Array(this.memory.buffer,e,s);this.device.queue.writeBuffer(n,t,i)}_initWasmModule(r,t,e){}_callWasmFunc(r,t,e,s,n,i){}_createTypedArray(r,t,e){if(this.typedArrays.has(r))return;let n=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t]||Float32Array,i=new n(e);this.debug&&console.log(`[GPU] createTypedArray(id=${r}, type=${t}/${n.name}, size=${e}, byteLength=${i.byteLength})`),this.typedArrays.set(r,i)}_fillRandom(r,t,e,s,n){let i=this.typedArrays.get(r);if(!i){console.error(`[GPU] fillRandom: array ${r} not found`);return}let a=new Float32Array(this.memory.buffer,n,e);this.debug&&console.log(`[GPU] fillRandom(array=${r}, offset=${t}, count=${e}, stride=${s}, dataPtr=${n})`);for(let u=0;u<e;u++){let c=t+u*s;c<i.length&&(i[c]=a[u])}}_fillExpression(r,t,e,s,n,i){let a=this.typedArrays.get(r);if(!a){console.error(`[GPU] fillExpression: array ${r} not found`);return}let u=this._readString(n,i);if(this.debug&&console.log(`[GPU] fillExpression(array=${r}, offset=${t}, count=${e}, stride=${s}, expr="${u}")`),!!u)try{let c=u.replace(/NUM_PARTICLES/g,String(e)).replace(/PI/g,"Math.PI").replace(/random\\(\\)/g,"Math.random()").replace(/sin\\(/g,"Math.sin(").replace(/cos\\(/g,"Math.cos(").replace(/sqrt\\(/g,"Math.sqrt(").replace(/ceil\\(/g,"Math.ceil(").replace(/floor\\(/g,"Math.floor(").replace(/abs\\(/g,"Math.abs("),d=new Function("ELEMENT_ID",`return ${c};`);for(let l=0;l<e;l++){let U=l*s+t;a[U]=d(l)}}catch(c){console.error(`[GPU] Error evaluating expression "${u}":`,c)}}_fillConstant(r,t,e,s,n){let i=this.typedArrays.get(r);if(!i)return;let u=new Float32Array(this.memory.buffer,n,1)[0];for(let c=0;c<e;c++){let d=c*s+t;i[d]=u}}_writeBufferFromArray(r,t,e){let s=this.typedArrays.get(e),n=this.buffers.get(r);if(!s||!n){console.error(`[GPU] writeBufferFromArray: missing array ${e} or buffer ${r}`);return}if(this.debug){console.log(`[GPU] writeBufferFromArray(buffer=${r}, offset=${t}, array=${e}, type=${s.constructor.name}, byteLen=${s.byteLength})`);let i=s instanceof Float32Array?s:new Float32Array(s.buffer,s.byteOffset,Math.min(8,s.byteLength/4));console.log(`[GPU]   first values: [${Array.from(i.slice(0,8)).join(", ")}]`)}this.device.queue.writeBuffer(n,t,s)}destroy(){for(let r of this.buffers.values())r.destroy?.();for(let r of this.textures.values())r.destroy?.();for(let r of this.imageBitmaps.values())r instanceof ImageBitmap&&r.close?.();this.buffers.clear(),this.textures.clear(),this.textureViews.clear(),this.samplers.clear(),this.shaders.clear(),this.pipelines.clear(),this.bindGroups.clear(),this.bindGroupLayouts.clear(),this.pipelineLayouts.clear(),this.querySets.clear(),this.renderBundles.clear(),this.imageBitmaps.clear(),this.wasmModules.clear(),this.typedArrays.clear(),this.bindGroupDescriptors.clear(),this.textureDescriptors.clear()}};var y,A,C,h,g,T,L=!1,I=!1,S=0,E=()=>{},R={INIT:"init",DRAW:"draw",LOAD:"load",DESTROY:"destroy",READY:"ready",ERROR:"error"};onmessage=async o=>{let{type:r,...t}=o.data;try{switch(r){case R.INIT:await O(t);break;case R.DRAW:W(t);break;case R.LOAD:await $(t);break;case R.DESTROY:w();break;default:throw new Error(`Unknown message: ${r}`)}}catch(e){postMessage({type:R.ERROR,message:e.message})}};async function O(o){if(L)throw new Error("Already initialized");y=o.canvas,E=o.debug?console.log.bind(console,"[Worker]"):()=>{};let r=await navigator.gpu?.requestAdapter();if(!r)throw new Error("WebGPU not supported");A=await r.requestDevice(),C=y.getContext("webgpu");let t=navigator.gpu.getPreferredCanvasFormat();if(C.configure({device:A,format:t,alphaMode:"premultiplied"}),h=new D(A,C),h.setDebug(o.debug),h.setCanvasSize(y.width,y.height),!o.wasmUrl)throw new Error("wasmUrl required");let e=await fetch(o.wasmUrl);if(!e.ok)throw new Error(`Failed to fetch WASM: ${e.status}`);let{instance:s}=await WebAssembly.instantiateStreaming(e,X());g=s.exports,T=g.memory,h.setMemory(T),g.onInit(),L=!0,E("Initialized"),o.bytecode&&await G(o.bytecode),postMessage({type:R.READY,width:y.width,height:y.height,frameCount:S})}async function $(o){if(!L)throw new Error("Not initialized");await G(o.bytecode),postMessage({type:R.READY,frameCount:S})}async function G(o){if(I){let e=h.debug;g.freeModule(),h.destroy(),h=new D(A,C),h.setDebug(e),h.setMemory(T),h.setCanvasSize(y.width,y.height),I=!1}let r=g.alloc(o.byteLength);if(!r)throw new Error("Failed to allocate memory");new Uint8Array(T.buffer,r,o.byteLength).set(new Uint8Array(o));let t=g.loadModule(r,o.byteLength);if(g.free(r,o.byteLength),t!==0)throw new Error(`Load failed: ${t}`);I=!0,S=g.getFrameCount(),N(0,0),E(`Loaded module: ${S} frames`)}function W(o){!L||!I||(o.uniforms&&V(o.uniforms),N(o.time??0,0))}function V(o){let r=new TextEncoder;for(let[t,e]of Object.entries(o)){let s=r.encode(t),n=g.alloc(s.length);if(!n){E(`Failed to allocate memory for uniform name: ${t}`);continue}new Uint8Array(T.buffer,n,s.length).set(s);let i=Y(e);if(!i){g.free(n,s.length),E(`Unsupported uniform value type for: ${t}`);continue}let a=g.alloc(i.length);if(!a){g.free(n,s.length),E(`Failed to allocate memory for uniform value: ${t}`);continue}new Uint8Array(T.buffer,a,i.length).set(i);let u=g.setUniform(n,s.length,a,i.length);g.free(n,s.length),g.free(a,i.length),u!==0&&E(`setUniform(${t}) failed: ${["success","field not found","size mismatch","no module"][u]||`error ${u}`}`)}}function Y(o){if(typeof o=="number")return new Uint8Array(new Float32Array([o]).buffer);if(Array.isArray(o)){let r=o.flat(2);if(r.length===2||r.length===3||r.length===4||r.length===9||r.length===16)return new Uint8Array(new Float32Array(r).buffer)}return null}function N(o,r){h.setTime(o);let t=g.renderFrame(o,r);if(!t){E("renderFrame returned null");return}h.execute(t)}function w(){I&&(g.freeModule(),I=!1),h?.destroy(),A&&(A.destroy(),A=null),L=!1,E("Destroyed")}function X(){let o=()=>{};return{env:{gpuCreateBuffer:o,gpuCreateTexture:o,gpuCreateSampler:o,gpuCreateShaderModule:o,gpuCreateRenderPipeline:o,gpuCreateComputePipeline:o,gpuCreateBindGroup:o,gpuCreateImageBitmap:o,gpuCreateTextureView:o,gpuCreateQuerySet:o,gpuCreateBindGroupLayout:o,gpuCreatePipelineLayout:o,gpuCreateRenderBundle:o,gpuBeginRenderPass:o,gpuBeginComputePass:o,gpuSetPipeline:o,gpuSetBindGroup:o,gpuSetVertexBuffer:o,gpuSetIndexBuffer:o,gpuDraw:o,gpuDrawIndexed:o,gpuDispatch:o,gpuExecuteBundles:o,gpuEndPass:o,gpuWriteBuffer:(r,t,e,s)=>{let n=h?.buffers?.get(r);if(!n){E(`gpuWriteBuffer: buffer ${r} not found`);return}let i=new Uint8Array(T.buffer,e,s);A.queue.writeBuffer(n,t,i)},gpuSubmit:o,gpuCopyExternalImageToTexture:o,gpuInitWasmModule:o,gpuCallWasmFunc:o,gpuWriteBufferFromWasm:o,gpuCreateTypedArray:o,gpuFillRandomData:o,gpuFillExpression:o,gpuFillConstant:o,gpuWriteBufferFromArray:o,gpuWriteTimeUniform:o,gpuDebugLog:o,jsConsoleLog:(r,t)=>{let e=new TextDecoder().decode(new Uint8Array(T.buffer,r,t));E(e)},jsConsoleLogInt:(r,t,e)=>{let s=new TextDecoder().decode(new Uint8Array(T.buffer,r,t));E(s,e)}}}}\n';function b(){let e=new Blob([I],{type:"application/javascript"});return URL.createObjectURL(e)}var B=[137,80,78,71,13,10,26,10],y=[112,78,71,98],P=e=>e.length>=8&&B.every((t,i)=>e[i]===t),C=e=>e.length>=4&&e[0]===80&&e[1]===75&&(e[2]===3||e[2]===5),S=e=>e.length>=4&&e[0]===80&&e[1]===78&&e[2]===71&&e[3]===66;function D(e){return C(e)?"zip":P(e)?"png":S(e)?"pngb":null}async function R(e){let t=e instanceof Uint8Array?e:new Uint8Array(e),i=D(t);if(i==="pngb")return t;if(i==="png")return F(t);if(i==="zip")return M(t);throw new Error("Unknown format")}async function F(e){if(!P(e))throw new Error("Invalid PNG");let t=8;for(;t+12<=e.length;){let i=L(e,t),r=e.subarray(t+4,t+8);if(r[0]===y[0]&&r[1]===y[1]&&r[2]===y[2]&&r[3]===y[3]){let n=e.subarray(t+8,t+8+i);return G(n)}t+=12+i}throw new Error("No pNGb chunk found")}async function G(e){if(e.length<2)throw new Error("Invalid pNGb chunk");let t=e[0],i=e[1],r=e.subarray(2);if(t!==1)throw new Error(`Unsupported pNGb version: ${t}`);return i&1?x(r):new Uint8Array(r)}async function M(e){let t=-1;for(let a=22;a<=Math.min(e.length,65557);a++){let u=e.length-a;if(f(e,u)===101010256){t=u;break}}if(t===-1)throw new Error("Invalid ZIP");let i=c(e,t+10),r=f(e,t+16),n=null,l=null;for(let a=0;a<i&&f(e,r)===33639248;a++){let u=c(e,r+10),s=f(e,r+20),o=f(e,r+24),d=c(e,r+28),p=c(e,r+30),g=c(e,r+32),_=f(e,r+42),m=new TextDecoder().decode(e.subarray(r+46,r+46+d)),U=c(e,_+28),w=_+30+d+U,E={name:m,compression:u,compSize:s,uncompSize:o,dataOff:w};m==="manifest.json"?n=E:m.endsWith(".pngb")&&!l&&(l=E),r+=46+d+p+g}if(n){let a=JSON.parse(new TextDecoder().decode(await T(e,n)));if(a.entry){r=f(e,t+16);for(let u=0;u<i&&f(e,r)===33639248;u++){let s=c(e,r+28);if(new TextDecoder().decode(e.subarray(r+46,r+46+s))===a.entry){let d=c(e,r+10),p=f(e,r+20),g=f(e,r+24),_=c(e,r+30),m=c(e,r+32),U=f(e,r+42),w=c(e,U+28),E=U+30+s+w;return T(e,{compression:d,compSize:p,uncompSize:g,dataOff:E})}r+=46+s+c(e,r+30)+c(e,r+32)}}}if(l)return T(e,l);throw new Error("No bytecode found in ZIP")}async function T(e,t){let i=e.subarray(t.dataOff,t.dataOff+t.compSize);if(t.compression===0)return new Uint8Array(i);if(t.compression===8)return x(i);throw new Error(`Unsupported compression: ${t.compression}`)}async function x(e){let t=new DecompressionStream("deflate-raw"),i=t.writable.getWriter(),r=t.readable.getReader();i.write(e),i.close();let n=[],l=0;for(;;){let{done:s,value:o}=await r.read();if(s)break;n.push(o),l+=o.length}let a=new Uint8Array(l),u=0;for(let s of n)a.set(s,u),u+=s.length;return a}var c=(e,t)=>e[t]|e[t+1]<<8,f=(e,t)=>(e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24)>>>0,L=(e,t)=>(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0;function h(e,t={}){let i=e._;if(!i)throw new Error("Pngine destroyed");if(!i.ready)throw new Error("Not initialized");i.worker.postMessage({type:"draw",time:t.time??i.time,frame:t.frame??null,uniforms:t.uniforms??null}),t.time!==void 0&&(i.time=t.time)}function O(e){let t=e._;if(!t||t.playing)return e;t.playing=!0,t.startTime=performance.now()-t.time*1e3;let i=()=>{if(!t.playing)return;let r=performance.now();t.time=(r-t.startTime)/1e3,h(e,{time:t.time}),t.animationId=requestAnimationFrame(i)};return t.animationId=requestAnimationFrame(i),t.log?.("Playing"),e}function v(e){let t=e._;return!t||!t.playing||(t.playing=!1,t.time=(performance.now()-t.startTime)/1e3,t.animationId&&(cancelAnimationFrame(t.animationId),t.animationId=null),t.log?.("Paused")),e}function $(e){v(e);let t=e._;return t&&(t.time=0,t.startTime=performance.now(),h(e,{time:0}),t.log?.("Stopped")),e}function W(e,t){let i=e._;return i&&(i.time=t,i.playing&&(i.startTime=performance.now()-t*1e3),h(e,{time:t})),e}function Y(e,t){let i=e._;return i&&(i.currentFrame=t,h(e,{time:i.time,frame:t})),e}function k(e,t,i,r=!0){let n=e._;return n&&(n.uniforms||(n.uniforms={}),n.uniforms[t]=i,r&&h(e,{time:n.time,uniforms:{[t]:i}})),e}function V(e,t,i=!0){let r=e._;return r&&(r.uniforms||(r.uniforms={}),Object.assign(r.uniforms,t),i&&h(e,{time:r.time,uniforms:t})),e}async function X(e,t={}){let i=t.debug?console.log.bind(console,"[PNGine]"):()=>{},r,n;if(typeof e=="string")if(e.startsWith("#")||e.startsWith(".")&&!e.startsWith("./")&&!e.startsWith("..")){let o=document.querySelector(e);if(!o)throw new Error(`Element not found: ${e}`);if(o instanceof HTMLImageElement)({canvas:r,bytecode:n}=await A(o,t,i));else throw o instanceof HTMLCanvasElement?(r=o,new Error("Canvas source requires URL or data")):new Error("Invalid element type")}else{if(r=t.canvas,!r)throw new Error("Canvas required for URL source");i(`Fetching: ${e}`);let o=await fetch(e);if(!o.ok)throw new Error(`Fetch failed: ${o.status}`);n=await R(await o.arrayBuffer())}else if(e instanceof HTMLImageElement)({canvas:r,bytecode:n}=await A(e,t,i));else if(e instanceof ArrayBuffer||e instanceof Uint8Array||e instanceof Blob){if(r=t.canvas,!r)throw new Error("Canvas required for data source");let s=e instanceof Blob?await e.arrayBuffer():e;n=await R(s)}else throw new Error("Invalid source type");i(`Canvas: ${r.width}x${r.height}`),i(`Bytecode: ${n.byteLength} bytes`);let l=r.transferControlToOffscreen(),a=new Worker(b()),u=await new Promise((s,o)=>{let d=setTimeout(()=>o(new Error("Worker init timeout")),15e3);a.onmessage=g=>{g.data.type==="ready"?(clearTimeout(d),s(g.data)):g.data.type==="error"&&(clearTimeout(d),o(new Error(g.data.message)))},a.onerror=g=>{clearTimeout(d),o(new Error(g.message||"Worker error"))};let p=t.wasmUrl?new URL(t.wasmUrl,window.location.href).href:new URL("pngine.wasm",import.meta.url).href;a.postMessage({type:"init",canvas:l,bytecode:n,wasmUrl:p,debug:t.debug||!1},[l,n.buffer])});return a.onmessage=s=>{s.data.type==="error"&&t.onError&&t.onError(new Error(s.data.message))},i(`Ready: ${u.frameCount} frames`),N({canvas:r,worker:a,width:u.width,height:u.height,frameCount:u.frameCount,ready:!0,playing:!1,time:0,startTime:0,animationId:null,debug:t.debug||!1,log:i})}async function A(e,t,i){e.complete||await new Promise((s,o)=>{e.onload=s,e.onerror=o});let{naturalWidth:r,naturalHeight:n}=e;if(r===0||n===0)throw new Error("Image has no dimensions");i(`Image: ${r}x${n} from ${e.src}`);let l=t.canvas||document.createElement("canvas");if(l.width=r,l.height=n,!t.canvas){let s=e.parentElement;s&&getComputedStyle(s).position==="static"&&(s.style.position="relative"),Object.assign(l.style,{position:"absolute",top:e.offsetTop+"px",left:e.offsetLeft+"px",width:e.offsetWidth+"px",height:e.offsetHeight+"px",pointerEvents:"none"}),s&&s.appendChild(l)}let a=await fetch(e.src);if(!a.ok)throw new Error(`Failed to fetch image: ${a.status}`);let u=await R(await a.arrayBuffer());return{canvas:l,bytecode:u}}function N(e){return{get width(){return e.width},get height(){return e.height},get isPlaying(){return e.playing},get time(){return e.time},get frameCount(){return e.frameCount},_:e}}function z(e){let t=e._;return t&&(t.animationId&&cancelAnimationFrame(t.animationId),t.worker.postMessage({type:"destroy"}),t.worker.terminate(),e._=null,t.log("Destroyed")),e}export{z as destroy,D as detectFormat,h as draw,R as extractBytecode,P as isPng,S as isPngb,C as isZip,v as pause,O as play,X as pngine,W as seek,Y as setFrame,k as setUniform,V as setUniforms,$ as stop};
