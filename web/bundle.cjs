#!/usr/bin/env node

/**
 * Bundle script for new PNGine API.
 *
 * Creates a single browser bundle with inline worker.
 */

const fs = require("fs");
const path = require("path");

const WEB_DIR = __dirname;
const DIST_DIR = path.join(WEB_DIR, "dist");

// Ensure dist directory exists
if (!fs.existsSync(DIST_DIR)) {
  fs.mkdirSync(DIST_DIR, { recursive: true });
}

function read(name) {
  return fs.readFileSync(path.join(WEB_DIR, name), "utf-8");
}

function write(name, content) {
  fs.writeFileSync(path.join(DIST_DIR, name), content);
  const kb = (content.length / 1024).toFixed(1);
  console.log(`  ${name}: ${kb}KB`);
}

/**
 * Remove import statements
 */
function removeImports(code) {
  return code.replace(/^import\s+.*?from\s+['"].*?['"];?\s*$/gm, "");
}

/**
 * Remove export keywords but keep declarations
 */
function removeExports(code) {
  code = code.replace(/^export\s+(const|let|var|function|class|async\s+function)/gm, "$1");
  code = code.replace(/^export\s+default\s+/gm, "");
  code = code.replace(/^export\s+\{[^}]*\};?\s*$/gm, "");
  return code;
}

/**
 * Remove workerUrl-related code (will be provided by bundle)
 */
function removeWorkerUrl(code) {
  // Remove workerUrl declaration
  code = code.replace(/^let workerUrl\s*=\s*null;\s*$/gm, "// workerUrl provided by bundle");
  // Remove getWorkerUrl function
  code = code.replace(/^function getWorkerUrl\(\)\s*\{[\s\S]*?^\}/gm, "// getWorkerUrl provided by bundle");
  // Remove setWorkerUrl export
  code = code.replace(/^function setWorkerUrl[\s\S]*?^\}/gm, "// setWorkerUrl removed");
  return code;
}

console.log("Bundling PNGine (new API)...\n");

// Worker dependencies (order matters)
const workerFiles = [
  "pngine-gpu.js", // GPU backend (existing, required by _worker.js)
  "_worker.js",
];

// Main thread files
const mainFiles = [
  "_extract.js",
  "_init.js",
  "_anim.js",
];

// Bundle worker code
console.log("Worker bundle:");
const workerCode = workerFiles.map((f) => {
  const code = removeImports(removeExports(read(f)));
  console.log(`  + ${f}`);
  return `// === ${f} ===\n${code}`;
}).join("\n\n");

// Bundle main thread code
console.log("\nMain bundle:");
const mainCode = mainFiles.map((f) => {
  let code = removeImports(removeExports(read(f)));
  if (f === "_init.js") {
    code = removeWorkerUrl(code);
  }
  console.log(`  + ${f}`);
  return `// === ${f} ===\n${code}`;
}).join("\n\n");

// Create browser.mjs
const browserBundle = `
// PNGine - Browser Bundle
// Generated by bundle.js

// Worker code (inlined)
const WORKER_CODE = ${JSON.stringify(workerCode)};

function createWorkerUrl() {
  const blob = new Blob([WORKER_CODE], { type: "application/javascript" });
  return URL.createObjectURL(blob);
}

// Override getWorkerUrl in _init.js
let workerUrl = null;
function getWorkerUrl() {
  if (!workerUrl) workerUrl = createWorkerUrl();
  return workerUrl;
}

${mainCode}

// Public exports
export { pngine, destroy };
export { draw, play, pause, stop, seek, setFrame };
export { extractBytecode, detectFormat, isPng, isZip, isPngb };
`;

console.log("\nOutput:");
write("pngine.mjs", browserBundle);

// Create minified placeholder (actual minification would use esbuild)
console.log(`
Done! Use esbuild for production:
  npx esbuild web/dist/pngine.mjs --bundle --minify --format=esm --outfile=web/dist/pngine.min.js
`);
